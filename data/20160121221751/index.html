<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8"><title>応用機能の実装</title><meta content="authenticity_token" name="csrf-param">
<meta content="Y2UzkG5GQl5jzIBq3nOdxAEomQen5uuix05BO4pPfYw=" name="csrf-token"><link href="favicon.ico" rel="icon" sizes="16x16 32x32 48x48 128x128 256x256">
<link rel="stylesheet" type="text/css" href="index.css" media="all">
</head>
<body class="ng-scope" ng-app="techMaster"><div class="navbar main_header navbar-fixed-top navbar-default" role="navigation"><div class="container"><div class="navbar-header"><button aria-controls="navbar" aria-expanded="false" class="navbar-toggle collapsed" data-target="#navbar" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="http://master.tech-camp.in/" target="_self"><img src="logo.png"></a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav navbar-right"><li class="text">終了まであと<i class="limit_time">10</i>日</li><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" id="profileDropdown" style="padding: 10px 7px; cursor: pointer;"><img class="nav-proimg" src="noimage.png">大宅 誠人</a><ul class="dropdown-menu" id="profileDropdown"><li><a class="mypage-link" href="http://master.tech-camp.in/users/mypage" target="_self">マイページを見る</a></li><li><a href="http://master.tech-camp.in/users" target="_self">十三期生一覧</a></li></ul></li></ul></div></div></div><div class=""></div><!-- ngView:  --><div class="ng-scope" ng-view=""><curriculum style="display: inline;" class="ng-scope">
  <div class="container" id="curriculum">
    <div class="row curriculum-inner">
      <div class="col-lg-12 main" ng-init="init()">
        <div ng-show="curriculum.image" class="page-header page" style="background-image: url('main_visual.png');">
  <h1 class="ng-binding">
    Railsアプリケーション開発2 第4章<small class="ng-binding">〜応用機能の実装〜</small>
  </h1>
  <!-- ngIf: curriculum.image.description.length --><div style="" class="flickr_attr ng-binding ng-scope" ng-if="curriculum.image.description.length">
    ノートルダム大聖堂。1789年のフランス革命の影響により他の教会同様ノートルダム大聖堂も襲撃を受け破壊活動、略奪が繰り返されていました。しかし、1831年のヴィクトル・ユーゴーの小説『ノートルダム・ド・パリ』の舞台になったことがきっかけに国民全体に大聖堂復興運動の意義を訴えることになり政府から全体的補修が決定されたそうです。<a class="ng-binding" href="https://www.flickr.com/photos/mathieu_distefano/7112553961/" target="_top">Selden Vestrit - Cathédrale Notre-Dame de Paris</a>
  </div><!-- end ngIf: curriculum.image.description.length -->
</div>
      </div>
      <div class="col-md-9 col-sm-12" id="curriculumMainContainer">
        <div class="curriculum_content">
          <div class="curriculum_text ng-scope" compile-progress-notifier="willCompiledCurriculumText" ng-controller="CurriculumHintController"><h1 id="1" class="ng-scope">学習目標</h1>

<p class="ng-scope">応用的な課題を解きながら、映画レビューサイトをさらに複雑なアプリケーションにしていきましょう。</p>

<h1 id="2" class="ng-scope">学習課題</h1>

<p class="ng-scope">ひと通り動くレビューサイトが出来たと思います。<br>
この章はこのレビューサイトに機能を増やして、よりアプリケーションとしてのクオリティを上げていきます。</p>

<p class="ng-scope">この章では少し応用的な課題が出てくるので、わからないときは調べながら進めていきましょう。</p>

<h1 id="3" class="ng-scope">STEP0：作業の準備をしよう</h1>

<p class="ng-scope">本章では新しくビューを追加するので、そのためのHTMLやCSSファイルが必要となります。本セクションでは、本格的に学習に入る前にこれらの必要なファイルの準備を行います。</p>

<h2 id="4" class="ng-scope">ファイルをダウンロードしよう</h2>

<p class="ng-scope">以下のリンクから新しいHTML、CSSファイルの入っているzipファイルをダウンロードしましょう。</p>

<p class="ng-scope"><a href="http://master.tech-camp.in/filedownload/12" target="_top">rails2-4.zip</a></p>

<p class="ng-scope">zipファイルを解凍し、以下のようになっていることを確認してください。</p>

<ul class="filetree ng-scope">
  <li class="t-folder"> rails2-4
    <ul>
      <li class="t-file"> application.html.erb</li>
      <li class="t-file"> review_site.scss</li>
      <li class="t-folder"> users
        <ul>
          <li class="t-file"> show.html.erb</li>
          <li class="t-folder"> registrations
            <ul>
            <li class="t-file"> new.html.erb</li>
            </ul>
          </li>
          <li class="t-folder"> sessions
            <ul>
            <li class="t-file"> new.html.erb</li>
            </ul>
          </li>
        </ul>
    </li>
</ul>
  </li>
</ul>

<p class="ng-scope">zipファイルを解凍できない場合はメンターにお知らせください。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="404" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-552" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-552" name="check-552" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">rails2-4フォルダをダウンロードできた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="5" class="ng-scope">指定のファイルを置き換えよう</h2>

<p class="ng-scope">上記のrails2-4フォルダの中の、以下の2つのファイルを置き換えます。</p>

<ul class="ng-scope">
<li>review_site.scss</li>
<li>application.html.erb</li>
</ul>

<h3 class="ng-scope">
<i class="icon pen"></i> ダウンロードした「review_site.scss」を下記のディレクトリに配置しましょう</h3>

<ul class="filetree ng-scope">
  <li class="t-folder"> app
    <ul>
      <li class="t-folder"> assets
        <ul>
          <li class="t-folder"> stylesheets
            <ul>
              <li class="t-file"> <strong>review_site.scss</strong> </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope"><img src="58dfbdc3fe113eb1d2dc89bd13a3fd98.png" alt="ファイル配置"></p>

<h3 class="ng-scope">
<i class="icon pen"></i> ダウンロードした「application.html.erb」を下記のディレクトリに配置しましょう</h3>

<ul class="filetree ng-scope">
  <li class="t-folder"> app
    <ul>
      <li class="t-folder"> views
        <ul>
          <li class="t-folder"> layouts
            <ul>
              <li class="t-file"> <strong>application.html.erb</strong>
</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope"><img src="688836084f0404f965fe878099e7981c.png" alt="ファイル配置"></p>

<p class="ng-scope"><i class="icon attention"></i> ダウンロードしたフォルダに入っていた残りのファイルはこのあと使うので、どこかに保存しておきましょう。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="405" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-553" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-553" name="check-553" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text"><strong>review＿site.scss</strong>と<strong>application.html.erb</strong>を置き換えることが出来た</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 id="6" class="ng-scope">STEP1：レビューの評価を星として表示させよう</h1>

<p class="ng-scope">現在、レビューの評価がどこにも表示されていません。moooviでは<strong>レビューの評価を星として表示</strong>します。</p>

<p class="ng-scope">レビューの評価を表示させる画面は<strong>トップページ</strong>と<strong>作品ページ</strong>の2つです。</p>

<ul class="ng-scope">
<li>トップページ</li>
</ul>

<p class="ng-scope"><img src="18.png" alt="レビュー1"></p>

<ul class="ng-scope">
<li>作品ページ</li>
</ul>

<p class="ng-scope"><img src="19.png" alt="レビュー2"></p>

<p class="ng-scope">これを以下のように星で評価を表示できるようにしましょう。</p>

<p class="ng-scope"><img src="13.png" alt="レビュー"></p>

<p class="ng-scope">星の数はそれぞれ画像が用意されており、以下のようにして表示することができます。<br>
トップページであるindex.html.erb、作品ページであるshow.html.erbを確認しましょう。</p>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">index.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td>
<td class="code">
<div class="highlight"><pre>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"yjGuid"</span><span class="nt">&gt;&lt;a</span> <span class="na">id=</span><span class="s">"yjContentsStart"</span> <span class="na">name=</span><span class="s">"yjContentsStart"</span><span class="nt">&gt;&lt;/a&gt;&lt;img</span> <span class="na">alt=</span><span class="s">"ここから本文です"</span> <span class="na">height=</span><span class="s">"1"</span> <span class="na">src=</span><span class="s">"http://i.yimg.jp/yui/jp/tmpl/1.1.0/audionav.gif"</span> <span class="na">width=</span><span class="s">"1"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjMain"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">"section"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"header header--section"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"text-middle"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-movie color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>新着作品
                <span class="nt">&lt;/h2&gt;</span>
              <span class="nt">&lt;/header&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"thumbnails thumbnail--movies row grid4 js-lazy-load-images js-my-check-stats"</span> <span class="na">id=</span><span class="s">"list-module"</span><span class="nt">&gt;</span>
                <span class="err">&lt;</span>% @products.each do |product| %&gt;
                  <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"col"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/products/&lt;%= product.id %&gt;"</span><span class="nt">&gt;&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__figure"</span> <span class="na">style=</span><span class="s">"background-image:url(&lt;%= product.image_url %&gt;)"</span><span class="nt">&gt;&lt;/div&gt;&lt;/a&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__caption"</span><span class="nt">&gt;</span>
                      <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"text-xsmall text-overflow"</span> <span class="na">title=</span><span class="s">"&lt;%= product.title %&gt;"</span><span class="nt">&gt;</span>
                        <span class="err">&lt;</span>%= product.title %&gt;
                      <span class="nt">&lt;/h3&gt;</span>
                      <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-small"</span><span class="nt">&gt;</span>
<span class="hll">                        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"rating-star"</span><span class="nt">&gt;</span>
</span><span class="hll">                          <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"star-actived rate-[ここに評価を表示]0"</span><span class="nt">&gt;&lt;/i&gt;</span>
</span><span class="hll">                        <span class="nt">&lt;/span&gt;</span>
</span>                      <span class="nt">&lt;/p&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                  <span class="nt">&lt;/li&gt;</span>
                <span class="err">&lt;</span>% end %&gt;
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/article&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjSub"</span><span class="nt">&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">星の数は<strong>i要素のクラスのrate-[ここに評価を表示]0</strong>と対応しています。[ここに評価を表示]には評価の数字（1~10）が入ります。各評価の星の数は以下の通りです。</p>

<table class="ng-scope">
<thead>
<tr>
<th style="text-align: center;">クラス名</th>
<th style="text-align: center;">星の数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">rate-10</td>
<td style="text-align: center;"><img src="03.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center;">rate-20</td>
<td style="text-align: center;"><img src="04.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center;">rate-30</td>
<td style="text-align: center;"><img src="05.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center;">rate-40</td>
<td style="text-align: center;"><img src="06.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center;">rate-50</td>
<td style="text-align: center;"><img src="07.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center;">rate-60</td>
<td style="text-align: center;"><img src="08.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center;">rate-70</td>
<td style="text-align: center;"><img src="09.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center;">rate-80</td>
<td style="text-align: center;"><img src="10.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center;">rate-90</td>
<td style="text-align: center;"><img src="11.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center;">rate-100</td>
<td style="text-align: center;"><img src="12.png" alt=""></td>
</tr>
</tbody>
</table>

<p class="ng-scope">それぞれのhtml.erbファイルにおいて、<code>rate-[ここに評価を表示]0</code>の[ここに評価を表示]に評価の数値が入るようにしていきます。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">１．個別の作品ページでレビューの星を表示する</h5>

<h5 class="ng-scope">２．映画一覧ページでそれぞれの映画の平均評価を取得する</h5>

<h5 class="ng-scope">３．product.rbにインスタンスメソッドを定義する</h5>

<h2 id="7" class="ng-scope">１．個別の作品ページでレビューの星を表示する</h2>

<p class="ng-scope">作品ページでは、アソシエーションを用いることでコントローラーで定義している<code>@product</code>から関連するreviewsテーブルのレコードを全て取得しています。reviewsテーブルのレコードは、評価の数値が入るカラム、<code>rate</code>カラムを持っているので、それをそのまま取得し、先ほどの例の<code>[ここに評価を表示]</code>の部分で利用すれば良いでしょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/views/products/show.html.erbを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">show.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"yjGuid"</span><span class="nt">&gt;&lt;a</span> <span class="na">id=</span><span class="s">"yjContentsStart"</span> <span class="na">name=</span><span class="s">"yjContentsStart"</span><span class="nt">&gt;&lt;/a&gt;&lt;img</span> <span class="na">alt=</span><span class="s">"ここから本文です"</span> <span class="na">height=</span><span class="s">"1"</span> <span class="na">src=</span><span class="s">"http://i.yimg.jp/yui/jp/tmpl/1.1.0/audionav.gif"</span> <span class="na">width=</span><span class="s">"1"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjMain"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">"section"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"header header--section"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"text-middle"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-movie color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span><span class="err">&lt;</span>%= @product.title %&gt;
                <span class="nt">&lt;/h2&gt;</span>
              <span class="nt">&lt;/header&gt;</span>
              <span class="nt">&lt;p</span> <span class="na">style=</span><span class="s">"text-align: center"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"&lt;%= @product.image_url %&gt;"</span> <span class="na">alt=</span><span class="s">"&lt;%= @product.title %&gt;"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;/p&gt;</span>
              <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"text-align: right"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/products/&lt;%= @product.id %&gt;/reviews/new"</span><span class="nt">&gt;</span>この作品を投稿する<span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;/div&gt;</span>
              <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"header header--section"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"text-middle"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-movie color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>みんなのレビュー
                <span class="nt">&lt;/h2&gt;</span>
              <span class="nt">&lt;/header&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">style=</span><span class="s">"padding: 0"</span><span class="nt">&gt;</span>
                <span class="err">&lt;</span>% @product.reviews.each do |review| %&gt;
                <span class="nt">&lt;li</span> <span class="na">style=</span><span class="s">"border-bottom: dotted 1px"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__caption"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"text-xsmall text-overflow"</span> <span class="na">title=</span><span class="s">"&lt;%= review.nickname %&gt;"</span><span class="nt">&gt;</span>
                      <span class="err">&lt;</span>%= review.nickname %&gt;
                    <span class="nt">&lt;/h3&gt;</span>
                    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-small"</span><span class="nt">&gt;</span>
<span class="hll">                      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"rating-star"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"star-actived rate-&lt;%= review.rate %&gt;0"</span><span class="nt">&gt;&lt;/i&gt;&lt;/span&gt;</span>
</span>                    <span class="nt">&lt;/p&gt;</span>
                    <span class="nt">&lt;p&gt;</span>
                      <span class="err">&lt;</span>%= review.review %&gt;
                    <span class="nt">&lt;/p&gt;</span>
                  <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
                <span class="err">&lt;</span>% end %&gt;
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/article&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjSub"</span><span class="nt">&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">作品詳細ページで、星がきちんと表示されていることを確認しましょう。</p>

<p class="ng-scope"><img src="b102aef6d5e7bd258d36501bb09117e6.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//b102aef6d5e7bd258d36501bb09117e6.png"></p>

<h2 id="8" class="ng-scope">２．映画一覧ページでそれぞれの映画の平均評価を取得する</h2>

<p class="ng-scope">トップページに表示されている作品については、<strong>その作品についたレビュー全ての評価の平均</strong>を表示しましょう。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_402"></i> ActiveRecord Relationクラス</h3>

<p class="ng-scope">whereメソッドやアソシエーションを利用してDBから複数のレコードをインスタンスとして取得した場合、取得した配列はActiveRecord Relationクラスに属します。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">all</span>
  <span class="n">products</span><span class="o">.</span><span class="n">class</span> <span class="c1">#=&gt; ActiveRecord::Relation::ActiveRecord_Relation_Product</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">※<code>class</code>メソッドを利用すると、利用したインスタンスが属するクラスを知ることができます。(インスタンス・メソッド/クラス・メソッドの区分で言うクラス・メソッドではありません。<code>class</code>というメソッドです。)</p>

<p class="ng-scope">ActiveRecord Relationクラスには、whereを始めとして複数のメソッドが準備されているため、続けてメソッドを実行することができます。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre>   <span class="c1">#productsテーブルから最新の投稿を5件取得する</span>
  <span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s2">"id DESC"</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">これは、複数のレコードのインスタンスが格納されている配列のようなものです。なので、配列クラスのメソッドを利用することができます。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="c1">#productsテーブルから最新の投稿を5件取得する</span>
  <span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s2">"id DESC"</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
  <span class="c1">#productのtitleカラムの値を出力する処理を、eachメソッドで行う</span>
  <span class="n">products</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="n">product</span><span class="o">.</span><span class="n">title</span>
  <span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">なお、<code>where</code>メソッドやアソシエーションで、DBに当てはまるレコードが存在しない場合、<em>返り値は空の配列になります。</em></p>

<h3 class="ng-scope">
<i class="icon information" id="term_403"></i> averageメソッド</h3>

<p class="ng-scope">averageメソッドは、ActiveRecord_Relationクラスのメソッドです。averageメソッドは、averageメソッドを利用するインスタンス取得先のテーブルのカラムをシンボル型で引数にとります。その値の平均を、小数点ありの状態で返してくれます。<br>
例えば、生徒の得点を記録する<code>score</code>カラムを持った<code>students</code>テーブルと関連するStudentクラスがあったとします。scoreカラムの平均を求めるには、以下のようにします。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">users</span> <span class="o">=</span> <span class="no">Student</span><span class="o">.</span><span class="n">all</span>
  <span class="n">users</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="ss">:score</span><span class="p">)</span>
  <span class="c1">#=&gt; 小数点まで含んだ平均点</span>
</pre></div>
</td>
</tr></tbody></table></div>

<h3 class="ng-scope">
<i class="icon information" id="term_404"></i> roundメソッド</h3>

<p class="ng-scope">小数点ありの数字クラスのインスタンスが利用できます。利用した数字の小数点以下を四捨五入します。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="mi">10</span><span class="o">.</span><span class="mi">4</span><span class="o">.</span><span class="n">round</span>
  <span class="c1">#=&gt; 10</span>

  <span class="mi">10</span><span class="o">.</span><span class="mi">5</span><span class="o">.</span><span class="n">round</span>
  <span class="c1">#=&gt; 11</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">例えばトップページのビュー(index.html.erb)で以下のようにすると、各作品についてレビューの個数を取得することができますね。</p>

<div class="code-frame ng-scope" data-lang="rhtml"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="cp">&lt;%</span> <span class="vi">@products</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
  #（中略）
    <span class="cp">&lt;%=</span> <span class="n">product</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
  #（中略）
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">1.で作業した内容と似ていますが、今回eachメソッドを利用しているのは作品の配列です。作品の平均評価は、作品のインスタンスから直接取得することはできません。では、全ての評価の平均を表示するにはどうすれば良いでしょうか。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題1：トップページで各作品の平均評価点を出しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：<br>app/views/products/index.html.erb</h5>
    <h5>ヒント①：まずはプロダクトに関するレビュー全てを取得し、その後評価の平均を求めます</h5>
    <h5>ヒント②：プロダクトに関するレビューがない場合を想定し、if文を用いて星を出す部分のクラス名が「rate-0」となっているビューに分岐する処理をします。そのために、配列の中身が空か判定しtrue/falseを返すメソッド present? を利用しましょう</h5>
    【例】
     <div class="code-frame" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre>    <span class="n">ary</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="n">ary</span><span class="o">.</span><span class="n">present?</span> <span class="c1">#=&gt; false</span>
</pre></div>
</td>
</tr></tbody></table></div>
    <curriculum-question-container class="ng-scope" data-order="1"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">作品一覧ページで星がきちんと表示されていることを確認しましょう。</p>

<p class="ng-scope"><img src="763155476af1438c0dd876c08377bd43.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//763155476af1438c0dd876c08377bd43.png"></p>

<h2 id="9" class="ng-scope">３．product.rbにインスタンスメソッドを定義する</h2>

<p class="ng-scope">2.までの作業で、productの平均評価を表示することができました。しかし、ビューファイルに長いロジックを書いてしまうとコードが読みづらくなってしまい、あとで管理が大変なので避けたほうが良いでしょう。そこで、この処理をまとめてインスタンスメソッドにします。</p>

<p class="ng-scope">今回こちらのメソッドを利用しているのは<code>Productクラス</code>のインスタンスです。そこで、上記の処理は<code>Productクラス</code>の<strong>インスタンス・メソッド</strong>として定義します。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_405"></i> レシーバ</h3>

<p class="ng-scope">インスタンスメソッドを利用するインスタンス自身のことです。例えば以下のようなコードがあった場合、3行目の式におけるレシーバは<code>str</code>です。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">str</span> <span class="o">=</span> <span class="s2">"3"</span>
  <span class="c1">#以下の式のレシーバはstr</span>
  <span class="n">str</span><span class="o">.</span><span class="n">to_i</span> <span class="c1">#=&gt; 3</span>
</pre></div>
</td>
</tr></tbody></table></div>

<h3 class="ng-scope">
<i class="icon information" id="term_406"></i> self</h3>

<p class="ng-scope">インスタンスメソッドの中で<code>self</code>と書くと、そのメソッドを利用したレシーバ自身が代入された変数のように扱うことができます。</p>

<p class="ng-scope">Integerクラスに定義されているインスタンスメソッド、<code>odd?</code>を例に考えてみましょう。</p>

<p class="ng-scope"><code>odd?</code>は<br>
レシーバが奇数かどうかを判定して<code>true</code>か<code>false</code>を返してくれるインスタンスメソッドです。判定のためにはレシーバを利用した式が必要です。なので、<code>odd?</code>を自分で作るとすれば、以下の例のような実装になると思います。<code>self</code>を使ってレシーバ自身をメソッドの中で利用しています。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">sample</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">class</span> <span class="nc">Integer</span>
    <span class="k">def</span> <span class="nf">odd?</span>
      <span class="k">if</span> <span class="nb">self</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="kp">true</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="kp">false</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="mi">2</span><span class="o">.</span><span class="n">odd?</span> <span class="c1">#=&gt; false</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">上記の例では、レシーバである2が<code>odd?</code>メソッドの中でselfに代入され、判定が行われた結果返り値が<code>false</code>になっています。</p>

<p class="ng-scope">今回<code>index.html.erb</code>に記述した処理をそのまま<code>Productクラス</code>に移動しただけではエラーが起きてしまいます。そこで、<code>self</code>を利用しレシーバ自身である<code>product</code>をインスタンス・メソッドの中に呼んであげます。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/models/product.rbを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">product.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:reviews</span>

<span class="hll">  <span class="k">def</span> <span class="nf">review_average</span>
</span><span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="ss">:rate</span><span class="p">)</span><span class="o">.</span><span class="n">round</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">さらに、<code>self</code>は実は<strong>省略することが可能</strong>です。上記の式を省略すると、以下のようになります。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">product.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:reviews</span>

  <span class="k">def</span> <span class="nf">review_average</span>
<span class="hll">    <span class="n">reviews</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="ss">:rate</span><span class="p">)</span><span class="o">.</span><span class="n">round</span> 
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">だいぶスッキリとした式になりましたね。</p>

<p class="ng-scope">続いて、定義したメソッドを実際にビューで利用します。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/views/products/index.html.erbを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">app/views/products/index.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td>
<td class="code">
<div class="highlight"><pre>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"yjGuid"</span><span class="nt">&gt;&lt;a</span> <span class="na">id=</span><span class="s">"yjContentsStart"</span> <span class="na">name=</span><span class="s">"yjContentsStart"</span><span class="nt">&gt;&lt;/a&gt;&lt;img</span> <span class="na">alt=</span><span class="s">"ここから本文です"</span> <span class="na">height=</span><span class="s">"1"</span> <span class="na">src=</span><span class="s">"http://i.yimg.jp/yui/jp/tmpl/1.1.0/audionav.gif"</span> <span class="na">width=</span><span class="s">"1"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjMain"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">"section"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"header header--section"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"text-middle"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-movie color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>新着作品
                <span class="nt">&lt;/h2&gt;</span>
              <span class="nt">&lt;/header&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"thumbnails thumbnail--movies row grid4 js-lazy-load-images js-my-check-stats"</span> <span class="na">id=</span><span class="s">"list-module"</span><span class="nt">&gt;</span>
                <span class="err">&lt;</span>% @products.each do |product| %&gt;
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"col"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/products/&lt;%= product.id %&gt;"</span><span class="nt">&gt;&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__figure"</span> <span class="na">style=</span><span class="s">"background-image:url(&lt;%= product.image_url %&gt;)"</span><span class="nt">&gt;&lt;/div&gt;&lt;/a&gt;</span>
                  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__caption"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"text-xsmall text-overflow"</span> <span class="na">title=</span><span class="s">"&lt;%= product.title %&gt;"</span><span class="nt">&gt;</span>
                      <span class="err">&lt;</span>%= product.title %&gt;
                    <span class="nt">&lt;/h3&gt;</span>
                    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-small"</span><span class="nt">&gt;</span>
                      <span class="err">&lt;</span>% if product.reviews.present? %&gt;
                      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"rating-star"</span><span class="nt">&gt;</span>
<span class="hll">                        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"star-actived rate-&lt;%= product.review_average %&gt;0"</span><span class="nt">&gt;&lt;/i&gt;</span>
</span>                      <span class="nt">&lt;/span&gt;</span>
                      <span class="err">&lt;</span>% else %&gt;
                      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"rating-star"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"star-actived rate-0"</span><span class="nt">&gt;&lt;/i&gt;</span>
                      <span class="nt">&lt;/span&gt;</span>
                      <span class="err">&lt;</span>% end %&gt;
                    <span class="nt">&lt;/p&gt;</span>
                  <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
                <span class="err">&lt;</span>% end %&gt;
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/article&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjSub"</span><span class="nt">&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">この段階で、2. の作業終了時と同じように平均の値が星の数で表示されていれば成功です。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="406" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-554" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-554" name="check-554" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">トップページで作品の評価が星で表示された</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-555" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-555" name="check-555" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">作品ページでレビューの評価が星で表示された</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 id="10" class="ng-scope">STEP2：ランキング機能を実装しよう</h1>

<p class="ng-scope">次にランキング機能を実装しましょう。見本となるmoooviのサイトを確認してみてください。トップページの右側に<strong>投稿ランキング</strong>が表示されていると思います。</p>

<p class="ng-scope"><a href="http://mooovi.tech-camp.in/">mooovi(http://mooovi.tech-camp.in/)</a></p>

<p class="ng-scope"><img src="17.png" alt="ランキング"></p>

<p class="ng-scope">このランキングは投稿数が多いものを上から順に<strong>トップ5</strong>で表示しています。ランキングを取得して表示させてみましょう。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.before_actionを設定する</h5>

<h5 class="ng-scope">2.ランキングを表示させる</h5>

<h5 class="ng-scope">3.productsテーブルから、レビュー数が多い順に5件レコードを取得する</h5>

<h2 id="11" class="ng-scope">1.before_actionを設定する</h2>

<p class="ng-scope">ランキングの条件は<strong>「投稿数の多いものから順番に」</strong>と<strong>「上から5件取得」</strong>の2つです。ランキングが表示されるのは<strong>すべての画面</strong>です。つまり、<strong>すべてのコントローラーのアクションでランキングの情報を取得しなければなりません。</strong><br>
こういった場合、ランキングを取得する処理を<strong>before_action</strong>で記述しましょう。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_407"></i> before_action</h3>

<p class="ng-scope">あるコントローラのすべてのアクションで<strong>実行の前に共通の処理を行いたい</strong>ときがあります。before_actionを使用すると全てのアクションが実行される前に指定したメソッドを呼び出すことができるようになります。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">class</span> <span class="err">コントローラ名</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="n">before_action</span> <span class="p">:</span><span class="err">処理させたいメソッドの名前</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">例えば、ProductsControllerという名前のコントローラで、毎回インスタンス変数<code>@page_title</code>に「作品ページ」という文字列を代入する処理を各アクションの前に実行したいとします。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">class</span> <span class="nc">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">    <span class="n">before_action</span> <span class="ss">:configure_title</span>
</span>
    <span class="k">def</span> <span class="nf">index</span>
      <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">all</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">configure_title</span>
      <span class="vi">@page_title</span> <span class="o">=</span> <span class="s1">'作品ページ'</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">このソースコードではProductsControllerのindexアクションが呼ばれる前に、<code>configure_title</code>が実行されます。さらにindexアクションだけでなく、ProductsControllerの他すべてのアクションで<code>configure_title</code>が最初に呼ばれます。</p>

<p class="ng-scope"><strong>before_actionの特徴</strong><br>
① before_actionを書いたコントローラのすべてのアクションの前に処理を行える<br>
② before_actionを書いたコントローラで共通の処理を行える</p>

<hr class="ng-scope">

<p class="ng-scope">ではどのコントローラに<code>before_action</code>を書けばいいでしょうか。今回ランキングを表示するのはいまのところは<strong>すべてのビューです。</strong>よって、<strong>ProductsController</strong>と<strong>ReviewsController</strong>の2つに書けばいいのですがこれら2つのコントローラは<strong>RankingControllerを継承しています</strong>。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_408"></i> コントローラの継承</h3>

<p class="ng-scope">コントローラは別のコントローラを<strong>継承</strong>することができます。継承をすると継承元のコントローラの持つメソッドや特徴を引き継ぐことができます。</p>

<p class="ng-scope">コントローラの継承はコントローラの定義で以下のように書きます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="err">コントローラ</span> <span class="o">&lt;</span> <span class="err">継承元のコントローラ</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">例えば、AnimalControllerを継承したDogControllerをつくる場合は以下のようになります。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">DogController</span> <span class="o">&lt;</span> <span class="no">AnimalController</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">このとき、AnimalControllerでbefore_actionを以下のように定義しているとします。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">AnimalController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:say_hello</span>

  <span class="k">def</span> <span class="nf">say_hello</span>
    <span class="nb">puts</span> <span class="s2">"Hello Animal"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">すると、AnimalControllerを継承したDogControllerのすべてのアクションの前にもbefore_actionの<code>say_hello</code>メソッドが呼ばれます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">DogController</span> <span class="o">&lt;</span> <span class="no">AnimalController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@dog</span> <span class="o">=</span> <span class="no">Dog</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># =&gt; showアクションの前にsay_helloが呼ばれる</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">すべてのコントローラで共通のbefore_actionを定義したい場合は<strong>ApplicationController</strong>に記述します。<strong>これは、すべてのコントローラ</strong>(ApplicationController以外)<strong>がApplicationControllerを継承しているためです。</strong></p>

<p class="ng-scope">今回は<strong>RankingController</strong>にランキングを取得するbefore_actionを記述しましょう。<br>
RankingControllerを作らず直接ApplicationControllerを作ればいいのでは？、と思われるかもしれませんが、あくまでランキングを表示したいのはトップページと作品の個別ページです。この後マイページを実装していくのですが、ApplicationControllerに記載するとマイページにもランキングが表示されてしまいます。よって、RankingControllerを作成し、ランキングを表示させたいReviewsControllerとProductsControllerを継承させています。</p>

<p class="ng-scope"><img src="542bb99f3f1317966994be60bb9921fc.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//542bb99f3f1317966994be60bb9921fc.png"></p>

<p class="ng-scope">「投稿数が多い順に」という部分はこのあと実装するので、今回はProductsテーブルに入ってる作品を5件取得して変数<code>@ranking</code>に入れておきましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/controllers/ranking_controllerを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">app/controllers/ranking_controller.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">RankingController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">layout</span> <span class="s1">'review_site'</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:ranking</span>
</span><span class="hll">  <span class="k">def</span> <span class="nf">ranking</span>
</span><span class="hll">    <span class="vi">@ranking</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><code>limit</code>メソッドも<code>order</code>メソッドと同じように、<code>all</code>メソッドを省略することができます。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="407" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-556" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-556" name="check-556" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">before＿actionを使って各アクション実行前にランキングの変数<code>@ranking</code>を定義できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="408" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-557" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-557" name="check-557" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">before＿actionを設定するとコントローラのアクションが呼ばれる前にメソッドを実行できる</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-558" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-558" name="check-558" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">コントローラは他のコントローラを継承できる</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-559" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-559" name="check-559" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">継承したコントローラは継承元のコントローラのbefore＿actionやメソッドを引き継いで使うことができる</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="12" class="ng-scope">2.ランキングを表示させる</h2>

<p class="ng-scope">では、先ほど定義した変数<code>@ranking</code>をビューに反映させましょう。どのファイルにランキングのHTMLが記述されているでしょうか。ランキングの情報を取得するbefore_actionは<strong>RankingController</strong>に実装しました。RankingControllerの2行目を見てみましょう。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">ranking_controller.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">RankingController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">layout</span> <span class="s1">'review_site'</span>
</span>  <span class="n">before_action</span> <span class="ss">:ranking</span>
  <span class="k">def</span> <span class="nf">ranking</span>
    <span class="vi">@ranking</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><code>layout 'review_site'</code>という記述がありますね。これはビューの<strong>レイアウトファイル</strong>を指定するものです。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_409"></i> レイアウトファイル</h3>

<p class="ng-scope">レイアウトファイルとは<strong>app/views/layouts/</strong>の下に入っているHTMLファイルです。レイアウトファイルはURLにアクセスして対応するコントローラが呼ばれたあと、最初に表示されるHTMLのことです。実は今まで修正していた<strong>show.html.erb</strong>などのファイルはレイアウトファイルの中に呼び出されています。</p>

<ul class="filetree ng-scope">
  <li class="t-folder"> app
    <ul>
      <li class="t-folder"> views
        <ul>
          <li class="t-folder"> <strong>layouts</strong>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 class="ng-scope">
<i class="icon information" id="term_410"></i> layout 'レイアウトファイル名'</h3>

<p class="ng-scope">コントローラ内で<code>layout 'レイアウトファイル名'</code>と書くと、そのコントローラでのアクションが呼ばれたあと表示するビューのレイアウトファイルを指定できます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">MovieController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">layout</span> <span class="s1">'movie'</span>
</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@movies</span> <span class="o">=</span> <span class="no">Movie</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">例えばこのように指定すると、MovieControllerのindexアクションが呼ばれたときに表示されるレイアウトは<strong>movie.html.erb</strong>となります。</p>

<p class="ng-scope"><i class="icon attention"></i> なにも指定しないとレイアウトファイルは<strong>application.html.erb</strong>となります。</p>

<hr class="ng-scope">

<p class="ng-scope">今回、RankingControllerでは<code>layout 'review_site'</code>が指定されているので表示されるレイアウトファイルは<strong>review_site.html.erbに</strong> なります。</p>

<p class="ng-scope">では<code>review_site.html.erb</code>を開いてみましょう。</p>

<ul class="filetree ng-scope">
  <li class="t-folder"> app
    <ul>
      <li class="t-folder"> views
        <ul>
          <li class="t-folder"> layouts
            <ul>
              <li class="t-file"> review-site.html.erb </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope">review_site.html.erbの29行目を見てみてください。</p>

<div class="code-frame ng-scope" data-lang="rhtml"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>29</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">この<code>&lt;%= yield %&gt;</code>は外部のHTMLファイルを読み込むためのerb記法です。ここに今まで修正していたshow.html.erbなどのHTMLがアクションごとに差し込まれます。</p>

<p class="ng-scope">では、review_site.html.erbを修正して、ランキングが表示されるようにしましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/views/layout/review_site.html.erbを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">review_site.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">class=</span><span class="s">"pc"</span> <span class="na">lang=</span><span class="s">"ja"</span> <span class="na">xmlns:fb=</span><span class="s">"http://ogp.me/ns/fb#"</span> <span class="na">xmlns:og=</span><span class="s">"http://ogp.me/ns#"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>映画レビューサイト<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">'http://fonts.googleapis.com/css?family=Signika:700,300,400,600'</span> <span class="na">rel=</span><span class="s">'stylesheet'</span> <span class="na">type=</span><span class="s">'text/css'</span><span class="nt">&gt;</span>
  <span class="err">&lt;</span>%= stylesheet_link_tag    "application", media: "all", "data-turbolinks-track" =&gt; true %&gt;
  <span class="err">&lt;</span>%= javascript_include_tag "application", "data-turbolinks-track" =&gt; true %&gt;
  <span class="err">&lt;</span>%= csrf_meta_tags %&gt;
<span class="nt">&lt;/meta&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">"yj950-2"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"wrapper"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsHeader"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"globalnav"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"globalnav__menu"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"gmenu"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"logo"</span> <span class="na">style=</span><span class="s">"float: left"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>mooovi<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"entry_button"</span> <span class="na">style=</span><span class="s">"float: right"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/products/search"</span><span class="nt">&gt;</span>投稿する<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;/ul&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"bgcolor-white pt1em pb1em"</span> <span class="na">id=</span><span class="s">"contents"</span><span class="nt">&gt;</span>
      <span class="err">&lt;</span>%= yield %&gt;
      <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"section"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h4</span> <span class="na">class=</span><span class="s">"text-small hr-bottom--thin no-space-bottom"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-crown color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>投稿ランキング
        <span class="nt">&lt;/h4&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"listview listview--condensed text-small"</span><span class="nt">&gt;</span>
<span class="hll">          <span class="err">&lt;</span>% @ranking.each.with_index(1) do |product, i| %&gt;
</span><span class="hll">          <span class="nt">&lt;li</span> <span class="na">data-cinema-id=</span><span class="s">"346394"</span><span class="nt">&gt;</span>
</span><span class="hll">            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/products/&lt;%= product.id %&gt;"</span><span class="nt">&gt;</span>
</span><span class="hll">              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box"</span><span class="nt">&gt;</span>
</span><span class="hll">                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box__cell w40 align-center"</span><span class="nt">&gt;</span>
</span><span class="hll">                  <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"label bgcolor-gray-lighter align-center"</span><span class="nt">&gt;</span>
</span><span class="hll">                    <span class="err">&lt;</span>%= i %&gt;
</span><span class="hll">                  <span class="nt">&lt;/p&gt;</span>
</span><span class="hll">                <span class="nt">&lt;/div&gt;</span>
</span><span class="hll">                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box__cell pl1em"</span><span class="nt">&gt;</span>
</span><span class="hll">                  <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-xsmall no-space"</span><span class="nt">&gt;</span>
</span><span class="hll">                    <span class="err">&lt;</span>%= product.title %&gt;
</span><span class="hll">                  <span class="nt">&lt;/p&gt;</span>
</span><span class="hll">                  <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"&lt;%= product.image_url %&gt;"</span> <span class="na">alt=</span><span class="s">""</span><span class="nt">&gt;</span>
</span><span class="hll">                <span class="nt">&lt;/div&gt;</span>
</span><span class="hll">              <span class="nt">&lt;/div&gt;</span>
</span><span class="hll">            <span class="nt">&lt;/a&gt;</span>
</span><span class="hll">          <span class="nt">&lt;/li&gt;</span>
</span><span class="hll">          <span class="err">&lt;</span>% end %&gt;
</span>        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/aside&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"copyright"</span><span class="nt">&gt;</span>
  Copyright (C) 2015  XXX Corporation. All Rights Reserved.
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">@rankingは<code>ActiveRecordRelation</code>クラスのインスタンスです。なので、配列クラス(<code>Array</code>クラス)に定義されているメソッドを利用することができます。ランキングの変数<code>@ranking</code>に対して繰り返し処理を行って表示をしています。</p>

<p class="ng-scope"><img src="17.png" alt="ランキング"></p>

<p class="ng-scope">先ほど編集していただいた３６行目の内容に、<strong>each.with_index</strong> という記述がありました。こちらでは、<code>each</code>メソッドに <code>with_index</code>メソッドをあわせて使っています。 <code>each</code>メソッドと <code>with_index</code>メソッドを併用すると、要素の数だけブロックを繰り返し実行し、繰り返しごとに <code>|</code> で囲われている部分の <code>i</code> に番号が入ります。デフォルトでは、<code>i</code>には0から入ります。今回は <code>with_index(1)</code>と引数を渡した事で、1から番号が入りました。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">each.with_index使用例</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">array</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"abe"</span><span class="p">,</span> <span class="s2">"takahashi"</span><span class="p">,</span> <span class="s2">"hirata"</span><span class="o">]</span>

  <span class="n">array</span><span class="o">.</span><span class="n">each</span><span class="o">.</span><span class="n">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="n">i</span>
    <span class="nb">puts</span> <span class="nb">name</span>
  <span class="k">end</span>
  <span class="c1">#=&gt;(実行結果)</span>
  <span class="mi">0</span>
  <span class="n">abe</span>
  <span class="mi">1</span>
  <span class="n">takahashi</span>
  <span class="mi">2</span>
  <span class="n">hirata</span>

  <span class="n">array</span><span class="o">.</span><span class="n">each</span><span class="o">.</span><span class="n">with_index</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="n">i</span>
    <span class="nb">puts</span> <span class="nb">name</span>
  <span class="k">end</span>
  <span class="c1">#=&gt;(実行結果)</span>
  <span class="mi">5</span>
  <span class="n">abe</span>
  <span class="mi">6</span>
  <span class="n">takahashi</span>
  <span class="mi">7</span>
  <span class="n">hirata</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="409" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-560" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-560" name="check-560" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ランキング画面にランキングを表示できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="410" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-561" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-561" name="check-561" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">レイアウトファイルはURLにアクセスしたときに最初に呼ばれるHTMLファイル</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-562" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-562" name="check-562" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">コントローラ内で<strong>layout レイアウトファイル名</strong>と指定すると、コントローラごとに使うレイアウトファイルを指定できる</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-563" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-563" name="check-563" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">コントローラで指定しないときに呼ばれるデフォルトのレイアウトファイルは<strong>application.html.erb</strong></span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="13" class="ng-scope">3.productsテーブルから、レビュー数が多い順に5件レコードを取得する</h2>

<p class="ng-scope">ReviewControllerで取得したランキングの情報<code>@ranking</code>は今はProductsテーブルから5件取得しているだけです。ランキングとして、レビューの投稿数が多い作品を5件取得しましょう。<br>
ここはActiveRecordを上手く使わないと実装できません。必要な処理は以下です。</p>

<p class="ng-scope"><strong>① Reviewsテーブルのレコードを<code>product_id</code>ごとにまとめて、数の多い5件を取得する</strong></p>

<p class="ng-scope"><strong>② 取得した5件のReviewsテーブルのproduct_idを取得する</strong></p>

<p class="ng-scope"><strong>③ 取得したproduct_id(5件分)と同値のidを持つproductsテーブルのレコードをそれぞれ取得する</strong></p>

<p class="ng-scope">①の「Reviewsテーブルのレコードを<code>product_id</code>ごとにまとめて、数の多い5件を取得する。」がもっとも難しい処理です。ここで考えてみましょう。Reviewモデルはどの作品のレビューかわかるようにカラムとして<code>product_id</code>を持っています。レビューの投稿数が多いとはつまり、<strong>product_idが同じReviewsテーブルのレコードの数が多い</strong>、ということになります。</p>

<p class="ng-scope">そこでまずは、Reviewsテーブルのレコードをproduct_idでまとめましょう。あるテーブルを特定のカラムでまとめるには<strong>group</strong>メソッドを使います。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_411"></i> groupメソッド</h3>

<p class="ng-scope">groupメソッドはテーブルのレコードを<strong>指定したカラム</strong>でまとめることができます。以下のように使います。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="err">モデル</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="err">カラム名</span><span class="p">)</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">groupメソッドを使うと出力は以下のようになります。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="bush">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre>Review.group(:product_id)
  Review Load (10.5ms)  SELECT `reviews`.* FROM `reviews` GROUP BY product_id
=&gt; [#&lt;Review id: 1, nickname: "まいき", rate: 1, review: "おもしろい", product_id: 21, created_at: "2014-11-05 16:03:39", updated_at: "2014-11-05 16:03:39", user_id: 4&gt;,
  #&lt;Review id: 3, nickname: "えいちゃん", rate: 10, review: "感動した！また見たい", product_id: 22, created_at: "2014-11-05 16:03:39", updated_at: "2014-11-05 16:03:39", user_id: 4&gt;,
  #&lt;Review id: 13, nickname: "ごとう", rate: 10, review: "思っていたより良かった", product_id: 23, created_at: "2014-11-05 16:03:39", updated_at: "2014-11-05 16:03:39", user_id: 4&gt;
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">groupメソッドを使うと、指定したカラムでレコードがまとめられます。まとめられたレコードの内、idが一番小さいレコードの１件だけが表示されていますが、プログラムが実行されている裏側ではすべてのレコードが指定したカラムでまとめられています。現在は、それぞれのまとまりが具体的に何個あるのかはわかりません。</p>

<p class="ng-scope"><img src="108191458f6c7e304a8f8e4d1f2aae9d.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//108191458f6c7e304a8f8e4d1f2aae9d.png"></p>

<p class="ng-scope">この状態で<strong>countメソッド</strong>を使うとgroupメソッドでまとめられたレコードの数が取得できます。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_412"></i> countメソッド</h3>

<p class="ng-scope">countメソッドは配列などの要素数を返すメソッドです。groupメソッドに続けて使うと<strong>まとめられたそれぞれのレコードの数</strong>が取得できます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre>Review.group<span class="o">(</span>:product_id<span class="o">)</span>.count
<span class="o">=</span>&gt; <span class="o">{</span><span class="nv">21</span><span class="o">=</span>&gt;2, <span class="nv">22</span><span class="o">=</span>&gt;1, <span class="nv">23</span><span class="o">=</span>&gt;4<span class="o">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">ハッシュが返ってきているのがわかると思います。このハッシュのキーは<strong>groupメソッドで指定したカラムの値です</strong>。この例では<code>product_id</code>になります。ハッシュの値は<strong>groupメソッドでまとめられたレコード数</strong>です。</p>

<p class="ng-scope">例ではproduct_idが21のレコードが2つ、product_idが22のレコードが1つ、product_idが23のレコードが4つということになります。</p>

<hr class="ng-scope">

<p class="ng-scope">この状態で、レコード数でソートしたいですね。ソートには<strong>orderメソッド</strong>使います。</p>

<p class="ng-scope"><i class="icon attention"></i> <code>モデル.group(カラム名).count</code>は先ほど見たようにハッシュが返ってくるのでcountメソッドより前にorderメソッドを使いましょう。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre>Review.group<span class="o">(</span>:product_id<span class="o">)</span>.order<span class="o">(</span><span class="s1">'product_id DESC'</span><span class="o">)</span>.count
<span class="o">=</span>&gt; <span class="o">{</span><span class="nv">23</span><span class="o">=</span>&gt;4, <span class="nv">22</span><span class="o">=</span>&gt;1, <span class="nv">21</span><span class="o">=</span>&gt;2<span class="o">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">この書き方ではproduct_idでソートされていますが、<strong>レコードの数ではソートされていません</strong>。groupメソッドでまとめたレコードの数でソートするには以下のように書きます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre>Review.group<span class="o">(</span>:product_id<span class="o">)</span>.order<span class="o">(</span><span class="s1">'count_product_id DESC'</span><span class="o">)</span>.count<span class="o">(</span>:product_id<span class="o">)</span>
<span class="o">=</span>&gt; <span class="o">{</span><span class="nv">23</span><span class="o">=</span>&gt;4, <span class="nv">21</span><span class="o">=</span>&gt;2, <span class="nv">22</span><span class="o">=</span>&gt;1<span class="o">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon information" id="term_413"></i> order('count_カラム名').count(カラム名)</h3>

<p class="ng-scope">countメソッドの引数にカラム名を指定することができます。するとorderメソッドで<strong>count_カラム名</strong>でのソートが可能となります。これは<strong>そのカラムを持つレコードの数でソートする</strong>という意味です。</p>

<p class="ng-scope">つまり上の例では、product_idでまとめたレコードをレコード数でソートして、カラム名とレコード数のハッシュで返す、という処理になっています。</p>

<p class="ng-scope">取得したいのは5件なので、<code>limit(5)</code>を付け加えます。limitメソッドは複数のレコードの配列のような形である<strong>ActiveRecord::Relation</strong>に対するメソッドです。count(:product_id)の時点ではハッシュになっているため、その後に付け加えるとハッシュに対してlimitメソッドを実行することになりエラーが起こります。そのため、その直前に付け加え、以下のようにします。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="no">Review</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:product_id</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">'count_product_id DESC'</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="ss">:product_id</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="mi">23</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="mi">21</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="mi">22</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><strong>product_idでまとめたレコードをレコード数でソート</strong></p>

<p class="ng-scope"><img src="22.png" alt="groupとorder"></p>

<h3 class="ng-scope">
<i class="icon information" id="term_414"></i> keysメソッド</h3>

<p class="ng-scope">ハッシュはkeysというメソッドを持っています。これはハッシュのキーだけを取り出して配列として返すメソッドです。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="no">Review</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:product_id</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">'count_product_id DESC'</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="ss">:product_id</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="mi">23</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">21</span><span class="o">]</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><strong>カラム名とレコード数のハッシュで返す</strong></p>

<p class="ng-scope"><img src="23.png" alt="groupとorder"></p>

<p class="ng-scope">以上でproduct_idの配列を投稿数が多い順に取得できました。</p>

<hr class="ng-scope">

<p class="ng-scope">product_idの配列からidに該当するProductsテーブルのレコードを取得するにはどうすればいいでしょうか。</p>

<p class="ng-scope">まず、思いつくのは<strong>where</strong>メソッドですね。whereメソッドはカラムと値を指定して、指定した値のカラムを持つレコードを取得します。このとき、<strong>渡す値は配列でも問題ありません。</strong><br>
そこで、Productsテーブルのidの配列<code>ids</code>を使ってwhereしてみます。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">ids</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span> <span class="c1"># product_idの配列</span>
  <span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">ids</span><span class="p">)</span>
  <span class="o">=&gt;</span> <span class="o">[</span><span class="c1">#&lt;Product id: 1, title: "美女と野獣"&gt;,</span>
      <span class="c1">#&lt;Product id: 2, title: "アオハライド"&gt;,</span>
      <span class="c1">#&lt;Product id: 3, title: "ホビット 決戦のゆくえ"&gt;]</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">これで該当するidの値がすべて取得できました。<br>
しかし、ここで１つ問題があります。それは<strong>取得したレコードの順番</strong>です。<br>
以下のような配列<code>ids</code>でwhereしたとき、レコードはどのような順番で取得できるでしょうか。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">ids</span> <span class="o">=</span> <span class="o">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span> <span class="c1"># Productsテーブルのidの配列</span>
  <span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">ids</span><span class="p">)</span>
  <span class="o">=&gt;</span> <span class="o">[</span><span class="c1">#&lt;Product id: 1, title: "美女と野獣"&gt;,</span>
      <span class="c1">#&lt;Product id: 2, title: "アオハライド"&gt;,</span>
      <span class="c1">#&lt;Product id: 3, title: "ホビット 決戦のゆくえ"&gt;]</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">出力結果に注目してください。配列<code>ids</code>を上の<code>ids = [1, 2, 3]</code>とした場合と、いまの<code>ids = [3, 1, 2]</code>の出力結果は同じです。これはwhereで値を配列にした場合、<strong>並びがid順になってしまう</strong>ためです。</p>

<p class="ng-scope">せっかくProductsモデルのidをレビューの投稿が多い順に取得したのに、これでは意味がありません。</p>

<ul class="ng-scope">
<li>期待した出力結果</li>
</ul>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="o">=</span>&gt; <span class="o">[</span><span class="c">#&lt;Product id: 3, title: "ホビット 決戦のゆくえ"?,</span>
      <span class="c">#&lt;Product id: 1, title: "美女と野獣"&gt;,</span>
      <span class="c">#&lt;Product id: 2, title: "アオハライド"&gt;]</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<ul class="ng-scope">
<li>whereメソッドでの出力結果</li>
</ul>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="o">=</span>&gt; <span class="o">[</span><span class="c">#&lt;Product id: 1, title: "美女と野獣"&gt;,</span>
      <span class="c">#&lt;Product id: 2, title: "アオハライド"&gt;,</span>
      <span class="c">#&lt;Product id: 3, title: "ホビット 決戦のゆくえ"&gt;]</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">この問題を解決するために<strong>mapメソッド</strong>を使用します。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_415"></i> mapメソッド</h3>

<p class="ng-scope">mapメソッドは配列オブジェクトのインスタンスメソッドです。mapオブジェクトは配列の中身を１つずつ取り出して<strong>ブロック</strong>という構文を繰り返し実行します。そして、ブロックの返り値を集めた新しい配列を作成します。</p>

<p class="ng-scope">mapメソッドは配列オブジェクトに対して以下のように使用します。</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="err">配列オブジェクト</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">ele</span><span class="o">|</span> <span class="err">ブロックの処理</span><span class="p">}</span>
  <span class="c1"># eleには配列の要素が１つずつ代入される</span>
  <span class="c1"># ブロックの処理は配列の要素の数だけ繰り返し実行される</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">具体的な例を見ていきましょう。<br>
配列に入っている全ての数値を2乗した新しい配列を取得したい場合、mapを使うと以下のように書けます。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">numbers</span> <span class="o">=</span> <span class="o">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="o">]</span>
  <span class="n">squares</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">number</span><span class="o">|</span> <span class="n">number</span> <span class="o">*</span> <span class="n">number</span><span class="p">}</span>
  <span class="nb">p</span> <span class="n">squares</span>
  <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">81</span><span class="o">]</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">ちゃんと配列<code>numbers</code>の各値が2乗された数値が配列<code>squares</code>に代入されています。</p>

<p class="ng-scope">これはmapメソッドによって以下のように処理が行われたためです。</p>

<p class="ng-scope"><img src="47.png" alt="mapメソッド"></p>

<p class="ng-scope">mapメソッドを使うと配列オブジェクトの各要素を使って新しい配列を生成することができます。product_idの配列に対してmapメソッドを使い、Productsテーブルからレコードを取得するのは以下のような方法になります。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="nv">ids</span> <span class="o">=</span> <span class="o">[</span>3, 1, 2<span class="o">]</span> <span class="c"># Productsテーブルのidの配列</span>
  <span class="nv">products</span> <span class="o">=</span> ids.map <span class="o">{</span><span class="p">|</span>product_id<span class="p">|</span> Productsテーブルからidがproduct_idのレコードを取得する<span class="o">}</span>
  <span class="o">=</span>&gt; <span class="o">[</span><span class="c">#&lt;Product id: 3, title: "ホビット 決戦のゆくえ"&gt;,</span>
      <span class="c">#&lt;Product id: 1, title: "美女と野獣"&gt;,</span>
      <span class="c">#&lt;Product id: 2, title: "アオハライド"&gt;]</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">mapメソッドを使うと順番はそのままでProductsテーブルからレコードを取得することができます。こちらのブロックの処理ではfindメソッドを使い、Productsテーブルからidがproduct_idのレコードを一本ずつ取得しましょう。</p>

<p class="ng-scope">では、これらをヒントにランキング機能を実装しましょう。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題2：レビューの投稿が多い作品を上から順に5件取得し、ランキングの変数@rankingに代入しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：app/controllers/ranking_controller.rb </h5>
    <h5>ヒント①：まず、レビュー数の多いproductのid上位5つが、多い順に並んだ配列を用意します</h5>
    <h5>ヒント②：次にmapメソッドを利用し、配列の中身をProductクラスのインスタンスに変換します</h5>

    <curriculum-question-container class="ng-scope" data-order="2"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">画面右側に、ランキング機能が実装されていることを確認ましょう。</p>

<p class="ng-scope"><img src="eb05322750fe784cf7500850e5fed7d8.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//eb05322750fe784cf7500850e5fed7d8.png"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="411" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-564" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-564" name="check-564" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">レビューの投稿が多い順にランキングを表示できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="412" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-565" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-565" name="check-565" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text"><strong>groupメソッド</strong>を使うと指定したカラムでレコードをまとめることができる</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-566" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-566" name="check-566" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">groupメソッドに続けて<strong>countメソッド</strong>を使うとまとめた各グループのレコード数が取得できる</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-567" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-567" name="check-567" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text"><strong>order('count_カラム名').count(カラム名)</strong>を使うと指定したカラムでグルーピングし、それぞれのレコード数でソートができる</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-568" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-568" name="check-568" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ハッシュの<strong>keysメソッド</strong>を使うとハッシュのキーの配列が取得できる</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 id="14" class="ng-scope">STEP3：deviseを使ってユーザーのサインアップ画面をつくろう</h1>

<p class="ng-scope">いまのmoooviにはユーザーという概念がありません。自分で書いたレビューをあとで見られるように、サインアップ画面をつくってユーザーを生成するようにしましょう。</p>

<p class="ng-scope">サインアップ画面とユーザーを作るには、PicTweetでも使ったgemの<strong>devise</strong>を利用しましょう。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.deviseのファイルをインストールする</h5>

<h5 class="ng-scope">2.必要なファイルを入れ替える</h5>

<h5 class="ng-scope">3.ユーザーのモデルを作成する</h5>

<h2 id="15" class="ng-scope">1.deviseのファイルをインストールする</h2>

<p class="ng-scope">まずはdeviseのgemをインストールする必要があります。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> Gemfileの末尾に以下の記述を追加しましょう</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">Gemfile</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>50</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">gem</span> <span class="s1">'devise'</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> bundle installコマンドを実行しましょう</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span><span class="nb">pwd</span>
<span class="c">#/Users/ユーザー名/projects/moooviであることを確認</span>
<span class="nv">$ </span>bundle install
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">問題なくdeviseのgemがインストールできたらdeviseのセットアップをしましょう。</p>

<p class="ng-scope">まずは、deviseを使うのに必要なファイルを生成します。</p>

<h3 class="ng-scope">
<i class="icon pen" id="41"></i> rails g devise:installコマンドをターミナルで実行しましょう</h3>

<p class="ng-scope"><i class="icon attention"></i> 打ち間違えに注意しましょう</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>rails g devise:install
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">次にdeviseのサインアップやログインのviewファイルを生成します。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> rails g devise:viewsコマンドをターミナルで実行しましょう</h3>

<p class="ng-scope"><i class="icon attention"></i> 打ち間違えに注意しましょう</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>rails g devise:views
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">これでdeviseのviewファイルが生成できました。以下のように<strong>app/views</strong>のディレクトリの下に<strong>devise</strong>というディレクトリが生成されていれば成功です。</p>

<ul class="filetree ng-scope">
  <li class="t-folder"> app
    <ul>
      <li class="t-folder"> views
        <ul>
          <li class="t-folder"> <strong>devise</strong>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="16" class="ng-scope">2.必要なファイルを入れ替える</h2>

<p class="ng-scope">deviseで生成されるファイルのうち2つのファイルを準備のときにダウンロードした<strong>rails2-4フォルダ</strong>にあるファイルと置き換えましょう。</p>

<p class="ng-scope">ダウンロードしたフォルダを消してしまった人は以下のリンクからもう一度ダウンロードしてください。</p>

<p class="ng-scope"><a href="http://master.tech-camp.in/filedownload/12" target="_top">rails2-4.zip</a></p>

<p class="ng-scope">置き換えるファイルは以下の2つのファイルです。</p>

<ul class="ng-scope">
<li><strong>app/views/devise/registrations/new.html.erb</strong></li>
<li><strong>app/views/devise/sessions/new.html.erb</strong></li>
</ul>

<h3 class="ng-scope">
<i class="icon pen"></i> registrationsディレクトリにあるnew.html.erbファイルをダウンロードしたファイルで置き換えましょう</h3>

<p class="ng-scope"><strong>削除するファイル(mooovi)</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> app
    <ul>
      <li class="t-folder"> views
        <ul>
          <li class="t-folder"> devise
            <ul>
              <li class="t-folder"> registrations
                <ul>
                  <li class="t-file"> <strong>new.html.erb</strong> </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope"><strong>新しく置き換えるファイル(ダウンロードしたrails2-4)</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> rails2-4
    <ul>
      <li class="t-folder"> users
        <ul>
          <li class="t-folder"> registrations
            <ul>
            <li class="t-file"> <strong>new.html.erb</strong> </li>
            </ul>
          </li>
        </ul>
    </li>
</ul>
  </li>
</ul>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="413" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-569" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-569" name="check-569" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text"><strong>app/views/devise/registrations/new.html.erb</strong>を置き換えることが出来た</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h3 class="ng-scope">
<i class="icon pen"></i> sessionsディレクトリにあるnew.html.erbファイルをダウンロードしたファイルで置き換えましょう</h3>

<p class="ng-scope"><strong>削除するファイル(mooovi)</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> app
    <ul>
      <li class="t-folder"> views
        <ul>
          <li class="t-folder"> devise
            <ul>
              <li class="t-folder"> sessions
                <ul>
                  <li class="t-file"> <strong>new.html.erb</strong> </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope"><strong>新しく置き換えるファイル(ダウンロードしたrails2-4)</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> rails2-4
    <ul>
      <li class="t-folder"> users
        <ul>
          <li class="t-folder"> sessions
            <ul>
            <li class="t-file"> <strong>new.html.erb</strong>
</li>
            </ul>
          </li>
        </ul>
    </li>
</ul>
  </li>
</ul>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="414" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-570" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-570" name="check-570" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text"><strong>app/views/devise/sessions/new.html.erb</strong>を置き換えることが出来た</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="17" class="ng-scope">3.ユーザーのモデルを作成する</h2>

<p class="ng-scope">あとはユーザーモデルの生成を行えばサインアップ機能が実装できます。ユーザーモデルの作成にはターミナルでdeviseのコマンド<code>rails g devise</code>コマンドを使います。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> 以下の指示に従って、ユーザーモデルを作成しましょう</h3>

<p class="ng-scope">まずはdeviseを利用してuserモデルを作成します。</p>

<h4 class="ng-scope">1. ターミナルで以下のコマンドを実行してください</h4>

<p class="ng-scope"><i class="icon attention"></i> 打ち間違えに注意しましょう<br>
<i class="icon attention"></i> <a href="#15" target="_self">1.deviseのファイルをインストールする</a>で<strong>間違いなくrails g devise:installコマンドを実行してから</strong>以下のコマンドを実行してください</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>rails g devise user
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">正常に実行できたらユーザーモデル作成のためのマイグレーションファイルが生成されるのでこれを実行しましょう。</p>

<h4 class="ng-scope">2. 以下のようにマイグレーションを実行し、usersテーブルを作成してください</h4>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</td>
</tr></tbody></table>
</div>

<h4 class="ng-scope">3. deviseの設定を反映させる必要があるので、サーバーを再起動しましょう</h4>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c"># サーバーの立ち上がっているターミナルの画面に移動して</span>
<span class="c"># サーバーの停止コマンド「control + c」</span>
<span class="c">#####</span>
<span class="c"># サーバーの停止</span>
<span class="c">#####</span>
<span class="nv">$ </span>rails s
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">ユーザーモデルが作成できたらブラウザで<a href="http://localhost:3000/users/sign_up">http://localhost:3000/users/sign_up</a>にアクセスしてユーザーの作成画面に遷移するか確かめてみましょう。</p>

<p class="ng-scope"><strong>新規登録画面</strong></p>

<p class="ng-scope"><img src="25.png" alt="SignUp画面"></p>

<h3 class="ng-scope">
<i class="icon attention"></i> 上記の画像のように表示されない場合</h3>

<p class="ng-scope">上記のようなデザインではなく、見た目が崩れてしまっている場合は以下の操作をしてください。</p>

<p class="ng-scope">Finderで現在作成中のアプリケーションが存在するディレクリに移動します。<br>
その中の<strong>tmpというフォルダの中の<code>cache</code>というフォルダをゴミ箱に入れてください。</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> mooovi
    <ul>
      <li class="t-folder"> tmp
        <ul>
          <li class="t-folder"><strong>cache</strong></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope"><strong>削除した後に、サーバーを再起動</strong>し、もう一度上記の画像のようなデザインになっているか確認してみましょう。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="415" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-571" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-571" name="check-571" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">サインアップ画面にアクセスすることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 id="18" class="ng-scope">STEP4：サインアウト、ログイン機能をつけよう</h1>

<p class="ng-scope">ユーザーの登録ができるようになりました。しかしこの状態では既存のユーザーでログインしたり、アカウントを切り替えることができません。そこで、サインアウト、ログインができるようにしましょう。機能はすでにdeviseで実装できています。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.サインアウトボタンを設置する</h5>

<h5 class="ng-scope">2.サインアウト後のリダイレクトを設定する</h5>

<h5 class="ng-scope">3.サインインしていない場合はログイン画面にリダイレクトさせる</h5>

<h2 id="19" class="ng-scope">1.サインアウトボタンを設置する</h2>

<p class="ng-scope">ログインするにもサインアウトができなければなりません。そこでまずはサインアウト機能から実装しましょう。</p>

<p class="ng-scope">サインアウトのボタンを以下のように<strong>投稿するボタン</strong>の横に設置しましょう。</p>

<p class="ng-scope"><img src="26.png" alt="サインアウトボタン"></p>

<p class="ng-scope">このサインアウトボタンを押したら<a href="http://localhost:3000/users/sign_out">/users/sign_out</a>にリクエストを飛ばすようにしましょう。</p>

<p class="ng-scope">deviseで実装されるサインアウトのリクエストは初期の状態では<strong>DELETEメソッドです。</strong></p>

<p class="ng-scope">試しにmoooviのディレクトリでターミナルに<code>rake routes</code>コマンドを打ち込んでみましょう。これでリクエストとその種類が一覧で見られます。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="nv">$ </span><span class="nb">cd</span> ~/projects/mooovi
  <span class="c"># 「mooovi」ディレクトリに移動</span>

  <span class="nv">$ </span>bundle <span class="nb">exec </span>rake routes
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">以下のように出力されたと思います。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre> Prefix Verb   URI Pattern                       Controller#Action
        new_user_session GET    /users/sign_in<span class="o">(</span>.:format<span class="o">)</span>          devise/sessions#new
            user_session POST   /users/sign_in<span class="o">(</span>.:format<span class="o">)</span>          devise/sessions#create
    destroy_user_session DELETE /users/sign_out<span class="o">(</span>.:format<span class="o">)</span>         devise/sessions#destroy
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><code>/users/sign_out</code>の横には<code>DELETE</code>と書いてあります。よってサインアウトのリクエストの種類はDELETEということです。</p>

<p class="ng-scope">サインアウトボタンをaタグにした場合、<a href="http://localhost:3000/users/sign_out">/users/sign_out</a>のリクエストはデフォルトでは<strong>GETメソッド</strong>となってしまいます。そこで、メソッドがDELETEとなるようにHTMLを修正する必要があります。</p>

<p class="ng-scope">それでは、実際にサインアウトボタンを設置してみましょう。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題3: サインアウトボタンを設置しましょう </h3>
  <div class="challenge_box">
    <h5>作業ファイル：app/views/layouts/review_site.html.erb</h5>
    <h5>ヒント①：link_toメソッドを利用しましょう。</h5>
    <curriculum-question-container class="ng-scope" data-order="3"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="416" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-572" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-572" name="check-572" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">例のようにサインアウトボタンをつけることができた。</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="20" class="ng-scope">2.サインアウト後のリダイレクトを設定する</h2>

<p class="ng-scope">サインアウトができるようになりましたが、お分かりのようにサインアウトボタンを押してもなにもおきません（しかし実際にサインアウトはできています）。サインアウト後にはログイン画面に遷移させるのが自然ですね。</p>

<p class="ng-scope">ここでは<strong>サインアウト後のリダイレクト先の設定</strong>をしましょう。ログイン画面はdeviseの機能によってすでに実装されています。</p>

<p class="ng-scope"><strong>ログイン画面</strong></p>

<p class="ng-scope"><img src="31.png" alt="ログイン画面"></p>

<p class="ng-scope">サインアウト後のリダイレクト先のURLを設定するにはdeviseのメソッド<strong>after_sign_out_path_for</strong>を使いましょう。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_416"></i> after_sign_out_path_forメソッド</h3>

<p class="ng-scope">deviseでサインアウトしたあとのリダイレクト先を指定するメソッドとして<code>after_sign_out_path_for</code>があります。このメソッドでは返り値に<strong>サインアウト後のリダイレクト先URL</strong>を指定します。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">application_controller.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">def</span> <span class="nf">after_sign_out_path_for</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="s1">'???'</span> <span class="c1"># サインアウト後のリダイレクト先URL</span>
  <span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> app/controllers/application_controller.rbに、下記のように追記しましょう</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">application_controller.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">def</span> <span class="nf">after_sign_out_path_for</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="s1">'/users/sign_in'</span> <span class="c1"># サインアウト後のリダイレクト先URL</span>
  <span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">では実際に確認してみましょう。</p>

<p class="ng-scope">画面右上にある「サインアウト」をクリックします。</p>

<p class="ng-scope"><img src="7512460bd6724932062cc6db66e95884.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//7512460bd6724932062cc6db66e95884.png"></p>

<p class="ng-scope">ログイン画面が表示されるようになっていることを確認しましょう。</p>

<p class="ng-scope"><img src="8e4819419f8ff3ad38855ee223014cb8.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//8e4819419f8ff3ad38855ee223014cb8.png"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="418" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-576" ng-repeat="check in checkbox.checks"><input checked="checked" class="ng-pristine ng-untouched ng-valid" id="check-576" name="check-576" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">サインアウトボタンを押した後、ログイン画面に移動するようになった</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="21" class="ng-scope">3.サインインしていない場合はログイン画面にリダイレクトさせる</h2>

<p class="ng-scope">この状態では<a href="http://localhost:3000/users/sign_up">http://localhost:3000/users/sign_in</a>にアクセスするか、サインアウトボタンを押さないとログイン画面に移動しません。では、<strong>レビューの投稿はログインしている状態でないとできないようにしましょう。</strong></p>

<p class="ng-scope">レビューの投稿画面(作品の検索画面もふくめて)に移動したらログイン画面にリダイレクトさせます。逆に言えばトップページや作品ページはログインしていなくてもアクセスできます。</p>

<p class="ng-scope"><strong>ログインしていない状態</strong></p>

<p class="ng-scope"><img src="32.png" alt="レビューの投稿でのリダイレクト"></p>

<p class="ng-scope">レビューを投稿する画面に遷移するためのボタンは<strong>ヘッダーの「投稿するボタン」</strong>と<strong>作品ページの「この作品を投稿するボタン」</strong>の2つです。それぞれを押すとどのコントローラのどのアクションが呼ばれるのか確認しましょう。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_417"></i> authenticate_user!</h3>

<p class="ng-scope">deviseをインストールすると、ログイン画面とサインアップ画面を自動で用意してくれます。authenticate_user!はdeviseをインストールすることで使えるメソッドです。ユーザーがログインしているかどうかを確認し、ログインしていない場合はログインページにリダイレクトします。通常、before_actionを合わせて使用します。before_actionのexceptやonlyオプションを組み合わせると特定のアクションを指定することもできます。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">TopController</span> <span class="o">&lt;</span> <span class="no">ReviewController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span><span class="p">,</span> <span class="ss">except</span><span class="p">:</span> <span class="ss">:index</span>
</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@tweets</span> <span class="o">=</span> <span class="no">Tweet</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">per</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s2">"created_at DESC"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="no">Tweet</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">image</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:image</span><span class="o">]</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:text</span><span class="o">]</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">上の例ではbefore_actionにauthenticate_user!を記載しています。さらにexcept以下にindexアクションを記述することでindexアクション以外にだけauthenticate_ user!が適用されるように指定をしています。</p>

<p class="ng-scope">今回の場合は、<strong>「投稿するボタン」</strong>と<strong>作品ページの「この作品を投稿するボタン」</strong>を押した際に動くアクションにauthenticate_user!を<strong>before_action</strong>を使って記述します。ただ、コントローラすべてのアクションにそのbefore_actionを適応させるとレビューを投稿する時以外(ホームや作品ページ)でもリダイレクトの処理が実行されてしまいます。</p>

<p class="ng-scope">そこで、<strong>onlyオプションを使って、before_actionをどのアクションのときに実行させるか選択しましょう</strong>。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題4：ログインしていない状態でレビューの投稿をしようとすると、ログイン画面にリダイレクトされるようにしましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：どのファイルを編集すれば良いか、考えてみてください </h5>
    <h5>ヒント①：レビューを投稿する画面に移動できるのはヘッダーの「投稿するボタン」と作品ページの「この作品を投稿するボタン」の2つです</h5>
    <h5>ヒント②：レビューを投稿する画面のURLを見て、どのコントローラのどのアクションが呼ばれているか確認しましょう(rake routesを使うか、routes.rbを見るとわかります)</h5>

    <curriculum-question-container class="ng-scope" data-order="4"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">実際に確認してみましょう。<br>
「サインアウト」ボタンを押して、サインアウトしましょう。</p>

<p class="ng-scope"><img src="a0f7261d602b4f71a3ca27fb84aff80d.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//a0f7261d602b4f71a3ca27fb84aff80d.png"></p>

<p class="ng-scope">サインアウトするとログイン画面が表示されます。</p>

<p class="ng-scope">次に、ログイン画面の左上の「mooovi」というロゴをクリックしましょう。</p>

<p class="ng-scope"><img src="b3a997b801a3825a96221be0105095a5.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//b3a997b801a3825a96221be0105095a5.png"></p>

<p class="ng-scope">作品一覧画面が表示されます。<br>
次に、作品一覧画面の右上にある「投稿する」をクリックしましょう。</p>

<p class="ng-scope"><img src="8d2c63d68fd3a018d8afd582d2ab1390.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//8d2c63d68fd3a018d8afd582d2ab1390.png"></p>

<p class="ng-scope">そうすると、ログイン画面にリダイレクトされることを確認しましょう。</p>

<p class="ng-scope"><img src="b5130e16f879798977f10a0808f83b31.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//b5130e16f879798977f10a0808f83b31.png"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="419" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-577" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-577" name="check-577" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">サインアップしていない状態でレビューを投稿しようとするとき、サインアップ画面にリダイレクトさせることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 id="22" class="ng-scope">STEP5：paperclipを使って画像のアップロード機能をつけよう</h1>

<p class="ng-scope">せっかくユーザーの概念を作ったのでユーザーのアイコンを設定できるようにしたいですね。</p>

<p class="ng-scope">そこでこのSTEPでは画像アップロード用のgemである<strong>paperclip</strong>を使って、画像のアップロード機能を実装しましょう。paperclipを使うと非常に簡単に画像のアップロード機能を実装することができます。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.paperclipをインストールする</h5>

<h5 class="ng-scope">2.usersテーブルにpaperclip用のカラムを追加する</h5>

<h5 class="ng-scope">3.userモデルにpaperclipの設定を追記する</h5>

<h2 id="23" class="ng-scope">1.paperclipをインストールする</h2>

<p class="ng-scope">paperclipを使うには<strong>ImageMagick</strong>という画像変換ツールをパソコン内にインストールする必要があります(これはgemとは別のツールです)。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_418"></i> ImageMagick</h3>

<p class="ng-scope">ImageMagickは、コマンドラインから簡単に画像の保存形式の変更などが行えるツールです。</p>

<p class="ng-scope">すでにImageMagickがインストール済みかどうかはターミナルで<code>which convert</code>コマンドを使ってパスが表示されるかで判断できます。コマンドを使うディレクトリはどこでも良いです。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>which convert
/usr/local/bin/convert  <span class="c"># このようにパスが表示されていればImageMagickのインストールは完了しています</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">上の例のように<code>which convert</code>コマンドを使ってパスが表示されればImageMagickはインストール済みです。もし、エラーが出た人はまだImageMagickをインストールしていないので、以下のコマンドでインストールしましょう。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>brew install imagemagick
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">インストールが完了したら、<code>which convert</code>コマンドでパスが表示されるか確認してみてください。</p>

<p class="ng-scope">ImageMagickがインストールできたら、paperclipをインストールします。paperclipはgemなのでいつものようにGemfileの末尾にpaperclipを追加します。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">gemfile</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>51</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">gem</span> <span class="s1">'paperclip'</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">記述したらターミナルで<code>bundle install</code>しましょう。ディレクトリがmoooviであることを確認しましょう。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>bundle install
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">ではgemを新しくインストールしたのでサーバーを再起動しましょう。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c"># サーバーの立ち上がっているターミナルの画面に移動して</span>
<span class="c"># サーバーの停止コマンド「control + c」</span>
<span class="c">#####</span>
<span class="c"># サーバーの停止</span>
<span class="c">#####</span>
<span class="nv">$ </span>rails s
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">これでpaperclipの導入は完了します。</p>

<p class="ng-scope">gemが導入できたかどうかはmooovi/Gemfile.lockというファイルの中を見て確認します。以下のように<strong>paperclip</strong>があれば正常にインストールされています。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">Gemfile.lock</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="no">GEM</span>
  <span class="ss">remote</span><span class="p">:</span> <span class="ss">https</span><span class="p">:</span><span class="sr">//</span><span class="n">rubygems</span><span class="o">.</span><span class="n">org</span><span class="o">/</span>
  <span class="ss">specs</span><span class="p">:</span>
    <span class="c1"># 中略</span>

        <span class="n">mysql2</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">20</span><span class="p">)</span>
<span class="hll">        <span class="n">paperclip</span> <span class="p">(</span><span class="mi">4</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</span>          <span class="n">activemodel</span> <span class="p">(</span><span class="o">&gt;=</span> <span class="mi">3</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
          <span class="n">activesupport</span> <span class="p">(</span><span class="o">&gt;=</span> <span class="mi">3</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
          <span class="n">cocaine</span> <span class="p">(</span><span class="o">~&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>
          <span class="n">mime</span><span class="o">-</span><span class="n">types</span>
          <span class="n">mimemagic</span> <span class="p">(</span><span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">polyglot</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">pry</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 中略</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="420" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-578" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-578" name="check-578" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">paperclipを導入できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="421" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-579" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-579" name="check-579" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text"><strong>paperclip</strong>は画像をアップロードを簡単にできるようにするgem</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-580" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-580" name="check-580" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">paperclipを使うには<strong>ImageMagick</strong>のインストールが必要</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-581" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-581" name="check-581" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text"><strong>gem listコマンド</strong>でインストールされているgemの一覧が見れる</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="24" class="ng-scope">2.usersテーブルにpaperclip用のカラムを追加する</h2>

<p class="ng-scope">ユーザーのアイコン画像をアップロードして設定できるようにします。つまり、ユーザーモデルにアイコン画像用のカラムを追加する必要があるということです。これもpaperclipを使うとほとんど自動で設定してくれます。</p>

<p class="ng-scope">ユーザーモデルに追加するアイコン画像のカラム名は<code>avatar</code>にしましょう。カラム追加用のマイグレーションファイルはpaperclipのコマンド<code>rails g paperclip</code>で生成できます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>rails g paperclip モデル名 カラム名
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> ターミナルから以下のコマンドを実行しましょう</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c">#usersテーブルにavatarカラムを追加するためのマイグレーションファイルを作成</span>
<span class="nv">$ </span>rails g paperclip user avatar
<span class="c">#マイグレーションファイルの実行</span>
<span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">avatarのスペルに注意して入力しましょう。<br>
これで画像のアップロードに必要なカラムがusersテーブルに追加されました。Sequel Proを使って確認してみましょう。</p>

<p class="ng-scope">これで画像のアップロードに必要なカラムがusersテーブルに追加されました。</p>

<p class="ng-scope">Sequel Proでusersテーブルに、以下のようにavatarカラムが追加されているか確認しましょう。</p>

<p class="ng-scope"><img src="a9ff17c5f6a70595091f954e44214596.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//a9ff17c5f6a70595091f954e44214596.png"></p>

<h2 id="25" class="ng-scope">3.userモデルにpaperclipの設定を追記する</h2>

<p class="ng-scope">しかしこれだけではアイコン画像のアップロードはできません。Userモデルにアイコン画像の設定を記述しなくてはいけません。記述しなくてはいけない設定は<code>has_attached_file</code>と<code>validates_attachment_content_type</code>の2つです。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_419"></i> has_attached_file</h3>

<p class="ng-scope"><code>has_attached_file</code>では画像用のカラムのサイズやデフォルト画像、画像ファイルの保存先を設定できます。今回はサイズをだけ指定します。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="err">モデル名</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

  <span class="n">has_attached_file</span> <span class="p">:</span><span class="err">カラム名</span><span class="p">,</span>
                    <span class="ss">styles</span><span class="p">:</span>  <span class="p">{</span> <span class="ss">medium</span><span class="p">:</span> <span class="s2">"画像サイズ"</span><span class="p">,</span> <span class="ss">thumb</span><span class="p">:</span> <span class="s2">"画像サイズ"</span> <span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope"><code>has_attached_file</code>のあとにはまず、カラム名を続けます。その後サイズの指定をします。今回はカラム名は<code>avatar</code>にしたので以下のようになります。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="err">モデル名</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

<span class="hll">  <span class="n">has_attached_file</span> <span class="ss">:avatar</span><span class="p">,</span>
</span>                    <span class="ss">styles</span><span class="p">:</span>  <span class="p">{</span> <span class="ss">medium</span><span class="p">:</span> <span class="s2">"画像サイズ"</span><span class="p">,</span> <span class="ss">thumb</span><span class="p">:</span> <span class="s2">"画像サイズ"</span> <span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">サイズを指定するための属性は<strong>styles</strong>です。stylesでは<strong>どのような種類</strong>の画像を<strong>どの大きさ</strong>で保存するか指定します。「medium」や「thumb」はImageMagickで保存できる画像の種類です。</p>

<p class="ng-scope">画像サイズの指定はImageMagickでの指定方法に準じます。以下のような指定方法があります。</p>

<p class="ng-scope"><strong>画像サイズの指定方法</strong></p>

<table class="ng-scope">
<thead>
<tr>
<th style="text-align: center;">指定方法</th>
<th style="text-align: center;">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">100×100</td>
<td style="text-align: center;">横100px、縦100pxの画像(アスペクト比を保つ)</td>
</tr>
<tr>
<td style="text-align: center;">100×100!</td>
<td style="text-align: center;">アスペクト比を無視</td>
</tr>
<tr>
<td style="text-align: center;">100×100&gt;</td>
<td style="text-align: center;">一番長い辺を100pxにするようにリサイズ(アスペクト比を保つ)</td>
</tr>
<tr>
<td style="text-align: center;">100×100^</td>
<td style="text-align: center;">一番短い辺を100pxにするようにリサイズ(アスペクト比を保つ)</td>
</tr>
<tr>
<td style="text-align: center;">100×100#</td>
<td style="text-align: center;">アスペクト比を保ち一番短い辺を100pxにするようにリサイズし、画像を中央によせ、はみ出た部分は切り取る</td>
</tr>
</tbody>
</table>

<p class="ng-scope"><i class="icon attention"></i>「x」は「半角英字の小文字のエックス」です</p>

<h3 class="ng-scope">
<i class="icon information" id="term_420"></i> validates_attachment_content_type</h3>

<p class="ng-scope"><code>validates_attachment_content_type</code>は画像のバリデーションを設定します。サイズや画像の種類でバリデーションが可能です。今回は画像の種類だけ指定します。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="err">モデル</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

  <span class="n">validates_attachment_content_type</span> <span class="p">:</span><span class="err">カラム名</span><span class="p">,</span>
                                    <span class="ss">content_type</span><span class="p">:</span> <span class="o">[</span><span class="s2">"画像の種類"</span><span class="o">]</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope"><code>validates_attachment_content_type</code>のあとにはまず、カラム名を続けます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="err">モデル</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

<span class="hll">  <span class="n">validates_attachment_content_type</span> <span class="ss">:avatar</span><span class="p">,</span>
</span>                                    <span class="ss">content_type</span><span class="p">:</span> <span class="o">[</span><span class="s2">"画像の種類"</span><span class="o">]</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">その後アップロードを許可する画像の種類の指定をします。<br>
画像の種類を指定するための属性は<strong>content_type</strong>です。content_typeでは許可する画像の種類の<strong>配列</strong>を指定します。</p>

<p class="ng-scope"><strong>画像の種類の指定方法</strong></p>

<table class="ng-scope">
<thead>
<tr>
<th style="text-align: center;">指定方法</th>
<th style="text-align: center;">備考</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">image/jpg</td>
<td style="text-align: center;">jpgファイル</td>
</tr>
<tr>
<td style="text-align: center;">image/jpeg</td>
<td style="text-align: center;">jpegファイル</td>
</tr>
<tr>
<td style="text-align: center;">image/png</td>
<td style="text-align: center;">pngファイル</td>
</tr>
<tr>
<td style="text-align: center;">image/gif</td>
<td style="text-align: center;">gifファイル</td>
</tr>
</tbody>
</table>

<h3 class="ng-scope">[例]</h3>

<p class="ng-scope">jpegとpngを許可する場合</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="err">モデル</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

  <span class="n">validates_attachment_content_type</span> <span class="p">:</span><span class="err">カラム名</span><span class="p">,</span>
                                    <span class="ss">content_type</span><span class="p">:</span> <span class="o">[</span><span class="s2">"image/jpeg"</span><span class="p">,</span> <span class="s2">"image/png"</span><span class="o">]</span>
</pre></div>
</td>
</tr></tbody></table></div>

<hr class="ng-scope">

<p class="ng-scope">今回のUserモデルのカラム<code>avatar</code>では以下の指定をしましょう。</p>

<ul class="ng-scope">
<li><strong>has_attached_file</strong></li>
</ul>

<p class="ng-scope">属性：styles</p>

<p class="ng-scope">種類：medium: "300x300#", thumb: "100x100#"</p>

<ul class="ng-scope">
<li><strong>validates_attachment_content_type</strong></li>
</ul>

<p class="ng-scope">属性：content_type</p>

<p class="ng-scope">種類：["image/jpg","image/jpeg","image/png"]</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/models/user.rbの先頭に、以下のように追記しましょう</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">ruby</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Include default devise modules. Others available are:</span>
  <span class="c1"># :confirmable, :lockable, :timeoutable and :omniauthable</span>
  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span>

<span class="hll">  <span class="n">has_attached_file</span> <span class="ss">:avatar</span><span class="p">,</span>
</span><span class="hll">                      <span class="ss">styles</span><span class="p">:</span>  <span class="p">{</span> <span class="ss">medium</span><span class="p">:</span> <span class="s2">"300x300#"</span><span class="p">,</span> <span class="ss">thumb</span><span class="p">:</span> <span class="s2">"100x100#"</span> <span class="p">}</span>
</span><span class="hll">  <span class="n">validates_attachment_content_type</span> <span class="ss">:avatar</span><span class="p">,</span>
</span><span class="hll">                                      <span class="ss">content_type</span><span class="p">:</span> <span class="o">[</span><span class="s2">"image/jpg"</span><span class="p">,</span><span class="s2">"image/jpeg"</span><span class="p">,</span><span class="s2">"image/png"</span><span class="o">]</span>
</span><span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">実際にアップロードができるかは<code>rails c</code>を使って以下の手順で確認できます。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> 以下の手順に従い、画像がアップロードできるか確かめましょう</h3>

<h3 class="ng-scope">①app/assets/imagesディレクトリに、任意の画像を配置してください</h3>

<p class="ng-scope">finderから直接ファイルを置いてしまってかまいません。ファイルの保存形式は、 <code>jpg</code>, <code>jpeg</code>, <code>png</code> のどれかでないといけません。</p>

<h3 class="ng-scope">②ターミナルから以下のコマンドを実行してください</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>rails c

<span class="c"># ユーザーモデルのインスタンスを生成</span>
&gt; <span class="nv">user</span> <span class="o">=</span> User.new
<span class="c"># avatarの設定</span>
&gt; user.avatar <span class="o">=</span> File.new<span class="o">(</span><span class="s2">"app/assets/images/①で設置した画像ファイル名"</span>, <span class="s2">"r"</span><span class="o">)</span>
<span class="c"># 設定されているか確認</span>
&gt; p user.avatar
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><strong><code>p user.avatar</code>での出力例</strong><br>
(出力したときに入力する場所が「:」となり、文字が打てなくなった人はこのステップの最後の <i class="icon attention"></i>を読んでください)</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c">#&lt;Paperclip::Attachment:0x007fca948a1c70 @name=:avatar,...(中略)</span>
@attachment_options<span class="o">=</span>
    <span class="o">{</span>:convert_options<span class="o">=</span>&gt;<span class="o">{}</span>,
     :default_style<span class="o">=</span>&gt;:original,
     :default_url<span class="o">=</span>&gt;<span class="s2">"/:attachment/:style/missing.png"</span>,
     :escape_url<span class="o">=</span>&gt;true,
     :restricted_characters<span class="o">=</span>&gt;/<span class="o">[</span><span class="p">&amp;</span><span class="nv">$+</span>,<span class="se">\\</span>/:<span class="p">;</span><span class="o">=</span>?@&lt;&gt;<span class="se">\\</span><span class="o">[</span><span class="se">\\</span><span class="o">]</span><span class="se">\\</span><span class="o">{</span><span class="se">\\</span><span class="o">}</span><span class="se">\\</span><span class="p">|</span><span class="se">\\\\\\</span>^~%# <span class="o">]</span>/,
     :filename_cleaner<span class="o">=</span>&gt;nil,
     :hash_data<span class="o">=</span>&gt;<span class="s2">":class/:attachment/:id/:style/:updated_at"</span>,
     :hash_digest<span class="o">=</span>&gt;<span class="s2">"SHA1"</span>,
     :interpolator<span class="o">=</span>&gt;Paperclip::Interpolations,
     :only_process<span class="o">=</span>&gt;<span class="o">[]</span>,
     :path<span class="o">=</span>&gt;<span class="s2">":rails_root/public:url"</span>,
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">avatarの設定のときに出てきた<code>File.new("app/assets/images/画像ファイル名", "r")</code>は、画像データを生成するためのものです。File.newで設定するパスは以下のディレクトリに入れた画像を指し示します。</p>

<ul class="filetree ng-scope">
<li class="t-folder">
mooovi
<ul>
<li class="t-folder"> apps
  <ul>
    <li class="t-folder"> assets
      <ul>
        <li class="t-folder"> images</li>
          <ul>
          <li class="t-file"> 画像ファイル </li>
          </ul>
      </ul>
    </li>
  </ul>
</li>
</ul>

<p></p>
</li>
<br>
</ul>

<p class="ng-scope">例えば画像ファイル<strong>sample.png</strong>をapp/assets/images/に入れ、その画像をavatarに設定したい場合は以下のように書きます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>user.avatar <span class="o">=</span> File.new<span class="o">(</span><span class="s2">"app/assets/images/sample.png"</span>, <span class="s2">"r"</span><span class="o">)</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<ul class="filetree ng-scope">
<li class="t-folder">
mooovi
<ul>
<li class="t-folder"> apps
  <ul>
    <li class="t-folder"> assets
      <ul>
        <li class="t-folder"> images</li>
          <ul>
          <li class="t-file"> sample.png</li>
          </ul>
      </ul>
    </li>
  </ul>
</li>
</ul>

<p></p>
</li>
<br>
</ul>

<p class="ng-scope"><code>p user.avatar</code>として、上の例のような出力が表示されれば成功です。１つ注意ですが、<strong>このuserはsaveできません。</strong>deviseによってパスワードとメールアドレスを設定していないとsaveできないようにバリデーションが設定されているためです。</p>

<p class="ng-scope"><i class="icon attention"></i> <code>p user.avatar</code>すると非常に長い出力結果がでます。このときターミナルの一番下の入力する場所に<strong>:</strong>と表示されてrailsのコードや文字が打てなくなることがあります。</p>

<p class="ng-scope"><strong>出力が非常に長いとき</strong></p>

<p class="ng-scope"><img src="33.png" alt="ターミナル"></p>

<p class="ng-scope">このときは<strong>q</strong>と打ち込みましょう。「:」が消えて元の画面に戻ったと思います。これはターミナルが<strong>vi</strong>と呼ばれるエディタのモードに切り替わったためです。興味のある方はvi、またはviコマンドで検索してみてください。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="422" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-582" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-582" name="check-582" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">Userモデルに画像をアップロードして<code>avatar</code>を設定できるようになった。</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="423" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-583" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-583" name="check-583" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text"><strong>has_attached_file</strong>で画像用のカラムのサイズやデフォルト画像、画像ファイルの保存先を設定できる</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-584" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-584" name="check-584" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text"><strong>validates_attachment_content_type</strong>で画像のバリデーションを設定できる</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 id="26" class="ng-scope">STEP6：サインアップ画面でニックネームと画像を設定できるようにしよう</h1>

<p class="ng-scope">paperclipによってユーザーのアイコン画像のアップロードが可能となったのでサインアップ画面でアイコン画像の設定をするビューをつくりましょう。さらにユーザーの<strong>ニックネーム</strong>もサインアップ画面で設定できるようにしましょう。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">１.usersテーブルにニックネームカラムを追加する</h5>

<h5 class="ng-scope">2.ビューを追加する</h5>

<h5 class="ng-scope">3.ストロングパラメーターを追加する</h5>

<h5 class="ng-scope">4.バリデーションを設定する</h5>

<h2 id="27" class="ng-scope">1.usersテーブルにニックネームカラムを追加する</h2>

<p class="ng-scope">ニックネームのカラムがまだUsersテーブルにはありませんでした。マイグレーションファイルを生成してニックネーム用のカラム<code>nickname</code>を追加しましょう。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題5：usersテーブルにnicknameカラムを追加しましょう</h3>
  <div class="challenge_box">
    <h5>ヒント①：rails g migrationコマンドを使いましょう</h5>
    <h5>ヒント②：Sequel Proでカラムが作成されたか確認しましょう</h5>

    <curriculum-question-container class="ng-scope" data-order="5"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<h2 id="28" class="ng-scope">2.ビューを追加する</h2>

<p class="ng-scope">カラムが追加できたので、続いてサインアップ画面にニックネームを入力するフォームとアイコン画像をアップロードできるフォームを作りましょう。完成すると、以下のような形です。</p>

<p class="ng-scope"><strong>サインアップ画面</strong></p>

<p class="ng-scope"><img src="35.png" alt="サインアップ画面"></p>

<p class="ng-scope">サインアップ画面はRailsの<strong>form_for</strong>メソッドを使って記述されています。<br>
ニックネームは<strong>テキストフィールド</strong>、アイコン画像には<strong>ファイルフィールド</strong>と呼ばれるファイルのアップロード用のフィールドを生成します。<br>
テキストフィールドは<code>text_field</code>、ファイルフィールドは<code>file_field</code>のフォームタグを利用することで生成できます。また、カラム名の指定も忘れずにしましょう。</p>

<h3 class="ng-scope">【例】</h3>

<ul class="ng-scope">
<li>テキストフィールドの生成</li>
</ul>

<div class="code-frame ng-scope" data-lang="rhtml"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="p">:</span><span class="err">カラム名</span> <span class="cp">%&gt;</span>
</pre></div>
</td>
</tr></tbody></table></div>

<ul class="ng-scope">
<li>ファイルフィールドの生成</li>
</ul>

<div class="code-frame ng-scope" data-lang="rhtml"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="p">:</span><span class="err">カラム名</span> <span class="cp">%&gt;</span>
</pre></div>
</td>
</tr></tbody></table></div>

<h3 class="ng-scope">
<i class="icon pen"></i> app/views/devise/registrations/new.html.erbを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="rhtml"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"bgcolor-white pt1em pb1em"</span> <span class="na">id=</span><span class="s">"contents"</span><span class="nt">&gt;</span>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form_box"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h2&gt;</span>mooovi<span class="nt">&lt;span&gt;</span>新規登録<span class="nt">&lt;/span&gt;&lt;/h2&gt;</span>

        <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="n">resource_name</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">registration_path</span><span class="p">(</span><span class="n">resource_name</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">devise_error_messages!</span> <span class="cp">%&gt;</span>

          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">autofocus</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:placeholder</span> <span class="o">=&gt;</span> <span class="s1">'メールアドレスを入力'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>

          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span> <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@validatable</span> <span class="cp">%&gt;</span><span class="nt">&lt;i&gt;</span>(<span class="cp">&lt;%=</span> <span class="vi">@minimum_password_length</span> <span class="cp">%&gt;</span> characters minimum)<span class="nt">&lt;/i&gt;</span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">autocomplete</span><span class="p">:</span> <span class="s2">"off"</span><span class="p">,</span> <span class="ss">:placeholder</span> <span class="o">=&gt;</span> <span class="s1">'パスワードを入力'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>

          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">autocomplete</span><span class="p">:</span> <span class="s2">"off"</span><span class="p">,</span> <span class="ss">:placeholder</span> <span class="o">=&gt;</span> <span class="s1">'パスワードを入力（確認）'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>

<span class="hll">          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:nickname</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</span><span class="hll">          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:nickname</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
</span><span class="hll">          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
</span><span class="hll">          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="ss">:avatar</span> <span class="cp">%&gt;</span>
</span><span class="hll">          <span class="nt">&lt;/div&gt;</span>
</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/div&gt;&lt;/div&gt;</span>

          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"more_link_box"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;strong&gt;</span>すでにアカウントを持っていますか？<span class="nt">&lt;/strong&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s2">"devise/shared/links"</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="425" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-585" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-585" name="check-585" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">Usersテーブルにnicknameカラムが追加できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-586" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-586" name="check-586" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">サインアップ画面にニックネーム入力用のテキストフィールドを追加できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-587" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-587" name="check-587" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">サインアップ画面にアイコン画像用のファイルフィールドを追加できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="29" class="ng-scope">3.ストロングパラメーターを追加する</h2>

<p class="ng-scope">しかし、今のままニックネームを入力とアイコン画像をアップロードしてユーザーの作成ボタンを押すと、<strong>nicknameとavatarが設定されません。</strong>これはdeviseで設定されているstrong_parametersによってnicknameとavatarのパラメータがはじかれているからです。</p>

<p class="ng-scope">そこで、deviseのstrong_parametersに新しく許可するパラメータを追加する必要があります。deviseではそのためのメソッド<code>devise_parameter_sanitizer</code>が用意されています。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_421"></i> devise_parameter_sanitizer</h3>

<p class="ng-scope">devise_parameter_sanitizerメソッドを使うとdeviseで設定されているstrong_parametersに対してパラメータを追加することができます。具体的な使い方は以下です。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">devise_parameter_sanitizer</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="err">追加したいメソッドの種類</span><span class="p">)</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="err">追加したいパラメータ名</span><span class="p">)</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">devise_parameter_sanitizerメソッドで指定する引数は2種類あります。1つ目が「StrongParametersを追加したい処理の種類」です。</p>

<table class="ng-scope">
<thead>
<tr>
<th style="text-align: center;">引数の値</th>
<th style="text-align: center;">処理</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">:sign_up</td>
<td style="text-align: center;">新規登録時</td>
</tr>
<tr>
<td style="text-align: center;">:sign_in</td>
<td style="text-align: center;">ログイン時</td>
</tr>
<tr>
<td style="text-align: center;">:account_update</td>
<td style="text-align: center;">モデルの更新時</td>
</tr>
</tbody>
</table>

<p class="ng-scope"><br></p>

<p class="ng-scope">新規登録時にStrongParametersを追加したい場合は1つ目の引数に<code>:sign_up</code>、ログイン時なら<code>:sign_in</code>、モデルの更新時には<code>:account_update</code>を渡します。</p>

<p class="ng-scope">2つ目の引数には追加したいパラメータ名を渡します。複数のパラメータを送る場合は,(カンマ)区切りで渡します。</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">devise_parameter_sanitizer</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="err">追加したいメソッドの種類</span><span class="p">)</span><span class="o">.</span><span class="n">push</span><span class="p">(:</span><span class="err">パラメータ</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="err">パラメータ</span><span class="mi">2</span><span class="p">,</span><span class="o">.</span><span class="n">.</span><span class="p">)</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">例えば、<strong>モデルの更新時</strong>に<strong>name</strong>と<strong>age</strong>というパラメータをstrong_parametersに追加したいとします。すると以下のように書けます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="n">devise_parameter_sanitizer</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="ss">:account_update</span><span class="p">)</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:age</span><span class="p">)</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">まず、一番目の引数に<code>:account_update</code>を指定しています。これは<strong>モデルの更新時</strong>のstrong_parametersに新しくパラメータを追加するという意味です。<br>
二番目の引数には<code>:name</code>と<code>:age</code>を指定します。これで、nameとageという2つのパラメータを追加できるようになります。</p>

<p class="ng-scope">これを利用して、<strong>nickname</strong>と<strong>avatar</strong>のパラメータをサインアップのアクションのときにstrong_parametersに追加しましょう。</p>

<p class="ng-scope"><br></p>

<p class="ng-scope">また、<code>devise_parameter_sanitizer</code>メソッドは<strong>before_actionに設定します。</strong>これはdeviseの処理であるので、記述するのはDeviseのコントローラを継承したコントローラかもしくはApplicationControllerです。<br>
しかし今回Deviseのコントローラを継承したコントローラは作成していないので<strong>ApplicationController</strong>に記述しましょう。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">application_controller.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">before_action</span> <span class="p">:</span><span class="err">メソッド名</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">ここで、<code>devise_parameter_sanitizer</code>メソッドを<strong>直接before_actionに記述してはいけません。</strong>devise_parameter_sanitizerを呼び出すためのメソッドを作成してそのメソッドを呼び出すようにしましょう。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">application_controller.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">before_action</span> <span class="ss">:configure_permitted_parameters</span>

  <span class="k">def</span> <span class="nf">configure_permitted_parameters</span>
    <span class="c1"># devise_parameter_sanitizerメソッドを呼び出す</span>
  <span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">さらにこのままではエラーが起きてしまいます。すべてのコントローラがApplicationControllerを継承しています。すなわち、この記述ではすべてのコントローラのアクションの前で<code>devise_parameter_sanitizer</code>メソッドが呼び出されます。<br>
実は、<code>devise_parameter_sanitizer</code>メソッドはdeviseで追加されたメソッドなので、<strong>Deviseのコントローラ以外で呼び出すことができません。</strong>よって、before_actionを適応するコントローラを指定します。</p>

<p class="ng-scope">before_actionでは<code>if</code>というオプションを指定することができます。これはbefore_actionを呼び出す条件を指定するものです。今回はコントローラの種類を指定するので以下のように書きます。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">application_controller.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">before_action</span> <span class="p">:</span><span class="err">メソッド名</span><span class="p">,</span> <span class="k">if</span><span class="p">:</span> <span class="p">:</span><span class="err">コントローラ名</span><span class="p">?</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題6：user登録時のストロングパラメーターを追加しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：app/controllers/application_controller.rb</h5>
    <h5>ヒント①：サインアップ時に、nicknmameとavatarというキーを許可するよう、追記してください。</h5>
    <h5>ヒント②：deviseのコントローラーにあるアクションが動いた時のみ、before_actionが動くよう書いてください。</h5>
【例】
        
     <div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/controllers/application_controller.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>

  <span class="c1"># Prevent CSRF attacks by raising an exception.</span>
  <span class="c1"># For APIs, you may want to use :null_session instead.</span>
  <span class="n">devise</span><span class="err">コントローラーのアクションが動いた時のみ、</span><span class="n">configure_permitted_parameters</span><span class="err">を動かす処理を書く</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:exception</span>

  <span class="k">def</span> <span class="nf">configure_permitted_parameters</span>
    <span class="n">devise_parameter_sanitizer</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="err">ストロングパラメーターを追加するアクション</span><span class="p">)</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="err">追加したいキー</span><span class="p">)</span>
  <span class="k">end</span>
 
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>
    <curriculum-question-container class="ng-scope" data-order="6"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">実際に、ユーザーのニックネームと画像を設定してみましょう。</p>

<p class="ng-scope">新規登録画面でニックネームとアバター画像を含む、すべての情報を入力して登録しましょう。</p>

<p class="ng-scope"><img src="25e61c3ace9dbc91669185b15c7d2964.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//25e61c3ace9dbc91669185b15c7d2964.png"></p>

<p class="ng-scope">新規登録したら、Sequal proでusersの情報を確認してみましょう。</p>

<p class="ng-scope"><img src="6f373313841e5de3cf921132e18bb1eb.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//6f373313841e5de3cf921132e18bb1eb.png"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="426" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-588" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-588" name="check-588" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">サインアップ画面でニックネームと画像を設定できるようになった</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="427" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-589" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-589" name="check-589" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text"><strong>devise＿parameter＿sanitizerメソッド</strong>を使うとdeviseで設定されているstrong_parametersにパラメータを追加できる</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="30" class="ng-scope">4.バリデーションを設定する</h2>

<p class="ng-scope">現在の状態ではパスワードとIDさえ入力していればサインアップできます。しかしニックネームも必須の入力項目にしたいです。そこでニックネームが入力されていなければエラーを返すように<strong>バリデーション</strong>を設定しましょう。</p>

<p class="ng-scope">さらにニックネームが必須項目であることを知らせるために以下のように<strong>テキストフィールドにプレイスホルダー</strong>を設定しましょう。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_422"></i> validation(検証)</h3>

<p class="ng-scope"><code>validation</code>とは、入力フォームを通じてビューからサーバー側へパラメーターが送られてきた際、正常な値か検証することができる機能です。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_423"></i> validates :カラム名, presence: true</h3>

<p class="ng-scope">フォームの中身があるかないかを検出し、無い場合は保存を実行せず元のビューにリダイレクトします。</p>

<p class="ng-scope">例えば、userのemailを入力必須にしたい場合、以下のように書くことができます。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">user.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">    <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">この状態でユーザーの新規登録時にemailを入力しなかった場合、以下のようなエラーが表示され、userを登録することができなくなります。</p>

<p class="ng-scope"><strong>ニックネームを入力しなかった場合</strong></p>

<p class="ng-scope"><img src="37.png" alt="バリデーション"></p>

<h3 class="ng-scope">
<i class="icon information" id="term_424"></i>placeholder: ''</h3>

<p class="ng-scope">フォームの中に、<code>''</code>で囲んだ文字をフォームの値が空の時に薄く表示しておくことができます。userが何を入力すれば良いかわかりやすくするためです。text_fieldメソッドのオプションとして、以下のように利用します。</p>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">sample.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="err">&lt;</span>%= f.text_field :nickname, placeholder: 'ニックネームを入力（必須）' %&gt;
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">すると、ブラウザ上では以下のように表示されます。</p>

<p class="ng-scope"><img src="36.png" alt="プレイスホルダーの設定"></p>

<p class="ng-scope">早速、バリデーションとプレースホルダーを実装してみましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/models/user.rbに以下を追記しましょう</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">user.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">    <span class="n">validates</span> <span class="ss">:nickname</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i>app/views/devise/registrations/new.html.erbを、以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="rhtml">
<div class="code-lang"><span class="bold">new.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"bgcolor-white pt1em pb1em"</span> <span class="na">id=</span><span class="s">"contents"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form_box"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h2&gt;</span>mooovi<span class="nt">&lt;span&gt;</span>新規登録<span class="nt">&lt;/span&gt;&lt;/h2&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="n">resource_name</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">registration_path</span><span class="p">(</span><span class="n">resource_name</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">devise_error_messages!</span> <span class="cp">%&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">autofocus</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s1">'メールアドレスを入力'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span> <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@validatable</span> <span class="cp">%&gt;</span><span class="nt">&lt;i&gt;</span>(<span class="cp">&lt;%=</span> <span class="vi">@minimum_password_length</span> <span class="cp">%&gt;</span> characters minimum)<span class="nt">&lt;/i&gt;</span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">autocomplete</span><span class="p">:</span> <span class="s2">"off"</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s1">'パスワードを入力'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">autocomplete</span><span class="p">:</span> <span class="s2">"off"</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s1">'パスワードを入力（確認）'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:nickname</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="hll">            <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:nickname</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s1">'ニックネームを入力(必須)'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
</span>            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="ss">:avatar</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/div&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"more_link_box"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;strong&gt;</span>すでにアカウントを持っていますか？<span class="nt">&lt;/strong&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s2">"devise/shared/links"</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">実装できたら、実際にプレースホルダーが表示される確認してみましょう。</p>

<p class="ng-scope"><img src="7cd5c7ad844a3308c50d1dfa726d42f2.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//7cd5c7ad844a3308c50d1dfa726d42f2.png"></p>

<p class="ng-scope">また、nicknameを入力せずにuserの新規登録を行おうとするとエラーが出るか確かめましょう。</p>

<p class="ng-scope"><img src="97d70a5a1ee9aa943f891c19080461ab.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//97d70a5a1ee9aa943f891c19080461ab.png"></p>

<p class="ng-scope"><img src="a6d01fc0e3c91b9a2d01bf4fb363aa9e.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//a6d01fc0e3c91b9a2d01bf4fb363aa9e.png"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="428" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-590" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-590" name="check-590" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ニックネームを設定してないときはエラーを出すようにした</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-591" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-591" name="check-591" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ニックネームの入力欄にプレイスホルダーを設定できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 id="31" class="ng-scope">STEP7：アソシエーションを利用しよう</h1>

<p class="ng-scope">レビューの保存時に「誰が書いたレビューなのか」という情報を保存できるようにします。また、レビューの表示時にレビューを書いた人のnicknameを表示できるよう実装しましょう。そして、レビューの投稿画面の方のニックネームの入力欄は消してしまいましょう。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.ニックネームの入力欄を消す</h5>

<h5 class="ng-scope">2.userモデルとreviewモデルの間にアソシエーションを設定する</h5>

<h2 id="32" class="ng-scope">1.ニックネームの入力欄を消す</h2>

<p class="ng-scope">現在、以下のようにレビューの投稿画面にはニックネームを入力するテキストフィールドがあります。</p>

<p class="ng-scope"><img src="38.png" alt="投稿画面"></p>

<p class="ng-scope">レビューを投稿するユーザーのニックネームはサインアップの段階ですでに設定済みなのでこのテキストフィールドは不要ですね。消してしまいましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/views/reviews/new.html.erbを編集し、不要なフォームを削除しましょう</h3>

<p class="ng-scope"><strong>削除前</strong></p>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">new.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"yjGuid"</span><span class="nt">&gt;&lt;a</span> <span class="na">id=</span><span class="s">"yjContentsStart"</span> <span class="na">name=</span><span class="s">"yjContentsStart"</span><span class="nt">&gt;&lt;/a&gt;&lt;img</span> <span class="na">alt=</span><span class="s">"ここから本文です"</span> <span class="na">height=</span><span class="s">"1"</span> <span class="na">src=</span><span class="s">"http://i.yimg.jp/yui/jp/tmpl/1.1.0/audionav.gif"</span> <span class="na">width=</span><span class="s">"1"</span><span class="nt">&gt;&lt;/span&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjMain"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">"section"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"header header--section"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"text-middle"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-movie color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>投稿
              <span class="nt">&lt;/h2&gt;</span>
            <span class="nt">&lt;/header&gt;</span>
            <span class="nt">&lt;div&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"listview js-lazy-load-images"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">style=</span><span class="s">"margin-bottom: 15px"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"listview__element--right-icon"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box"</span><span class="nt">&gt;</span>
                      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box__cell w80"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail thumbnail--photo"</span><span class="nt">&gt;</span>
                          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__figure"</span> <span class="na">style=</span><span class="s">"background-image: url(&lt;%= @product.image_url %&gt;);"</span><span class="nt">&gt;&lt;/div&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>
                      <span class="nt">&lt;/div&gt;</span>
                      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box__cell pl1em"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"text-middle text-break color-sub"</span><span class="nt">&gt;</span>
                          <span class="err">&lt;</span>%= @product.title %&gt;
                        <span class="nt">&lt;/h3&gt;</span>
                        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-xsmall"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;/p&gt;</span>
                        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-xsmall opacity-60"</span><span class="nt">&gt;&lt;/p&gt;</span>
                      <span class="nt">&lt;/div&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                  <span class="nt">&lt;/a&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          <span class="err">&lt;</span>%= form_for [@product, @review] do |f| %&gt;
<span class="hll">          <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin: 8px 0"</span><span class="nt">&gt;</span>
</span><span class="hll">            <span class="err">&lt;</span>%= f.label :nickname, style: { 'margin-right' =&gt; 8 } %&gt;
</span><span class="hll">            <span class="err">&lt;</span>%= f.text_field :nickname, placeholder: 'nickname', value: '' %&gt;
</span><span class="hll">          <span class="nt">&lt;/div&gt;</span>
</span>          <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin: 8px 0"</span><span class="nt">&gt;</span>
            <span class="err">&lt;</span>%= f.label :評価, style: { 'margin-right' =&gt; 8 } %&gt;
            <span class="err">&lt;</span>%= f.number_field :rate, placeholder: '評価', value: 1, max: 10, min: 1, html: { class: "search__query", style: 'text-align: right;' } %&gt;
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin: 8px 0"</span><span class="nt">&gt;</span>
            <span class="err">&lt;</span>%= f.text_area :review, placeholder: 'レビューを書いてね！', style: 'width: 100%;height: 300px;' %&gt;
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col10 push1"</span><span class="nt">&gt;</span>
              <span class="err">&lt;</span>%= button_tag type: "submit", class: "btn btn--block" do %&gt;
              投稿する<span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-arrow-right"</span><span class="nt">&gt;&lt;/i&gt;</span>
              <span class="err">&lt;</span>% end %&gt;
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          <span class="err">&lt;</span>% end %&gt;
        <span class="nt">&lt;/article&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjSub"</span><span class="nt">&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><strong>削除後</strong></p>

<div class="code-frame ng-scope" data-lang="rhtml">
<div class="code-lang"><span class="bold">new.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"yjGuid"</span><span class="nt">&gt;&lt;a</span> <span class="na">id=</span><span class="s">"yjContentsStart"</span> <span class="na">name=</span><span class="s">"yjContentsStart"</span><span class="nt">&gt;&lt;/a&gt;&lt;img</span> <span class="na">alt=</span><span class="s">"ここから本文です"</span> <span class="na">height=</span><span class="s">"1"</span> <span class="na">src=</span><span class="s">"http://i.yimg.jp/yui/jp/tmpl/1.1.0/audionav.gif"</span> <span class="na">width=</span><span class="s">"1"</span><span class="nt">&gt;&lt;/span&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjMain"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">"section"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"header header--section"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"text-middle"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-movie color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>投稿
              <span class="nt">&lt;/h2&gt;</span>
            <span class="nt">&lt;/header&gt;</span>
            <span class="nt">&lt;div&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"listview js-lazy-load-images"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">style=</span><span class="s">"margin-bottom: 15px"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"listview__element--right-icon"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box"</span><span class="nt">&gt;</span>
                      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box__cell w80"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail thumbnail--photo"</span><span class="nt">&gt;</span>
                          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__figure"</span> <span class="na">style=</span><span class="s">"background-image: url(</span><span class="cp">&lt;%=</span> <span class="vi">@product</span><span class="o">.</span><span class="n">image_url</span> <span class="cp">%&gt;</span><span class="s">);"</span><span class="nt">&gt;&lt;/div&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>
                      <span class="nt">&lt;/div&gt;</span>
                      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box__cell pl1em"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"text-middle text-break color-sub"</span><span class="nt">&gt;</span>
                          <span class="cp">&lt;%=</span> <span class="vi">@product</span><span class="o">.</span><span class="n">title</span> <span class="cp">%&gt;</span>
                        <span class="nt">&lt;/h3&gt;</span>
                        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-xsmall"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;/p&gt;</span>
                        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-xsmall opacity-60"</span><span class="nt">&gt;&lt;/p&gt;</span>
                      <span class="nt">&lt;/div&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                  <span class="nt">&lt;/a&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="o">[</span><span class="vi">@product</span><span class="p">,</span> <span class="vi">@review</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin: 8px 0"</span><span class="nt">&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="p">:</span><span class="err">評価</span><span class="p">,</span> <span class="ss">style</span><span class="p">:</span> <span class="p">{</span> <span class="s1">'margin-right'</span> <span class="o">=&gt;</span> <span class="mi">8</span> <span class="p">}</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">number_field</span> <span class="ss">:rate</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s1">'評価'</span><span class="p">,</span> <span class="ss">value</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">max</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="ss">min</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"search__query"</span><span class="p">,</span> <span class="ss">style</span><span class="p">:</span> <span class="s1">'text-align: right;'</span> <span class="p">}</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin: 8px 0"</span><span class="nt">&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:review</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s1">'レビューを書いてね！'</span><span class="p">,</span> <span class="ss">style</span><span class="p">:</span> <span class="s1">'width: 100%;height: 300px;'</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col10 push1"</span><span class="nt">&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">button_tag</span> <span class="ss">type</span><span class="p">:</span> <span class="s2">"submit"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn--block"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
              投稿する<span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-arrow-right"</span><span class="nt">&gt;&lt;/i&gt;</span>
              <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/article&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjSub"</span><span class="nt">&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">続いて、サインイン中のユーザーを取得してそのユーザーの<code>nickname</code>をレビューの内容・評価と一緒にReviewモデルに追加しましょう。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題7：reviewを新規投稿する際、投稿者のnicknameをreviewsテーブルに保存しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：app/controllers/reviews_controller.rb</h5>
    <h5>ヒント①：reviewを保存するメソッドの引数に、新たに保存したいカラムとその値を追加します</h5>
    <h5>ヒント②：引数の渡し方を変える必要があります</h5>
    <curriculum-question-container class="ng-scope" data-order="7"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">それでは実際に確認してみましょう。</p>

<p class="ng-scope"><img src="9e22a0a18364eaf07c93211c914e0285.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//9e22a0a18364eaf07c93211c914e0285.png"></p>

<p class="ng-scope"><img src="202e63dd4c30bac8e7b487a48a4e0d14.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//202e63dd4c30bac8e7b487a48a4e0d14.png"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="429" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-592" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-592" name="check-592" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ニックネームの入力欄を消せた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-593" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-593" name="check-593" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ニックネームをユーザーにひもづいて設定させることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="33" class="ng-scope">2.userモデルとreviewモデルの間にアソシエーションを設定する</h2>

<p class="ng-scope">先ほどの課題でnicknameをユーザーとひもづいて設定するようにしました。しかし今後、レビューとレビューを投稿したユーザーのニックネームだけでなく、アイコンも表示したくなるかもしれません。そのときにReviewsテーブルに<code>avatar</code>のカラムを追加するのはあまりよくありません。</p>

<p class="ng-scope"><img src="40.png" alt="カラムの追加"></p>

<p class="ng-scope"><strong>表示するUsersテーブルの情報が増えるたびにReviewsテーブルのカラムも増えていくためです。</strong></p>

<p class="ng-scope"><img src="41.png" alt="カラムの追加"></p>

<p class="ng-scope">基本的に、あるテーブルのカラムを他のテーブルでも使いたいときに両方にカラムを追加する方法は好ましくありません。仕様が変わってそのカラムが消えたり、名前が変わるときに両方のテーブルのカラムを変更しないといけないからです。</p>

<p class="ng-scope">このような場合は<strong>アソシエーションを設定する</strong>のが正しいやり方です。今回の場合、レビューでUsersテーブルのavatarが必要になったとしても以下のように書けるのでReviewsテーブルにavatarのカラムを追加しなくても良いためです。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="n">review</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">avatar</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope"><img src="42.png" alt="アソシエーション"></p>

<p class="ng-scope">では、レビューを投稿するときにnicknameを設定するのではなく、<strong>レビューを書いたユーザーを設定するようにしましょう。</strong></p>

<p class="ng-scope">レビューは書いたユーザーを<strong>ただ一人</strong>持っています。それに対して、ユーザーは<strong>複数</strong>のレビューを書くことが出来ます。そのため、ReviewモデルとUserモデルの間には<strong>1対多の関係</strong>があります。</p>

<p class="ng-scope"><img src="43.png" alt="ReviewモデルとUserモデルのアソシエーション"></p>

<p class="ng-scope">ReviewモデルとUserモデルの間にアソシエーションを設定できれば、Reviewモデルのnicknameカラムは不要となります。なぜなら、<strong>nicknameの情報はアソシエーションで取得できるUserモデルのインスタンスがカラムとして持っているからです。</strong></p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="n">review</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">nickname</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">nicknameカラムを消して、アソシエーションを使ってレビューを書いたユーザーのニックネームを取得できるようにしましょう。</p>

<p class="ng-scope">また、ReviewモデルとUserモデルのアソシエーションを設定するにはReviewsテーブルに<strong>user_id</strong>のカラムが必要になります。user_idのカラムがないとレビューを書いたユーザーがどのユーザーか判断することができません。</p>

<p class="ng-scope"><i class="icon attention"></i><strong>Reviewsテーブルのuser_idがNULLのものがあるとエラーが起きます。NULLの部分にUsersテーブルに存在するレコードのidを追加しましょう。</strong></p>

<p class="ng-scope">まずは、nicknameカラムを削除します。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> reviewsテーブルのnicknameカラムを削除しましょう</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c">#reviewsテーブルからnicknameカラムを削除するためのマイグレーションファイルを作成</span>
<span class="nv">$ </span>rails g migration RemoveNickNameFromReviews nickname:string
<span class="c">#マイグレーションファイルの実行</span>
<span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon newfile"></i> 新規作成されるファイル</h3>

<ul class="ng-scope">
<li>db/migrate/マイグレーションファイル</li>
</ul>

<p class="ng-scope">続いて、reviewsテーブルにuser_idカラムを追加します。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> reviewsテーブルにuser_idカラムを追加しましょう</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c">#reviewsテーブルにuser_idカラムを追加するためのマイグレーションファイルを作成</span>
<span class="nv">$ </span>rails g migration AddUserIdToReviews user_id:integer
<span class="c">#マイグレーションファイルの実行</span>
<span class="nv">$ </span>bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon newfile"></i> 新規作成されるファイル</h3>

<ul class="ng-scope">
<li>db/migrate/マイグレーションファイル</li>
</ul>

<p class="ng-scope">次に、ReviewモデルとUserモデルの間にアソシエーションを設定し、review投稿時にuserとreviewを関連付けるための情報を保存するよう実装します。そして、ビューでreviewを表示する際、関連するuserのnicknameを表示するようビューの記述を書き換えましょう。</p>

<h5 class="ng-scope">
<i class="icon attention"></i> reviewsテーブルのuser_idカラムが空ですとエラーが出ます。なので、全てのuser_idカラムに存在するユーザーのidを入れましょう。</h5>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題8：reviewとuserの間にアソシエーションを設定しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：<br>app/models/review.rb<br>app/models/user.rb<br>app/controllers/reviews_controller.rb<br>app/views/products/show.html.erb</h5>
    <h5>ヒント①：モデル間にアソシエーションを設定する記述をしましょう</h5>
    <h5>ヒント②：reviewsテーブルに「そのレビューを投稿したのは誰か」という情報を保存するカラムを追加する必要があります</h5>
    <h5>ヒント③：reviewを保存する際に、先に作ったカラムに情報を保存する実装をしましょう</h5>
    <h5>ヒント④：ビューでは、一つ一つのreviewのインスタンスから関連するuserを取得し、さらにそのuserのnicknameカラムの値を取得しましょう</h5>
    <curriculum-question-container class="ng-scope" data-order="8"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">問題8ができたら、rails cコマンドでアソシエーションが正しく設定されているか確認しましょう</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>rails c

&gt; <span class="nv">user</span> <span class="o">=</span> User.find<span class="o">(</span>ユーザーのid<span class="o">)</span>
&gt; user.reviews
<span class="c"># =&gt; userの書いたレビューの一覧が表示されるか</span>

&gt; <span class="nv">review</span> <span class="o">=</span> Review.find<span class="o">(</span>レビューのid<span class="o">)</span>
&gt; review.user
<span class="c"># =&gt; reviewを書いたユーザーが表示されるか</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="430" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-594" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-594" name="check-594" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">Reviewsテーブルのnicknameカラムを消せた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-595" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-595" name="check-595" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ReviewモデルとUserモデルの間にリレーションを設定できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-596" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-596" name="check-596" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">作品ページにあるレビューの一覧のニックネームはリレーションを使って取得できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 id="34" class="ng-scope">STEP8：マイページを実装しよう</h1>

<p class="ng-scope">最後に今まで自分の書いたレビューの一覧が見られるマイページを実装しましょう。</p>

<p class="ng-scope"><img src="34.png" alt="マイページ"></p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.マイページに遷移できるようにする</h5>

<h5 class="ng-scope">2.マイページのビューを追加する</h5>

<h5 class="ng-scope">3.ユーザーの情報を表示する</h5>

<h5 class="ng-scope">4.自分のレビューの一覧を表示する</h5>

<h2 id="35" class="ng-scope">1.マイページに遷移できるようにする</h2>

<p class="ng-scope">マイページは、userの詳細ページだということもできます。Railsの7つのアクションでは、詳細ページはshowというアクションにより呼び出します。そこで、新たにusers_controllerを作成し、<code>show</code>アクションを定義しましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> 下記のコマンドを実行し、users_controllerを作成しましょう</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c">#users_controllerを作成</span>
<span class="nv">$ </span>rails g controller users
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> 作成したapp/controllers/users_controllerにshowアクションを定義しましょう</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">users_controller</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">    <span class="k">def</span> <span class="nf">show</span>
</span><span class="hll">    <span class="k">end</span>
</span>  <span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">続いてルーティングです。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> config/routes.rbに下記を追記しましょう</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">routes.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="no">TechReviewSite</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>

  <span class="n">devise_for</span> <span class="ss">:users</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="ss">:show</span>
</span>  <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="ss">:show</span> <span class="k">do</span>
    <span class="n">resources</span> <span class="ss">:reviews</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="o">]</span>
    <span class="n">collection</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">'search'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">root</span> <span class="s1">'products#index'</span>

<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">次に、マイページに遷移するボタンを作成します。マイページに移動するボタンは以下のようにヘッダーの「投稿するボタン」と「サインアウトボタン」の間におきましょう。</p>

<p class="ng-scope"><img src="39.png" alt="マイページボタン"></p>

<p class="ng-scope">このボタンを押したときの遷移先は<a href="http://localhost:3000/users/%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%B3%E4%B8%AD%E3%81%AE%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AEid">/users/サインイン中のユーザーのid</a>です。呼ばれるアクションは、先ほど作成した<strong>UsersControllerのshowアクション</strong>です。</p>

<p class="ng-scope">また、ログインしていないのにこのマイページボタンを押されるとユーザーのidがないため困りますね。そこで<strong>ログインをしていない時にこのボタンを表示しない</strong>ようにビューに追記しましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/views/layouts/review_site.html.erbを、以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="rhtml">
<div class="code-lang"><span class="bold">review_site.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">class=</span><span class="s">"pc"</span> <span class="na">lang=</span><span class="s">"ja"</span> <span class="na">xmlns:fb=</span><span class="s">"http://ogp.me/ns/fb#"</span> <span class="na">xmlns:og=</span><span class="s">"http://ogp.me/ns#"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;title&gt;</span>映画レビューサイト<span class="nt">&lt;/title&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">'http://fonts.googleapis.com/css?family=roboto:700,300,400,600'</span> <span class="na">rel=</span><span class="s">'stylesheet'</span> <span class="na">type=</span><span class="s">'text/css'</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s2">"all"</span><span class="p">,</span> <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="s2">"data-turbolinks-track"</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/meta&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">"yj950-2"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"wrapper"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsHeader"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"globalnav"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"globalnav__menu"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"gmenu"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"logo"</span> <span class="na">style=</span><span class="s">"float: left"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>mooovi<span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
<span class="hll">              <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">user_signed_in?</span> <span class="cp">%&gt;</span>
</span><span class="hll">                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"entry_button"</span> <span class="na">style=</span><span class="s">"float: right"</span><span class="nt">&gt;</span>
</span><span class="hll">                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"サインアウト"</span><span class="p">,</span> <span class="n">destroy_user_session_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="cp">%&gt;</span>
</span><span class="hll">                <span class="nt">&lt;/li&gt;</span>
</span><span class="hll">                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"entry_button"</span> <span class="na">style=</span><span class="s">"float: right"</span><span class="nt">&gt;</span>
</span><span class="hll">                  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/users/</span><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>マイページ<span class="nt">&lt;/a&gt;</span>
</span><span class="hll">                <span class="nt">&lt;/li&gt;</span>
</span><span class="hll">              <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span>              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"entry_button"</span> <span class="na">style=</span><span class="s">"float: right"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/products/search"</span><span class="nt">&gt;</span>投稿する<span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/nav&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      #以下略
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="432" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-598" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-598" name="check-598" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ヘッダーにマイページへ遷移するボタンを作成できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-600" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-600" name="check-600" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ログインしていないときにはマイページボタンが表示されないようにできた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="36" class="ng-scope">2.マイページのビューを追加する</h2>

<p class="ng-scope">マイページに関するルーティング、コントローラの作成が出来たので、次にビューの作成をしていきましょう。</p>

<p class="ng-scope">コントローラーのアクションは、同名のビューファイルを呼び出します。今回はusers_controllerのshowアクションなので、呼び出されるのはviews/users/show.html.erbです。</p>

<p class="ng-scope"><br></p>

<p class="ng-scope">ビューファイルに関しては、先ほどダウンロードした<strong>rails2-4フォルダ</strong>にあるファイルを指定したディレクトリに追加しましょう。</p>

<p class="ng-scope">ダウンロードしたフォルダを消してしまった人は以下のリンクからもう一度ダウンロードしてください。</p>

<p class="ng-scope"><a href="http://master.tech-camp.in/filedownload/12" target="_top">rails2-4.zip</a></p>

<p class="ng-scope">追加するファイルは以下のファイルです。</p>

<ul class="ng-scope">
<li><strong>rails2-4/users/show.html.erb</strong></li>
</ul>

<h3 class="ng-scope">
<i class="icon pen"></i> ダウンロードしたrails2フォルダに入っている<code>show.html.erb</code>ファイルをviews/usersフォルダに移動しましょう</h3>

<p class="ng-scope"><strong>追加するディレクトリ(mooovi)</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> app
    <ul>
      <li class="t-folder"> views
        <ul>
          <li class="t-folder"> users
            <ul>
              <li class="t-file"> <strong>show.html.erb ←ここに追加</strong> </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope"><strong>新しく置き換えるファイル(ダウンロードしたrails2-4)</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> rails2-4
    <ul>
      <li class="t-folder"> users
        <ul>
          <li class="t-file"> <strong>show.html.erb</strong>
</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="431" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-597" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-597" name="check-597" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text"><strong>rails2-4/users/show.html.erb</strong>を指定したディレクトリに追加できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="37" class="ng-scope">3.ユーザーの情報を表示する</h2>

<p class="ng-scope">いまの状態では表示されているユーザーの情報は適当ですね。</p>

<p class="ng-scope"><img src="44.png" alt="マイページ"></p>

<p class="ng-scope">マイページなので表示する情報は自分の情報にしましょう。マイページ画面で呼ばれるアクションは<strong>UsersControllerのshowアクション</strong>なので、対応するビューは<code>app/views/users/show.html.erb</code>となります。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_425"></i> image_tag</h3>

<p class="ng-scope"><code>image_tag</code>は、htmlの<code>&lt;img&gt;</code>タグを生成するヘルパーメソッドです。以下の例のように引数に文字列で画像ファイルのパスを取ります。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="rhtml">
<div class="code-lang"><span class="bold">sample.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="s2">"image/sample.jpg"</span> <span class="cp">%&gt;</span> #=&gt; <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"image/sample.jpg"</span><span class="nt">&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題9：マイページに、ログイン中のuserの情報を表示しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：
　　　<br>app/views/users/show.html.erb</h5>
    <h5>ヒント：&lt;%= image_tag current_user.avatar %&gt;とすると、ログインしているユーザのアバターを表示することができます</h5>
    <curriculum-question-container class="ng-scope" data-order="9"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">コードを記述したら、さきほどまで適当だったユーザー情報が、自分で登録したユーザー情報になっていることを確認しましょう。</p>

<p class="ng-scope"><img src="ef9ffcf5cf0a2cd7c791301391ff37fb.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//ef9ffcf5cf0a2cd7c791301391ff37fb.png"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="433" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-601" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-601" name="check-601" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">マイページで自分の情報を表示させることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="38" class="ng-scope">4.自分のレビューの一覧表示する</h2>

<p class="ng-scope">最後に表示されているレビューも自分のレビューの情報にしましょう。</p>

<p class="ng-scope"><img src="45.png" alt="マイページ"></p>

<p class="ng-scope">自分のレビューの情報はアソシエーションを使えば取得できますね。<br>
今回も呼ばれるアクションはusers_controllerのshowアクションなので、対応するビューは<strong>app/views/users/show.html.erb</strong>となります。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題10：マイページにおいて、自分が投稿したレビューの一覧を表示しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：
　　　<br>app/views/users/show.html.erb</h5>
    <h5>ヒント：自分の書いたレビューの一覧はUserモデルとReviewモデルのアソシエーションを使って取得しましょう</h5>
    <curriculum-question-container class="ng-scope" data-order="10"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">マイページで、レビューを投稿した作品が表示されていることを確認しましょう。</p>

<p class="ng-scope"><img src="c438596bfbe3d8093036b9af65353223.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//c438596bfbe3d8093036b9af65353223.png"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="434" action="http://master.tech-camp.in/curriculums/20#">
  <h4 class="ng-binding">
    <i class="icon check_icon_02"></i>課題チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-602" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-602" name="check-602" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">マイページで自分のレビューの一覧を表示させることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="39" class="ng-scope">以上で、moooviアプリの実装は全て終了です</h2>

<p class="ng-scope">以下のリンクより、見本のソースコードをダウンロードして自分のソースコードと照らし合わせてみましょう。</p>

<p class="ng-scope"><a href="http://master.tech-camp.in/files/rails2/mooovi.zip" target="_top">mooovi.zip</a></p>

<h2 id="40" class="ng-scope">Lesson2 Gitに取り組もう</h2>

<p class="ng-scope">moooviの実装、お疲れ様でした！ここまでで、Ruby on Railsがどのようにアプリケーションとして成り立っているかの知識は大分ついたかと思います。</p>

<p class="ng-scope"><strong>この次は、次章「もう一度moooviを作成しよう」ではなく、「Lesson2 Git」に進んでください。</strong></p>

<p class="ng-scope">「Lesson2 Git」の中で、再度基本カリキュラムLesson4で取り組んだPictweetを作成していただく機会があります。多くの他の学習と同じく、プログラミングの学習においても復習はとても大切ですので、<strong>必ず取り組んでください。</strong></p>

<p class="ng-scope"><a href="http://master.tech-camp.in/curriculums/26">Lesson6 Gitの基礎を学ぼう</a></p>
</div>
          <!-- ngIf: curriculum.short_test --><div ng-if="curriculum.short_test" class="short_test-box ng-scope">
  <div class="short_test-title">
    <h4>
      確認問題
    </h4>
    <p>
      お疲れ様でした！このカリキュラムの終わりに確認問題を解きましょう。
    </p>
  </div>
  <div class="short_test_score" id="shortTestInfo"></div>
  <div class="short_test-button">
    <a class="curriculum-short-test-button" ng-click="showShortTest(curriculum.short_test.id)">確認テストに挑戦する！</a>
  </div>
</div><!-- end ngIf: curriculum.short_test -->
        </div>
      </div>
      <div class="col-md-3 col-sm-12" id="curriculumSideContainer">
        <curriculum-side-wrap id="sideWrap">
          <ul style="max-height: 295px;" class="list-group toc-tree" id="curriculumContents">
  <li class="list-group-item disabled">
    目次
  </li>
  <!-- ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding current" id="contents1" ng-click="clickContent(content.h1.id)">学習目標</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding" id="contents2" ng-click="clickContent(content.h1.id)">学習課題</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding" id="contents3" ng-click="clickContent(content.h1.id)">STEP0：作業の準備をしよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents4" ng-click="clickContent(h2.id)">ファイルをダウンロードしよう</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents5" ng-click="clickContent(h2.id)">指定のファイルを置き換えよう</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding" id="contents6" ng-click="clickContent(content.h1.id)">STEP1：レビューの評価を星として表示させよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents7" ng-click="clickContent(h2.id)">１．個別の作品ページでレビューの星を表示する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents8" ng-click="clickContent(h2.id)">２．映画一覧ページでそれぞれの映画の平均評価を取得する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents9" ng-click="clickContent(h2.id)">３．product.rbにインスタンスメソッドを定義する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding" id="contents10" ng-click="clickContent(content.h1.id)">STEP2：ランキング機能を実装しよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents11" ng-click="clickContent(h2.id)">1.before_actionを設定する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents12" ng-click="clickContent(h2.id)">2.ランキングを表示させる</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents13" ng-click="clickContent(h2.id)">3.productsテーブルから、レビュー数が多い順に5件レコードを取得する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding" id="contents14" ng-click="clickContent(content.h1.id)">STEP3：deviseを使ってユーザーのサインアップ画面をつくろう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents15" ng-click="clickContent(h2.id)">1.deviseのファイルをインストールする</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents16" ng-click="clickContent(h2.id)">2.必要なファイルを入れ替える</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents17" ng-click="clickContent(h2.id)">3.ユーザーのモデルを作成する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding" id="contents18" ng-click="clickContent(content.h1.id)">STEP4：サインアウト、ログイン機能をつけよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents19" ng-click="clickContent(h2.id)">1.サインアウトボタンを設置する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents20" ng-click="clickContent(h2.id)">2.サインアウト後のリダイレクトを設定する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents21" ng-click="clickContent(h2.id)">3.サインインしていない場合はログイン画面にリダイレクトさせる</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding" id="contents22" ng-click="clickContent(content.h1.id)">STEP5：paperclipを使って画像のアップロード機能をつけよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents23" ng-click="clickContent(h2.id)">1.paperclipをインストールする</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents24" ng-click="clickContent(h2.id)">2.usersテーブルにpaperclip用のカラムを追加する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents25" ng-click="clickContent(h2.id)">3.userモデルにpaperclipの設定を追記する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding" id="contents26" ng-click="clickContent(content.h1.id)">STEP6：サインアップ画面でニックネームと画像を設定できるようにしよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents27" ng-click="clickContent(h2.id)">1.usersテーブルにニックネームカラムを追加する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents28" ng-click="clickContent(h2.id)">2.ビューを追加する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents29" ng-click="clickContent(h2.id)">3.ストロングパラメーターを追加する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents30" ng-click="clickContent(h2.id)">4.バリデーションを設定する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding" id="contents31" ng-click="clickContent(content.h1.id)">STEP7：アソシエーションを利用しよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents32" ng-click="clickContent(h2.id)">1.ニックネームの入力欄を消す</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents33" ng-click="clickContent(h2.id)">2.userモデルとreviewモデルの間にアソシエーションを設定する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding" id="contents34" ng-click="clickContent(content.h1.id)">STEP8：マイページを実装しよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents35" ng-click="clickContent(h2.id)">1.マイページに遷移できるようにする</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents36" ng-click="clickContent(h2.id)">2.マイページのビューを追加する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents37" ng-click="clickContent(h2.id)">3.ユーザーの情報を表示する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents38" ng-click="clickContent(h2.id)">4.自分のレビューの一覧表示する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents39" ng-click="clickContent(h2.id)">以上で、moooviアプリの実装は全て終了です</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents40" ng-click="clickContent(h2.id)">Lesson2 Gitに取り組もう</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents -->
</ul>
          <div style="" ng-show="check_count > 0" class="progress_box ng-scope">
  <!-- ngIf: showTroubleShooting() --><p class="terms ng-scope" ng-if="showTroubleShooting()">
    エラーが解決できない時：<br><a href="http://master.tech-camp.in/curriculums/25" target="_brank">トラブルシューティング</a>
  </p><!-- end ngIf: showTroubleShooting() -->
  <!-- ngIf: courseId != 9 && courseId != 10 --><p class="terms ng-scope" ng-if="courseId != 9 &amp;&amp; courseId != 10">
    分からない用語がある時：<br><a href="http://master.tech-camp.in/terms" target="_brank">用語一覧集</a>
  </p><!-- end ngIf: courseId != 9 && courseId != 10 -->
  <h4>
    進捗度<i class="ng-binding" id="numerator">22 / 47<span id="denominaotr"></span></i>
  </h4>
  <div class="progress">
    <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="46.8" class="pregress-bar progress-bar-info ng-binding" role="progressbar" style="width: 46.8%;">
      46.8%
    </div>
  </div>
</div>
          <curriculum-glossary class="ng-hide" ng-show="curriculum.curriculum_type == 2 || curriculum.curriculum_type == 3"></curriculum-glossary>
          <button class="curriculum-report-button" ng-click="show_curriculum_report()">
            <img src="idea.svg" height="20px" width="20px">
            | このカリキュラムへのご要望
          </button>
        </curriculum-side-wrap>
      </div>
    </div>
    <ul style="" class="pager" ng-hide="loading">
  <li class="previous">
    <a style="" class="" ng-click="go_previous()" ng-show="curriculum.previous_id">前のカリキュラム</a>
  </li>
  <li class="next">
    <a style="" class="" ng-class="{ disable: curriculum.short_test.can_see_next_curriculum == false }" ng-click="go_next()" ng-show="curriculum.next_id">次のカリキュラム</a>
  </li>
</ul>
  </div>
</curriculum>
<div style="" class="ng-scope ng-isolate-scope ng-hide" id="loading" ng-show="loading">
  <svg height="44" stroke="#444" viewBox="0 0 44 44" width="44" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" strole-width="2"><circle cx="22" cy="22" r="1"><animate attributeName="r" begin="0s" calcMode="spline" dur="1.8s" keySplines="0.165, 0.84, 0.44, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 20"></animate><animate attributeName="stroke-opacity" begin="0s" calcMode="spline" dur="1.8s" keySplines="0.3, 0.61, 0.355, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 0"></animate></circle><circle cx="22" cy="22" r="1"><animate attributeName="r" begin="-0.9s" calcMode="spline" dur="1.8s" keySplines="0.165, 0.84, 0.44, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 20"></animate><animate attributeName="stroke-opacity" begin="-0.9s" calcMode="spline" dur="1.8s" keySplines="0.3, 0.61, 0.355, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 0"></animate></circle></g></svg>
</div>

<div class="curriculum-image__modal modal ng-scope" id="curriculum-image__modal" role="dialog" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button class="close" data-dismiss="modal" ng-click="close()"><span aria-hidden="true">×</span></button>
      </div>
      <div class="modal-body">
        <div class="curriculum-image__img__body">
          <img class="curriculum-image__img zoom-out" id="curriculum-image__img">
        </div>
      </div>
    </div>
  </div>
</div>


</div><div class="chat-window ng-scope" ng-controller="SupportChatController" ng-init="init('大宅誠人', '/uploads/noimage.png', 1867, 2988, 0, 'accepted_questions', 'machi4271', '2')"><div aria-hidden="true" aria-labelledby="myLargeModalLabel" class="modal fade" id="chats-modal" role="dialog" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="wrapper">
  <header class="chat-header">
    <div class="row">
      <div class="col-md-6 col-xs-12 chat-header-left">
        <h2>
          質問チャット
        </h2>
        <div class="chat-support-state active in-support ng-binding">質問受付中</div>
      </div>
    </div>
  </header>
  <div class="chat-layout" load-more="load-more">
    <!-- ngRepeat: message in messages -->
  </div>
</div><footer class="chat-footer"><form accept-charset="UTF-8" action="http://master.tech-camp.in/api/chat_messages" class="new_chat_message ng-pristine ng-valid" data-remote="true" enctype="multipart/form-data" id="new_chat_message" method="post" ng_submit="afterSubmitted()"><div style="display: none;"><input name="utf8" value="✓" type="hidden"></div><input id="chat_message_chat_id" name="chat_message[chat_id]" value="2988" type="hidden"><div class="chat-box"><div class="row"><div class="chat-upload col-xs-1"><div class="chat-upload-btn"><img class="chat-upload-icn" src="icn_fileupload.png"><input class="ng-pristine ng-untouched ng-valid" id="chat_message_file" name="chat_message[file]" ng_model="file" onchange="angular.element(this).scope().showSubmitButtonAndHideSkypeButtonAndPreview()" type="file"><div class="chat-uploading-image ng-hide" ng-show="isUploading" ng-style="isUploadingStyle"><div class="image_del ng-hide" ng-click="clearImage()" ng-show="imageDeletable"><img alt="close" src="icon_close_red.svg"></div></div></div></div><div class="chat-textarea col-xs-8"><textarea class="form-control ng-pristine ng-untouched ng-valid" id="chat_message_content" name="chat_message[content]" ng_model="content" placeholder="次のコードの意味がよくわからないので教えていただけないでしょうか？" row="3"></textarea></div><div class="chat-submit col-xs-3"><input style="display: none;" class="submit-btn" id="submit_chat_message" name="commit" value="送信" type="submit"><div class="skype-popup"><a title="" data-original-title="" class="trigger btn btn-default" href="#">Skypeで直接聞く</a><div class="head hide">Skype質問を申請すると<br>担当メンターから着信が届きます。<br>以下の項目をご確認ください。</div><div class="content hide"><p class="ng-binding">あなたのSkypeID:　machi4271<br>質問箇所: <small>※スマートフォン、タブレットでのSkypeはご遠慮ください<br>※通話が始まったらすぐに画面共有をお願いします</small></p><a class="skype-support" href="http://master.tech-camp.in/curriculums/20">Skype質問を申請する</a><div class="close">×</div></div></div></div></div></div></form></footer></div></div></div><div class="chat-dock" ng-click="getMessages(); showModal()">質問サポート<!-- ngIf: unreadSize != 0 --><span class="dock-support-state_text in-support ng-binding">質問受付中</span></div></div></body>
</html>
