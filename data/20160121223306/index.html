<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8"><title>ログイン機能をつくろう</title><meta content="authenticity_token" name="csrf-param">
<meta content="Y2UzkG5GQl5jzIBq3nOdxAEomQen5uuix05BO4pPfYw=" name="csrf-token"><link href="favicon.ico" rel="icon" sizes="16x16 32x32 48x48 128x128 256x256">
<link rel="stylesheet" type="text/css" href="index.css" media="all">
</head>
<body class="ng-scope" ng-app="techMaster"><div class="navbar main_header navbar-fixed-top navbar-default" role="navigation"><div class="container"><div class="navbar-header"><button aria-controls="navbar" aria-expanded="false" class="navbar-toggle collapsed" data-target="#navbar" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="http://master.tech-camp.in/" target="_self"><img src="logo.png"></a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav navbar-right"><li class="text">終了まであと<i class="limit_time">10</i>日</li><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" id="profileDropdown" style="padding: 10px 7px; cursor: pointer;"><img class="nav-proimg" src="noimage.png">大宅 誠人</a><ul class="dropdown-menu" id="profileDropdown"><li><a class="mypage-link" href="http://master.tech-camp.in/users/mypage" target="_self">マイページを見る</a></li><li><a href="http://master.tech-camp.in/users" target="_self">十三期生一覧</a></li></ul><div class="popover bottom" id="profilePopover"><div class="arrow"></div><h3 class="popover-title" id="popover-bottom">プロフィールを完成させませんか？<a class="anchorjs-link" href="#popover-bottom"><span class="anchorjs-icon"></span></a></h3><div class="popover-content">「<a href="http://master.tech-camp.in/users/1867/edit" target="_self">プロフィール編集</a>」から、必須の項目を設定しましょう！</div></div></li></ul></div></div></div><!-- ngView:  --><div class="ng-scope" autoscroll="" ng-view=""><curriculum style="display: inline;" class="ng-scope">
  <div class="container" id="curriculum">
    <div class="row curriculum-inner">
      <div class="col-lg-12 main" ng-init="init()">
        <div ng-show="curriculum.image" class="page-header page" style="background-image: url('visual_image.jpg');">
  <h1 class="ng-binding">
    Railsアプリケーション開発3 第2章<small class="ng-binding">〜ログイン機能をつくろう〜</small>
  </h1>
  <!-- ngIf: curriculum.image.description.length --><div style="" class="flickr_attr ng-binding ng-scope" ng-if="curriculum.image.description.length">
    沖縄にある、沖縄美ら海水族館。この正面のアクリルパネルは、なんと7,500m³の大水槽でジンベエザメとナンヨウマンタが泳いでいるのを多角方面から見ることができます。15時と17時に行われるジンベイザメのお食事タイムには勢いよく海水とエサを吸い込むところを見ることができます！<a class="ng-binding" href="https://www.flickr.com/photos/ogwrnsk/3571616579" target="_top">naosuke ii - IMG_1004</a>
  </div><!-- end ngIf: curriculum.image.description.length -->
</div>
      </div>
      <div class="col-md-9 col-sm-12" id="curriculumMainContainer">
        <div class="curriculum_content">
          <div class="curriculum_text ng-scope" compile-progress-notifier="willCompiledCurriculumText" ng-controller="CurriculumHintController"><h1 id="1" class="ng-scope">ログイン機能をつくろう:基本設定</h1>

<p class="ng-scope">おなじみの<a href="http://master.tech-camp.in/curriculums/16#term_211">devise</a>を使ってログイン機能をつくっていきます。<br>
今回作成するアプリケーションのProfyでは、メールアドレスの認証を実装します。<br>
これまではメールアドレスを入力さえすれば、新規登録とログインが可能でしたが、<strong>今回はサービスから送られてきた<br>
メールから認証しないとログインすることができないようにします。</strong></p>

<h2 id="2" class="ng-scope">deviseの設定ファイルを生成する</h2>

<div class="challenge ng-scope">
<h3>
<i class="icon crown"></i> 問題1：ターミナルでコマンドを実行してdeviseの設定ファイルを生成してください</h3>
<h5>作業場所：ターミナル</h5>
<h5>ヒント： profyのディレクトリに移動後に行いましょう。</h5>

<curriculum-question-container class="ng-scope" data-order="1"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
</div>

<h3 class="ng-scope">
<i class="icon newfile"></i> 新規作成されるファイル</h3>

<ul class="ng-scope">
<li>config/initializers/devise.rb</li>
<li>config/locales/devise.en.yml</li>
</ul>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="507" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-692" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-692" name="check-692" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">deviseの設定ファイルを生成することができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope">生成されたファイルについて解説します。<code>config/initializers</code>はrailsを起動したときに読み込まれる設定ファイルを置きます。</p>

<table class="wide ng-scope">
  <tbody><tr>
    <th>ファイル名</th>
    <th>役割</th>
  </tr>
  <tr>
    <td>config/initializers/devise.rb</td>
    <td>deviseに関する設定が記述されています。初期設定からカスタマイズする際に編集します。</td>
  </tr>
  <tr>
    <td>config/locales/devise.en.yml</td>
    <td>バリデーション時エラーメッセージなどが設定されています。デフォルトでは全て英語になっています。</td>
  </tr>
</tbody></table>

<p class="ng-scope"><br><br>
<code>rails g devise:install</code>を実行すると、以下のような英文のメッセージが表示されている思います。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="o">===============================================================================</span>

  Some setup you must <span class="k">do</span> manually <span class="k">if</span> you haven<span class="s1">'t yet:</span>

<span class="s1">    1. Ensure you have defined default url options in your environments files. Here</span>
<span class="s1">       is an example of default_url_options appropriate for a development environment</span>
<span class="s1">       in config/environments/development.rb:</span>

<span class="s1">         config.action_mailer.default_url_options = { host: '</span>localhost<span class="err">'</span>, port: <span class="m">3000</span> <span class="o">}</span>

       In production, :host should be <span class="nb">set </span>to the actual host of your application.

    2. Ensure you have defined root_url to *something* in your config/routes.rb.
       For example:

         root to: <span class="s2">"home#index"</span>

    3. Ensure you have flash messages in app/views/layouts/application.html.erb.
       For example:

         &lt;p <span class="nv">class</span><span class="o">=</span><span class="s2">"notice"</span>&gt;&lt;%<span class="o">=</span> notice %&gt;&lt;/p&gt;
         &lt;p <span class="nv">class</span><span class="o">=</span><span class="s2">"alert"</span>&gt;&lt;%<span class="o">=</span> alert %&gt;&lt;/p&gt;

    4. If you are deploying on Heroku with Rails 3.2 only, you may want to <span class="nb">set</span>:

         config.assets.initialize_on_precompile <span class="o">=</span> <span class="nb">false</span>

<span class="nb">       </span>On config/application.rb forcing your application to not access the DB
       or load models when precompiling your assets.

    5. You can copy Devise views <span class="o">(</span><span class="k">for</span> customization<span class="o">)</span> to your app by running:

         rails g devise:views

  <span class="o">===============================================================================</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">こちらには、手動で行うべき設定が表示されています。１〜５の手順にそって設定をしていきましょう。</p>

<h2 id="3" class="ng-scope">認証メールのURLを設定する</h2>

<h3 class="ng-scope">
<i class="icon pen"></i> config/environments/development.rbを以下のように編集してください。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">config/environments/development.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>41</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="s1">'localhost'</span><span class="p">,</span> <span class="ss">port</span><span class="p">:</span> <span class="mi">3000</span> <span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">ユーザーの新規登録などで認証メールを送った際に文中にある認証リンクのURLを設定します。<br>
ローカルで開発する際のURLは、localhost:3000なので上記のような設定になります。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="508" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-693" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-693" name="check-693" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">config/environments/development.rbに認証メールのURLを設定することができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="513" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-703" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-703" name="check-703" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">devise.rbとdevise.en.ymlについて理解できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="4" class="ng-scope">ルートパスを設定する</h2>

<p class="ng-scope">今回のアプリケーションではtop_controllerのindexアクションをルートパスに設定します。</p>

<div class="challenge ng-scope">
<h3>
<i class="icon crown"></i> 問題2：top_controllerのindexアクションをルートパスに設定してください。</h3>
<h5>作業ファイル：config/routes.rb</h5>
<h5>ヒント： rootを使用しましょう。</h5>


<curriculum-question-container class="ng-scope" data-order="2"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
</div>

<p class="ng-scope">まだ、top_controllerは作成していないので<code>rails s</code>でlocalhost:3000にアクセスしても以下のようにエラーになります。</p>

<p class="ng-scope"><img src="uninitialize_constant_topcontroller.png" alt="uninitialize_constant_topcontroller"></p>

<p class="ng-scope">top_cotrollerを作成していきましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> ターミナルでコマンドを実行してtop_cotrollerを作成してください。</h3>

<div class="challenge ng-scope">
<h3>
<i class="icon crown"></i> 問題3：top_cotrollerを作成し、indexアクションを設定してください。</h3>
<h5>作業ファイル：app/controllers/top_controller.rb</h5>
<h5>ヒント①：controllerの作成は「rails g」コマンドで行いましょう。</h5>
<h5>ヒント②：indexアクションは 「def ~ end」  で定義しましょう。</h5>

<curriculum-question-container class="ng-scope" data-order="3"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>app/views/top/</code>以下にindex.html.erbを新規作成して置いてください。</h3>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="509" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-694" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-694" name="check-694" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">config/routes.rbにroot to: "top#index"を追記することができた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-695" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-695" name="check-695" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">top_controllerを作成することができた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-696" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-696" name="check-696" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">top_controller.rbにindexアクションを追加することができた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-697" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-697" name="check-697" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">app/views/top/以下にindex.html.erbを追加することができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="5" class="ng-scope">フラッシュメッセージのタグをビューに埋め込む</h2>

<p class="ng-scope">rails g devise:installを実行時に表示された先ほどの以下のメッセージについて解説します。</p>

<div class="code-frame ng-scope" data-lang="html"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre>  3. Ensure you have flash messages in app/views/layouts/application.html.erb.
     For example:
       <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"notice"</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= notice %&gt;<span class="nt">&lt;/p&gt;</span>
       <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"alert"</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= alert %&gt;<span class="nt">&lt;/p&gt;</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope"><code>&lt;%= notice %&gt;</code> や <code>&lt;%= alert %&gt;</code> はフラッシュメッセージと呼ばれるものです。<br>
これらをすべてのビューで共通のレイアウトファイルである<code>app/views/layouts/application.html.erb</code>に追記するようにと言われています。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_490"></i> フラッシュメッセージ</h3>

<p class="ng-scope">フラッシュメッセージはログイン時の「ようこそ」という一時的に出すメッセージや、フォーム送信時の入力エラーなど、ユーザに簡単な通知を行いたい時に利用します。<br>
詳しくは<a href="http://ruby-rails.hatenadiary.com/entry/20141127/1417086075">こちらのブログ</a>を参考にしてください。</p>

<p class="ng-scope">今回の場合はdeviseが自動で表示してくれるフラッシュメッセージを表示するためにレイアウトファイルに、フラッシュメッセージ用のタグを書いていきます。<br>
通常は、<code>&lt;%= notice %&gt;</code>、<code>&lt;%= alert %&gt;</code>こちらを追記するのですが、今回はtwitter-bootstrap-railsというCSSフレームワークのgemを利用しているため、ビューヘルパーの<code>&lt;%= bootstrap_flash %&gt;</code>と記述します。</p>

<p class="ng-scope">今は<code>&lt;%= bootstrap_flash %&gt;</code>と書くことで「ログインに成功しました」「ログアウトしました」といったようなdevise が準備しているメッセージが表示できるようになったとイメージできれば大丈夫です。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/views/layouts/application.html.erbの中身を一度全て削除し、以下のように編集してください。</h3>

<div class="code-frame ng-scope" data-lang="rhtml">
<div class="code-lang"><span class="bold">app/views/layouts/application.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">'ja'</span><span class="nt">&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;head&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">'utf-8'</span><span class="nt">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">'X-UA-Compatible'</span> <span class="na">content=</span><span class="s">'IE=Edge,chrome=1'</span><span class="nt">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">'viewport'</span> <span class="na">content=</span><span class="s">'width=device-width, initial-scale=1.0'</span><span class="nt">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;title&gt;</span>Profy<span class="nt">&lt;/title&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span><span class="err">&nbsp;&nbsp;&nbsp;</span> <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="s1">'data-turbolinks-track'</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="cp">%&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;/head&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">'text/javascript'</span> <span class="na">charset=</span><span class="s">'utf-8'</span><span class="nt">&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="hll">&nbsp;&nbsp;&nbsp;&nbsp;<span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial</span><span class="p">:</span> <span class="s1">'common/header'</span> <span class="cp">%&gt;</span>
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'container'</span><span class="nt">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'row'</span><span class="nt">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'col-lg-12'</span><span class="nt">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cp">&lt;%=</span> <span class="n">bootstrap_flash</span> <span class="cp">%&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;/div&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;/div&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">'row text-center'</span><span class="nt">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;p&gt;</span>(C) Profy 2015<span class="nt">&lt;/p&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;/footer&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;/div&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">18行目の <code>&lt;%= render partial: 'common/header' %&gt;</code> はcommonディレクトリ配下の_header.html.erbの部分テンプレートを呼び出すことを意味しています。</p>

<p class="ng-scope">ここでは、ヘッダー部分の部分テンプレートを読み込んでいるので、この設定に必要なファイルを設置しましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/views/以下にcommonフォルダを作成してください。</h3>

<ul class="filetree ng-scope">
  <li class="t-folder"> app
    <ul>
      <li class="t-folder"> views
        <ul>
          <li class="t-folder"> common
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 class="ng-scope">
<i class="icon pen"></i> app/views/common/以下に_header.html.erbファイルを作成して以下の内容を記述してください。</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">app/views/common/_header.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="err">&lt;</span>% if user_signed_in? %&gt;
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'navbar navbar-default navbar-fixed-top'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'container'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">'button'</span> <span class="na">class=</span><span class="s">'navbar-toggle'</span> <span class="na">data-toggle=</span><span class="s">'collapse'</span> <span class="na">data-target=</span><span class="s">'.navbar-responsive-collapse'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">'icon-bar'</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">'icon-bar'</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">'icon-bar'</span><span class="nt">&gt;&lt;/span&gt;</span>
      <span class="nt">&lt;/button&gt;</span>
      <span class="err">&lt;</span>%= link_to root_path, :class =&gt; 'navbar-brand' do %&gt;
        <span class="err">&lt;</span>%= image_tag 'logo.png' %&gt; <span class="nt">&lt;small</span> <span class="na">class=</span><span class="s">'hidden-xs hidden-sm'</span><span class="nt">&gt;</span>仲間とプロフィールを共有しよう！<span class="nt">&lt;/small&gt;</span>
      <span class="err">&lt;</span>% end %&gt;
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'navbar-collapse collapse navbar-responsive-collapse navbar-right'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">'nav navbar-nav'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= link_to 'HOME', root_path %&gt;<span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">'dropdown'</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">'#'</span> <span class="na">class=</span><span class="s">'dropdown-toggle'</span> <span class="na">data-toggle=</span><span class="s">'dropdown'</span> <span class="na">role=</span><span class="s">'button'</span> <span class="na">aria-expanded=</span><span class="s">'false'</span><span class="nt">&gt;</span>アカウント <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">'caret'</span><span class="nt">&gt;&lt;/span&gt;&lt;/a&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">'dropdown-menu'</span> <span class="na">role=</span><span class="s">'menu'</span><span class="nt">&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="err">&lt;</span>% end %&gt;
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">こちらは、サービスのヘッダーにあたる部分です。1行目の<code>&lt;% if user_signed_in? %&gt;</code>でログインしているときだけ表示するように条件分岐をしています。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/views/common/以下に_login_logo.html.erbファイルを作成して以下の内容を記述してください。</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">app/views/common/_login_logo.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'sign_up_logo'</span><span class="nt">&gt;</span>
  <span class="err">&lt;</span>%= image_tag 'logo.png' %&gt;
  <span class="nt">&lt;small&gt;</span>仲間とプロフィールを共有しよう！<span class="nt">&lt;/small&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">このファイルは新規登録ページと、ログインページで表示するロゴに使用します。現時点ではどこからも読みだしていません。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="510" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-698" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-698" name="check-698" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">application.html.erbを更新できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-699" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-699" name="check-699" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">app/views/にcommonフォルダを作成することができた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-700" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-700" name="check-700" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">app/views/common/以下に_header.html.erbを作成することができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="6" class="ng-scope">デバイスのビューをカスタマイズする</h2>

<p class="ng-scope">deviseビューをカスタマイズするには<code>rails g devise:views</code>コマンドを使って生成します。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_491"></i> rails g devise:views</h3>

<p class="ng-scope">deviseはgemをインストールしただけで、ログイン画面や、新規登録画面が用意されます。<br>
※これらの画面は、deviseのgemの中に記述されているためアプリケーション内で見つけることはできません。</p>

<p class="ng-scope">しかし、ほとんどの場合オリジナルでHTMLをカスタマイズして使うケースが多いため、<br>
<code>rails g devise:views</code>コマンドでビューファイル群を生成します。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> 以下のコマンドを実行してdeviseのビューファイルを生成してください。</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="nv">$ </span>rails g devise:views
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon newfile"></i> 新規作成されるファイル</h3>

<ul class="ng-scope">
<li>app/views/devise/mailer/confirmation_instructions.html.erb</li>
<li>app/views/devise/mailer/reset_password_instructions.html.erb</li>
<li>app/views/devise/mailer/unlock_instructions.html.erb</li>
<li>app/views/devise/passwords/edit.html.erb</li>
<li>app/views/devise/passwords/new.html.erb</li>
<li>app/views/devise/registrations/edit.html.erb</li>
<li>app/views/devise/registrations/new.html.erb #今回カスタマイズするファイル</li>
<li>app/views/devise/sessions/new.html.erb #今回カスタマイズするファイル</li>
<li>app/views/devise/shared/_links.html.erb</li>
<li>app/views/devise/unlocks/new.html.erb</li>
</ul>

<p class="ng-scope">今回カスタマイズするのは、ログイン画面の<code>app/views/devise/sessions/new.html.erb</code>と新規登録画面の<code>app/views/devise/registrations/new.html.erb</code>です。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>app/views/devise/registrations/new.html.erb</code>を以下のように編集してください。</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">app/views/devise/registrations/new.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'regist_back'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'log-up'</span><span class="nt">&gt;</span>
    <span class="err">&lt;</span>%= render partial: 'common/login_logo' %&gt;

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'log-in-inner'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h2&gt;</span>会員登録<span class="nt">&lt;/h2&gt;</span>

      <span class="err">&lt;</span>%= form_for(resource, as: resource_name, url: registration_path(resource_name)) do |f| %&gt;
        <span class="err">&lt;</span>%= devise_error_messages! %&gt;

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'form-group'</span><span class="nt">&gt;</span>
          <span class="err">&lt;</span>%= f.label :メールアドレス %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
          <span class="err">&lt;</span>%= f.email_field :email, autofocus: true, class: 'form-control' %&gt;
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'form-group'</span><span class="nt">&gt;</span>
          <span class="err">&lt;</span>%= f.label :パスワード %&gt;
          <span class="err">&lt;</span>% if @validatable %&gt;
            <span class="nt">&lt;em&gt;</span>(<span class="err">&lt;</span>%= @minimum_password_length %&gt; 文字以上)<span class="nt">&lt;/em&gt;</span>
          <span class="err">&lt;</span>% end %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
          <span class="err">&lt;</span>%= f.password_field :password, autocomplete: 'off', class: 'form-control' %&gt;
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'form-group'</span><span class="nt">&gt;</span>
          <span class="err">&lt;</span>%= f.label :パスワード（確認） %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
          <span class="err">&lt;</span>%= f.password_field :password_confirmation, autocomplete: 'off', class: 'form-control' %&gt;
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'actions'</span><span class="nt">&gt;</span>
          <span class="err">&lt;</span>%= f.submit class: 'btn btn-primary withripple', value: '新規登録' %&gt;
        <span class="nt">&lt;/div&gt;</span>
      <span class="err">&lt;</span>% end %&gt;

      <span class="err">&lt;</span>%= render 'devise/shared/links' %&gt;
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>app/views/devise/sessions/new.html.erb</code>を以下のように編集してください。</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">app/views/devise/sessions/new.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'login_back'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'log-in'</span><span class="nt">&gt;</span>
    <span class="err">&lt;</span>%= render partial: 'common/login_logo' %&gt;
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'log-in-inner'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h2&gt;</span>ログイン<span class="nt">&lt;/h2&gt;</span>

      <span class="err">&lt;</span>%= form_for(resource, as: resource_name, url: session_path(resource_name)) do |f| %&gt;
        <span class="err">&lt;</span>% if alert %&gt;
          <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">'alert alert-danger'</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= alert %&gt;<span class="nt">&lt;/p&gt;</span>
        <span class="err">&lt;</span>% end %&gt;

        <span class="nt">&lt;div&gt;</span>
          <span class="err">&lt;</span>%= f.email_field :email, autofocus: true, placeholder: 'メールアドレス', class: 'input form-control' %&gt;
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div&gt;</span>
          <span class="err">&lt;</span>%= f.password_field :password, autocomplete: 'off', placeholder: 'パスワード', class: 'input form-control' %&gt;
        <span class="nt">&lt;/div&gt;&lt;br</span> <span class="nt">/&gt;</span>

        <span class="err">&lt;</span>% if devise_mapping.rememberable? %&gt;
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'checkbox'</span><span class="nt">&gt;</span>
              <span class="nt">&lt;label&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">'user_remember_me'</span> <span class="na">name=</span><span class="s">'user[remember_me]'</span> <span class="na">type=</span><span class="s">'checkbox'</span> <span class="na">value=</span><span class="s">'1'</span><span class="nt">&gt;</span>
                <span class="err">&lt;</span>%= f.label :ログイン情報を記憶する, class: 'memory-check' %&gt;
              <span class="nt">&lt;/label&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="err">&lt;</span>% end %&gt;

        <span class="nt">&lt;div&gt;</span>
          <span class="err">&lt;</span>%= f.submit class: 'btn btn-primary withripple', value: 'ログイン' %&gt;
        <span class="nt">&lt;/div&gt;</span>
      <span class="err">&lt;</span>% end %&gt;

      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'login_link'</span><span class="nt">&gt;</span>
        <span class="err">&lt;</span>%= render 'devise/shared/links' %&gt;
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="514" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-704" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-704" name="check-704" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">deviseのビューファイルを生成できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-705" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-705" name="check-705" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">app/views/devise/registrations/new.html.erbを編集することができた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-706" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-706" name="check-706" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">app/views/devise/sessions/new.html.erbを編集することができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="7" class="ng-scope">ログインのためのUserモデルを作成する</h2>

<p class="ng-scope">この時点では、まだ基本的な設定をしただけなのでログインをすることはできません。<br>
次にdeviseのコマンドを使って、ユーザーモデルを作成していきます。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_492"></i> rails g devise モデル名</h3>

<p class="ng-scope"><code>rails g devise モデル名</code>はログインに紐付いたモデルの生成とルーティングの追加を行ってくれるdeviseのコマンドです。</p>

<p class="ng-scope">生成されるファイルは<code>rails g model モデル名</code>で生成されるファイルと似ています。<br>
ActiveRecordを継承したモデルとテーブルのカラム情報などを記述したmigrationファイル、それに関連したファイルです。<br>
<code>rails g devise モデル名</code>を実行するとdeviseを利用するために初期設定された状態でファイルが生成されるので便利です。モデル名は、<code>user</code>にかぎらず、<code>member</code>、<code>guest</code>なども自由に指定できます。</p>

<h3 class="ng-scope">以下のコマンドを実行してユーザーモデル生成、及びルーティングの追加をしてください。</h3>

<div class="challenge ng-scope">
<h3>
<i class="icon crown"></i> 問題4：deviseのコマンドを使って、ユーザーモデルを作成してください。</h3>
<h5>作業場所：ターミナル</h5>
<h5>ヒント： コマンドにはbundle execをつけましょう。</h5>

<curriculum-question-container class="ng-scope" data-order="4"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
</div>

<h3 class="ng-scope">
<i class="icon newfile"></i> 新規作成されるファイル</h3>

<ul class="ng-scope">
<li>app/models/user.rb</li>
<li>db/migrate/201xxxxxxxxx_devise_create_users.rb</li>
<li>test/fixtures/users.yml</li>
<li>test/models/user_test.rb</li>
</ul>

<h3 class="ng-scope">
<i class="icon newfile"></i> 更新されるファイル</h3>

<ul class="ng-scope">
<li>config/routes.rb</li>
</ul>

<p class="ng-scope">config/routes.rbを見ると以下の様な記述が追記されていると思います。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">config/routes.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
<span class="hll">  <span class="n">devise_for</span> <span class="ss">:users</span>
</span>  <span class="n">root</span> <span class="ss">to</span><span class="p">:</span> <span class="s2">"top#index"</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon information" id="term_493"></i> devise_for</h3>

<p class="ng-scope">devise_forはログインまわりに必要なルーティングを一気に生成してくれるdeviseのヘルパーメソッドです。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> ターミナルで<code>rake routes</code>を実行して現在設定されているルーティングを確認してください。</h3>

<p class="ng-scope"><code>devise_for :users</code>を記述することで以下のようにログイン周りで必要なルーティングが生成されていることが確認できます。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td>
<td class="code">
<div class="highlight"><pre>                  Prefix Verb   URI Pattern                    Controller#Action
<span class="hll">        new_user_session GET    /users/sign_in<span class="o">(</span>.:format<span class="o">)</span>       devise/sessions#new
</span>            user_session POST   /users/sign_in<span class="o">(</span>.:format<span class="o">)</span>       devise/sessions#create
    destroy_user_session DELETE /users/sign_out<span class="o">(</span>.:format<span class="o">)</span>      devise/sessions#destroy
           user_password POST   /users/password<span class="o">(</span>.:format<span class="o">)</span>      devise/passwords#create
       new_user_password GET    /users/password/new<span class="o">(</span>.:format<span class="o">)</span>  devise/passwords#new
      edit_user_password GET    /users/password/edit<span class="o">(</span>.:format<span class="o">)</span> devise/passwords#edit
                         PATCH  /users/password<span class="o">(</span>.:format<span class="o">)</span>      devise/passwords#update
                         PUT    /users/password<span class="o">(</span>.:format<span class="o">)</span>      devise/passwords#update
cancel_user_registration GET    /users/cancel<span class="o">(</span>.:format<span class="o">)</span>        devise/registrations#cancel
       user_registration POST   /users<span class="o">(</span>.:format<span class="o">)</span>               devise/registrations#create
   new_user_registration GET    /users/sign_up<span class="o">(</span>.:format<span class="o">)</span>       devise/registrations#new
  edit_user_registration GET    /users/edit<span class="o">(</span>.:format<span class="o">)</span>          devise/registrations#edit
                         PATCH  /users<span class="o">(</span>.:format<span class="o">)</span>               devise/registrations#update
                         PUT    /users<span class="o">(</span>.:format<span class="o">)</span>               devise/registrations#update
                         DELETE /users<span class="o">(</span>.:format<span class="o">)</span>               devise/registrations#destroy
                    root GET    /                              top#index
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><i class="icon attention"></i><br>
<strong>migrationファイルが生成されましたが、まだ<code>rake db:migrate</code>は実行しないでください。</strong></p>

<h2 id="8" class="ng-scope">usersテーブルにメール認証に必要なカラムを作成する</h2>

<p class="ng-scope">メールアドレスによる認証を実装するためには、いくつか設定が必要になります。<br>
メール認証を始めとするdeviseの具体的な使い方を知りたい際は、 <a href="https://github.com/plataformatec/devise" title="githubのreadme">githubのreadme</a>を見るのが一番です。<br>
英語が苦手な方は、日本語のブログも検索すればたくさん出てきます。全ての機能を理解するのは難しいのでまずは、このカリキュラムの資料にそって実装して雰囲気をつかんでいきましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> migrationファイルの＃Confirmableセクションのコメントアウトを外して保存してください。</h3>

<p class="ng-scope">これらは、認証メールのトークンや再送信の情報を保存するカラムですが、デフォルトではコメントアウトされています。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">db/migrate/2015xxxxxxxxxx_devise_create_users.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="c1">## Confirmable</span>
  <span class="n">t</span><span class="o">.</span><span class="n">string</span>   <span class="ss">:confirmation_token</span>
  <span class="n">t</span><span class="o">.</span><span class="n">datetime</span> <span class="ss">:confirmed_at</span>
  <span class="n">t</span><span class="o">.</span><span class="n">datetime</span> <span class="ss">:confirmation_sent_at</span>
  <span class="n">t</span><span class="o">.</span><span class="n">string</span>   <span class="ss">:unconfirmed_email</span> <span class="c1"># Only if using reconfirmable</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="515" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-707" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-707" name="check-707" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">migrationファイルの＃Confirmableセクションのコメントアウトを外して保存できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h3 class="ng-scope">
<i class="icon pen"></i> ターミナルで<code>rake db:migrate</code>を実行してusersテーブルを作成してください。</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="nv">$ </span>rake db:migrate
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><img src="users_table.png" alt="ユーザーテーブルが出来ていることを確認"></p>

<p class="ng-scope">テーブルを作成できたので実際に新規登録画面とログイン画面を確認してみましょう。</p>

<h3 class="ng-scope">
<i class="icon attention"></i> ここまで作業が完了したら、編集内容を反映させるために一旦サーバーを再起動(<code>control + c</code> → <code>rails s</code>)しておきましょう。</h3>

<h3 class="ng-scope">
<i class="icon pen"></i> 新規登録画面( <a href="http://localhost:3000/users/sign_up" target="_top"></a><a href="http://localhost:3000/users/sign_up">http://localhost:3000/users/sign_up</a> )の表示を確認してください。</h3>

<p class="ng-scope"><img src="users-sign_up.png" alt="新規登録画面"></p>

<h3 class="ng-scope">
<i class="icon pen"></i> ログイン画面( <a href="http://localhost:3000/users/sign_in" target="_top"></a><a href="http://localhost:3000/users/sign_in">http://localhost:3000/users/sign_in</a> )の表示を確認してください。</h3>

<p class="ng-scope"><img src="users-sign_in.png" alt="ログイン画面"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="511" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-701" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-701" name="check-701" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">新規登録画面とログイン画面が表示されることを確認できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="9" class="ng-scope">ログインしていないときにルートにアクセスすると、ログイン画面にリダイレクトするようにする</h2>

<p class="ng-scope">次にルートパス<a href="http://localhost:3000/">http://localhost:3000</a>にアクセスしたらどうなるか確認してみましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i><code>rails s</code>でサーバーを起動して<a href="http://localhost:3000/">http://localhost:3000</a>にアクセスしてください。</h3>

<p class="ng-scope">以下のように何もない画面が表示されると思います。</p>

<ul class="ng-scope">
<li>ルートパス（<a href="http://localhost:3000%EF%BC%89">http://localhost:3000）</a>
</li>
</ul>

<p class="ng-scope"><img src="root_path.png" alt="ルートパス"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="512" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-702" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-702" name="check-702" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ルートパスの何もない画面が表示されることを確認できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope">Profyはログインが必要なサービスなので、まだログインもしていないのに<br>
トップの画面にアクセスできてしまうのはおかしいですよね。ログインしていないときは、ログイン画面に飛ばされるようにしましょう。<br>
deviseのauthenticate_user!というメソッドを使うと簡単に実現することができます。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_494"></i> authenticate_user!</h3>

<p class="ng-scope">authenticate_user!はユーザがログインしているかどうかを確認し、ログインしていない場合はユーザをログインページにリダイレクトするdeviseのメソッドです。<br>
通常、<code>before_action</code>を合わせて使用します。before_actionの<code>except</code>や<code>only</code>オプションを組み合わせると特定のアクションを指定することもできます。</p>

<p class="ng-scope"><strong>【例】</strong></p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">TestController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

<span class="hll">  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:index</span><span class="o">]</span>
</span>
  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
  <span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table></div>

<h3 class="ng-scope">
<i class="icon pen"></i>　app/controllers/application_controller.rbに<code>before_action :authenticate_user!</code>を追加してください</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">app/controllers/application_controller.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>
<span class="hll">  <span class="c1"># Prevent CSRF attacks by raising an exception.</span>
</span>  <span class="c1"># For APIs, you may want to use :null_session instead.</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:exception</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">ApplicationControllerは、TopControllerをはじめとするあらゆるコントローラーが継承するため、<br>
ここに<code>before_action :authenticate_user!</code>を設定すると、すべてのアクセスに対してログインをしているかの確認が入るようになります。さっそくリダイレクトがかかるか確認してみましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i>　サーバーを再起動して、localhost:3000にアクセスしてリダイレクトされることを確認しましょう</h3>

<p class="ng-scope"><img src="root_path_redirect.png" alt="リダイレクトされることを確認"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="516" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-708" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-708" name="check-708" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">authenticate_user!について理解できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="517" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-709" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-709" name="check-709" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">before_action :authenticate_user!を追加できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-710" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-710" name="check-710" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">localhost:3000にアクセスしてリダイレクトされることを確認できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="10" class="ng-scope">Railsを日本語化する</h2>

<p class="ng-scope">先ほどリダイレクトされた際に、フラッシュで表示されたエラーメッセージが<code>You need to sign in or sign up before continuing.</code>と英語で出力されたのにお気づきでしょうか。<br>
RailsのWebアプリの多言語化をサポートしてくれるGem、i18nを利用して、この部分を日本語化していきます。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_495"></i> i18n</h3>

<p class="ng-scope">Railsの国際化対応（日本語化対応）は「i18n」というGemを使います。<br>
i18nは、internationalization(国際化)という意味です。18はiとnの間にある文字数を指しています。<br>
i18nを使うと簡単に言語を切り替えることが可能になります。一例を紹介します。</p>

<p class="ng-scope"><strong>【例】</strong></p>

<ul class="ng-scope">
<li>日本語の設定ファイル</li>
</ul>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">config/locales/ja.yml</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="ss">ja</span><span class="p">:</span>
    <span class="ss">view</span><span class="p">:</span>
      <span class="ss">hello</span><span class="p">:</span> <span class="s2">"こんにちは、世界！"</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<ul class="ng-scope">
<li>英語の設定ファイル</li>
</ul>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">config/locales/en.yml"</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="ss">en</span><span class="p">:</span>
    <span class="ss">view</span><span class="p">:</span>
      <span class="ss">hello</span><span class="p">:</span> <span class="s2">"Hello！World!"</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<ul class="ng-scope">
<li>言語設定を日本語を指定
　※application.rbはrailsの基本的な環境設定をするファイルです。</li>
</ul>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">config/application.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>21</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">i18n</span><span class="o">.</span><span class="n">default_locale</span><span class="o">=</span><span class="ss">:ja</span><span class="c1">#英語の場合は:en</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<ul class="ng-scope">
<li>文字列を出力</li>
</ul>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">app/views/sample/sample.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="o">&lt;%=</span> <span class="n">t</span><span class="p">(</span><span class="s1">'view.hello'</span><span class="p">)</span> <span class="o">%&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">言語指定を日本語にしているため<code>"こんにちは、世界！"</code>と表示されます。<br>
i18nの機能はこれだけではなく、アプリケーションの言語を切り替えるために様々な機能が用意されています。<br>
詳しくは<a href="http://morizyun.github.io/blog/i18n-english-rails-ruby-many-languages/#4">こちらのブログ</a>をご覧ください。<br>
今は全ての機能を覚える必要はありません。ただ、言語設定に関するものは<code>i18n</code>を使うと覚えておき、必要なときに調べられれば大丈夫です。</p>

<p class="ng-scope">早速日本語化を進めていきましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i>　config/application.rbを以下のように編集してください。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">config/application.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>21</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">i18n</span><span class="o">.</span><span class="n">default_locale</span> <span class="o">=</span> <span class="ss">:ja</span> <span class="c1">#コメントアウトしている場合は外す。</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="518" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-711" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-711" name="check-711" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">config/application.rbを編集できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h3 class="ng-scope">
<i class="icon pen"></i><a href="http://master.tech-camp.in/download?file_name=locales&amp;file_type=zip&amp;dir_name=rails3" target="_top">こちらのリンク</a>からzipファイルダウンロードして解凍後、中にあるja.ymlとdevise.ja.ymlをconfig/locales以下に設置してください。</h3>

<ul class="filetree ng-scope">
  <li class="t-folder"> config
    <ul>
      <li class="t-folder"> locales
        <ul>
          <li class="t-file"> ja.yml</li>
          <li class="t-file"> devise.ja.yml</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope">ja.ymlは基本的なrails処理の日本語化ファイル、devise.ja.ymlはdeviseに関わる処理の日本語化ファイルです。<br>
これらの日本語化ファイルはWEBで検索すればダウンロードすることができます。<br>
上の例であげた<code>&lt;%= t() %&gt;</code>というメソッドは、deviseの中に定義されているため今回は見ることはありません。</p>

<h3 class="ng-scope">
<i class="icon pen"></i>サーバーを再起動（rails s）後、<a href="http://localhost:3000/">http://localhost:3000</a>にアクセスをしてフラッシュメッセージが日本語になっていることを確認してください。</h3>

<p class="ng-scope"><img src="nihongo.png" alt="日本語になっていることを確認"></p>

<p class="ng-scope">これだけでは、まだ完全には日本語化されていません。<br>
「Sing up」「Forgot your password?」などビューに直接書かれている英語の文字があるので編集します。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="519" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-712" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-712" name="check-712" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ja.ymlとdevise.ja.ymlをconfig/locales以下に設置できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-713" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-713" name="check-713" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">フラッシュメッセージが日本語になっていることを確認できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h3 class="ng-scope">
<i class="icon pen"></i>app/views/devise/shared/_links.html.erbを以下のように編集してください。</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">app/views/devise/shared/_links.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="err">&lt;</span>% if controller_name != 'sessions' %&gt;
<span class="hll">  <span class="err">&lt;</span>%= link_to 'ログイン', new_session_path(resource_name) %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</span><span class="err">&lt;</span>% end %&gt;

<span class="err">&lt;</span>% if devise_mapping.registerable? <span class="err">&amp;&amp;</span> controller_name != 'registrations' %&gt;
<span class="hll">  <span class="err">&lt;</span>%= link_to '新規登録', new_registration_path(resource_name) %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</span><span class="err">&lt;</span>% end %&gt;

<span class="err">&lt;</span>% if devise_mapping.recoverable? <span class="err">&amp;&amp;</span> controller_name != 'passwords' <span class="err">&amp;&amp;</span> controller_name != 'registrations' %&gt;
<span class="hll">  <span class="err">&lt;</span>%= link_to 'パスワードを忘れた方', new_password_path(resource_name) %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</span><span class="err">&lt;</span>% end %&gt;

<span class="err">&lt;</span>% if devise_mapping.confirmable? <span class="err">&amp;&amp;</span> controller_name != 'confirmations' %&gt;
<span class="hll">  <span class="err">&lt;</span>%= link_to '確認メールの再送信', new_confirmation_path(resource_name) %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</span><span class="err">&lt;</span>% end %&gt;

<span class="err">&lt;</span>% if devise_mapping.lockable? <span class="err">&amp;&amp;</span> resource_class.unlock_strategy_enabled?(:email) <span class="err">&amp;&amp;</span> controller_name != 'unlocks' %&gt;
  <span class="err">&lt;</span>%= link_to "Didn't receive unlock instructions?", new_unlock_path(resource_name) %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="err">&lt;</span>% end %&gt;

<span class="err">&lt;</span>% if devise_mapping.omniauthable? %&gt;
  <span class="err">&lt;</span>% resource_class.omniauth_providers.each do |provider| %&gt;
    <span class="err">&lt;</span>%= link_to 'Sign in with #{provider.to_s.titleize}', omniauth_authorize_path(resource_name, provider) %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="err">&lt;</span>% end %&gt;
<span class="err">&lt;</span>% end %&gt;
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i>サーバーを再起動（rails s）後、localhost:3000にアクセスして「Sign up」などの文言が日本語になっていることを確認してください。</h3>

<p class="ng-scope"><img src="nihongo2.png" alt="日本語になっていることを確認"></p>

<p class="ng-scope">以上でログイン周りの日本語化は終了です。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="520" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-714" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-714" name="check-714" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">app/views/devise/shared/_links.html.erbを編集できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-715" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-715" name="check-715" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">localhost:3000にアクセスして「Sing up」などの文言が日本語になっていることを確認できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="11" class="ng-scope">メール認証のためのモジュールを読み込む</h2>

<p class="ng-scope">基本的なログイン周りの設定はおわりましたが、まだメール認証の設定がいくつか終わっていません。<br>
メール認証を利用するためにはもう少し設定をする必要があるので進めていきましょう。<br>
deviseの設定は手数は多くて煩雑に感じられるかもしれませんが、自力で全て実装（フルスクラッチ）するよりもはるかに簡単です。</p>

<h3 class="ng-scope">
<i class="icon pen"></i>app/models/user.rbを以下のように編集してください。</h3>

<p class="ng-scope"><code>:confirmable</code>を追記するだけです。これらはUserモデルが読み込んでいるdeviseのモジュールです。<br>
このあたりはdeviseの使い方なので、メール認証をつけるにはログインにつかうモデルで<code>:confirmable</code>を読み込むと覚えておけば大丈夫です。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/user.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Include default devise modules. Others available are:</span>
  <span class="c1"># :confirmable, :lockable, :timeoutable and :omniauthable</span>
  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
<span class="hll">         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span><span class="p">,</span> <span class="ss">:confirmable</span>
</span><span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h2 id="12" class="ng-scope">メール送信用サーバー（SMTPサーバー）の設定</h2>

<p class="ng-scope">railsアプリケーション自体にメールを送る機能はありません。railsアプリケーションからメールを送るためにはSMTPサーバーを設定する必要があります。<br>
※メールの仕組みを理解したい方は<a href="http://itpro.nikkeibp.co.jp/article/COLUMN/20071108/286748/">こちらの記事</a>をご覧ください。</p>

<p class="ng-scope"><i class="icon attention"></i> 本設定にはgmailのアドレスとパスワードが必要です。お持ちでない方はgmailアカウントの作成をお願いします。<a href="https://accounts.google.com/ServiceLogin?sacu=1">gmailアカウントへのログイン</a></p>

<p class="ng-scope"><i class="icon attention"></i><br>
gmailに2段階認証を設定されている方は、設定を解除する、もしくは新たにアカウントを作成するようにしてください。</p>

<h3 class="ng-scope">
<i class="icon pen"></i>config/environments/development.rbに追記してください。変更するのはご自身のアドレスとパスワードだけで構いません。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">config/environments/development.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="s1">'localhost'</span><span class="p">,</span> <span class="ss">port</span><span class="p">:</span> <span class="mi">3000</span> <span class="p">}</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">raise_delivery_errors</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">:enable_starttls_auto</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
    <span class="ss">:address</span> <span class="o">=&gt;</span> <span class="s2">"smtp.gmail.com"</span><span class="p">,</span>
    <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="mi">587</span><span class="p">,</span>
    <span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s1">'smtp.gmail.com'</span><span class="p">,</span>
    <span class="ss">:user_name</span> <span class="o">=&gt;</span> <span class="s2">"●●●●●@gmail.com"</span><span class="p">,</span> <span class="c1">#ご自身のgmailアドレス</span>
    <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">"●●●●●●●●"</span><span class="p">,</span> <span class="c1">#ご自身のgmailアドレスのパスワード</span>
    <span class="ss">:authentication</span> <span class="o">=&gt;</span> <span class="s1">'login'</span><span class="p">,</span>
  <span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">設定ができたら早速新規登録をして、認証メールが届くか確認してみましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i>サーバーを再起動して、新規登録後、メールが届くことを確認してください。</h3>

<p class="ng-scope"><img src="sign-up.png" alt="新規登録画面"></p>

<p class="ng-scope">登録後、ログインページにリダイレクトされます。ただし、まだ認証していないのでログインすることは出来ない状態になっています。<br>
正しく設定されていればメールが届くので確認してください。</p>

<p class="ng-scope"><img src="accont-register.png" alt="メールが届いていることを確認"></p>

<p class="ng-scope"><i class="icon attention"></i> メールが届かない場合、迷惑メールに入っている可能性があります。</p>

<h3 class="ng-scope">以下のようなエラーが起きた場合</h3>

<p class="ng-scope"><img src="smtp_error.png" alt="SMTPエラー"></p>

<p class="ng-scope">これはgoogleのセキュリティにより、config/environments/development.rbに書いたメールアドレスとパスワードで認証しようとしても、はじかれてしまったためにこのようなエラーが起きました。</p>

<p class="ng-scope"><strong>解決方法</strong></p>

<blockquote class="ng-scope">
<p>gmailを開き、届いたメールを開いて下さい<br>
<img src="gmail.png" alt="gamil"><br>
上のようなメールを開いたら、<strong>このログイン試行がご自身によるものである場合</strong>にある<code>https://www.google.com/settings/security/lesssecureapps</code>を開くと以下のような画面に移ります。<br>
メールにリンクが見当たらない場合は<a href="https://www.google.com/settings/security/lesssecureapps">こちら</a>から上記の画面に移ることことが出来ます。</p>

<p><img src="gmail_security.png" alt="gamil"><br>
上のような画面が出たら、安全性の低いアプリのアクセスをオンにして下さい。</p>
</blockquote>

<p class="ng-scope">上のような設定をしたら、もう一度サインアップして見ましょう。</p>

<p class="ng-scope"><img src="after_comfirm.png" alt="認証後"></p>

<p class="ng-scope"><img src="after-login.png" alt="ログイン後"></p>

<p class="ng-scope">これでメール認証を用いた新規登録を実装することができました。<br>
日本だと、メールから認証しないとログインできないことが多いです。逆に海外ではメールの認証は後から行えばOKとするサービスが主流になっています。deviseはどちらのケースでもカスタマイズすることで実現することができます。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="521" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-716" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-716" name="check-716" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">app/models/user.rbに:confirmableを追記できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-717" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-717" name="check-717" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">development.rbにご自身のアドレスとパスワードを入力できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-718" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-718" name="check-718" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">サーバーを再起動して新規登録後、メールが届くことを確認できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-719" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-719" name="check-719" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">メールを開き、confirm my accountをクリックしてログインした</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="13" class="ng-scope">ログアウトをつける</h2>

<p class="ng-scope">ログインだけではなく、ログアウトできるようにしましょう。<br>
ログアウトのルーティングは既にdeviseから提供されています。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> コンソールで<code>rake routes</code>を実行してログアウトのルーティングがあることを確認してください。</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>rake routes
                  Prefix Verb   URI Pattern                       Controller#Action
        new_user_session GET    /users/sign_in<span class="o">(</span>.:format<span class="o">)</span>          devise/sessions#new
            user_session POST   /users/sign_in<span class="o">(</span>.:format<span class="o">)</span>          devise/sessions#create
    destroy_user_session DELETE /users/sign_out<span class="o">(</span>.:format<span class="o">)</span>         devise/sessions#destroy
           user_password POST   /users/password<span class="o">(</span>.:format<span class="o">)</span>         devise/passwords#create
       new_user_password GET    /users/password/new<span class="o">(</span>.:format<span class="o">)</span>     devise/passwords#new
      edit_user_password GET    /users/password/edit<span class="o">(</span>.:format<span class="o">)</span>    devise/passwords#edit
                         PATCH  /users/password<span class="o">(</span>.:format<span class="o">)</span>         devise/passwords#update
                         PUT    /users/password<span class="o">(</span>.:format<span class="o">)</span>         devise/passwords#update
cancel_user_registration GET    /users/cancel<span class="o">(</span>.:format<span class="o">)</span>           devise/registrations#cancel
       user_registration POST   /users<span class="o">(</span>.:format<span class="o">)</span>                  devise/registrations#create
   new_user_registration GET    /users/sign_up<span class="o">(</span>.:format<span class="o">)</span>          devise/registrations#new
  edit_user_registration GET    /users/edit<span class="o">(</span>.:format<span class="o">)</span>             devise/registrations#edit
                         PATCH  /users<span class="o">(</span>.:format<span class="o">)</span>                  devise/registrations#update
                         PUT    /users<span class="o">(</span>.:format<span class="o">)</span>                  devise/registrations#update
                         DELETE /users<span class="o">(</span>.:format<span class="o">)</span>                  devise/registrations#destroy
       user_confirmation POST   /users/confirmation<span class="o">(</span>.:format<span class="o">)</span>     devise/confirmations#create
   new_user_confirmation GET    /users/confirmation/new<span class="o">(</span>.:format<span class="o">)</span> devise/confirmations#new
                         GET    /users/confirmation<span class="o">(</span>.:format<span class="o">)</span>     devise/confirmations#show
                    root GET    /                                 top#index
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">例えば開発環境であればDELETEメソッドで「localhost:3000/users/sign_out」にアクセスしたときに、devise以下にあるsessionsコントローラーのdestroyアクションが動くことを意味しています。このsessionsコントローラーはdeviseのgemの中に記述されているものなので、通常はコードを目にする必要はありません。<br>
このルーティングをビューに設定すれば、ログアウト機能は完成します。とても簡単に実現できますね！</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題5：ログアウト機能を実装しましょう。</h3>

<h5>作業ファイル：app/views/common/_header.html.erb</h5>
<h5>ヒント1 : 今回の場合、link_toの第一引数にはリンク名、第二引数にはパスの指定、第三引数にはHTTPメソッドを指定するオプション(method:)とします。</h5>
<h5>ヒント2 : <a href="http://master.tech-camp.in/curriculums/16">rails1-6</a>の問題11で同じような実装をしているので、参照してみてください。</h5>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">app/views/common/_header.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-collapse collapse navbar-responsive-collapse navbar-right"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= link_to "HOME", root_path %&gt;<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span> <span class="na">role=</span><span class="s">"button"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span><span class="nt">&gt;</span>アカウント <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/span&gt;&lt;/a&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span> <span class="na">role=</span><span class="s">"menu"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= #link_toメソッドを利用してログアウトを実装する %&gt;<span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>


    <curriculum-question-container class="ng-scope" data-order="5"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i>ログアウトボタンが出現することを確認して、実際にログアウトをしてください。</h3>

<p class="ng-scope"><img src="logout.png" alt="認証後"></p>

<p class="ng-scope"><img src="after-logout.png" alt="認証後"></p>

<p class="ng-scope">ログアウト後は、ログイン画面にいきます。</p>

<p class="ng-scope">deviseを使ったログインの実装はここまでで一旦終わりです！<br>
お疲れ様でした！</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="522" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-720" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-720" name="check-720" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">rake routesを実行してログアウトのルーティングがあることを確認できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-721" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-721" name="check-721" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">/app/views/common/_header.html.erbを編集できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-722" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-722" name="check-722" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ログアウトボタンが出現してログアウトできた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 id="14" class="ng-scope">ログイン機能をつくろう:応用設定</h1>

<p class="ng-scope">ここまでの設定はメール認証以外はこれまでのカリキュラムとあまり違いがないように感じられるかもしれません。<br>
ここからは、これまでやったことのないdeviseのカスタマイズを行っていきます。</p>

<p class="ng-scope"><i class="icon attention"></i><br>
deviseの詳しい使い方は<a href="https://github.com/plataformatec/devise">githubのreadme</a>をご覧ください。英語が苦手な方も、検索すれば日本語記事が多くあがっています。今はあまり難しく考えすぎず「こうやって使うものなんだ」と慣れて頂ければ大丈夫です。</p>

<h2 id="15" class="ng-scope">どのようなカスタマイズを行うのか理解しよう</h2>

<p class="ng-scope">今回行うカスタマイズは新規登録時、ログイン時の項目にグループ名を増やすというものです。<br>
イメージとしてはチャットサービスのSlackが近いでしょう。ユーザーがサービスに登録した時点でどこかのグループに所属することとなります。<br>
企業向けエンタープライズ製品などでもこういった仕様は多いと思います。</p>

<ul class="ng-scope">
<li>カスタマイズの最終的なイメージ</li>
</ul>

<p class="ng-scope"><img src="group_name.png" alt="グループIDを認証に加える"></p>

<h2 id="16" class="ng-scope">グループ名を入力するフォームをつくろう</h2>

<p class="ng-scope">まずはグループ名を入力できるようにしましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>app/views/devise/registrations/new.html.erb</code>へ以下のように追記してください。</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">app/views/devise/registrations/new.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>24
25
26
27
28
29
30
31
32</pre></div></td>
<td class="code">
<div class="highlight"><pre>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'form-group'</span><span class="nt">&gt;</span>
          <span class="err">&lt;</span>%= f.label :パスワード（確認） %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
          <span class="err">&lt;</span>%= f.password_field :password_confirmation, autocomplete: 'off', class: 'form-control' %&gt;
        <span class="nt">&lt;/div&gt;</span>
　　　<span class="c">&lt;!--以下を追記--&gt;</span>
<span class="hll">        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'form-group'</span><span class="nt">&gt;</span>
</span><span class="hll">          <span class="err">&lt;</span>%= f.label :グループ名（半角英数） %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</span><span class="hll">          <span class="err">&lt;</span>%= f.text_field :group_key, autofocus: true, class: 'form-control' %&gt;
</span><span class="hll">        <span class="nt">&lt;/div&gt;</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><code>f.text_field :group_key</code>というテキストフィールドを追加しました。さっそく表示を確認してみましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> <a href="http://localhost:3000/users/sign_up">localhost:3000/users/sign_up</a>にアクセスしてグループ名の項目が追加されたか確認してください。</h3>

<p class="ng-scope">問題なく表示されると思ったら、以下のようなエラーがでてしまいます。</p>

<p class="ng-scope"><img src="action_controller__exception_caught.png" alt="グループIDを認証に加える"></p>

<p class="ng-scope"><code>undefined method group_key for #&lt;User:0x007ff0f2998460&gt;</code></p>

<p class="ng-scope">これは「ユーザーインスタンスに対してgroup_keyメソッドを実行したけど、定義されていなかった」というエラーメッセージです。</p>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">app/views/devise/registrations/new.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>8</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="hll">      <span class="o">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="n">resource_name</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">registration_path</span><span class="p">(</span><span class="n">resource_name</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="o">%&gt;</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><code>form_for</code>メソッドは特定のモデルクラスのインスタンスに基づいてつくられます。そのため今回の<code>group_key</code>のような存在しないプロパティを指定するとエラーになってしまいます。</p>

<p class="ng-scope"><i class="icon attention"></i>
resourceにはログイン用のモデルとして指定したクラスのインスタンスが入っています。こちらはdeviseの仕様なので深く気にする必要はありません。</p>

<p class="ng-scope">form_forメソッドを利用しながら、エラーがでないようにするためにはモデルクラスにプロパティを追加する必要があります。モデルクラスのプロパティへの追加は次に出てくる <code>attr_accessor</code>を利用します。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="523" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-723" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-723" name="check-723" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">カスタマイズの最終的なイメージができた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-724" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-724" name="check-724" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">/app/views/devise/registrations/new.html.erbを編集することができた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-725" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-725" name="check-725" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text"> localhost:3000/users/sign_upにアクセスしてグループ名の項目が追加された</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h3 class="ng-scope">
<i class="icon information" id="term_496"></i> attr_accessor</h3>

<p class="ng-scope">データの読み書きできるプロパティをモデルに追加するメソッドです。</p>

<p class="ng-scope">詳しい内容は<a href="http://ref.xaio.jp/ruby/classes/module/attr_accessor">こちらのリンク</a>をご覧ください。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">例</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c1">#attr_accessorを定義しない場合</span>
<span class="k">class</span> <span class="nc">Book</span>
<span class="k">end</span>

<span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">new</span>
<span class="n">book</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">"Programming Ruby"</span> <span class="c1">#この場合はエラーが出力される</span>
<span class="c1">#=&gt; test.rb:6:in `&lt;main&gt;': undefined method `title=' for #&lt;Book:0x007fbb7c0e7d80&gt; (NoMethodError)</span>

<span class="c1">#attr_accessorを定義した場合</span>
<span class="k">class</span> <span class="nc">Book</span>
  <span class="kp">attr_accessor</span> <span class="ss">:title</span>
<span class="k">end</span>

<span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">new</span>
<span class="n">book</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">"Programming Ruby"</span> <span class="c1">#titleプロパティを定義したのでエラーが発生しない</span>
<span class="nb">puts</span> <span class="n">book</span><span class="o">.</span><span class="n">title</span>
<span class="c1">#=&gt; "Programming Ruby"</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">ActiveRecordを継承したクラスの場合自動でテーブルのカラム名がプロパティとして定義されます。今回のようにフォームへ新たに、カラムとしては存在しないプロパティを追加するためにはattr_accessorをUserモデルに追加する必要があります。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="524" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-726" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-726" name="check-726" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">attr_accessorメソッドについて理解できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>app/models/user.rb</code>を以下のように更新してください。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/user.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

  <span class="c1">#accessor</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:group_key</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> 再度<a href="http://localhost:3000/users/sign_up">localhost:3000/users/sign_up</a>にアクセスしてみましょう。</h3>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="525" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-727" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-727" name="check-727" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">/app/models/user.rbを更新できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-728" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-728" name="check-728" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">localhost:3000/users/sign_upにアクセスした</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><img src="add_group_name_sign_up.png" alt="グループ名が追加された"></p>

<p class="ng-scope">今度はエラーを出さずに表示することができました。新規登録画面だけではなくログイン画面にもグループ名を記述できるようにしておきましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>app/views/devise/sessions/new.html.erb</code>を以下のように編集してください。</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">app/views/devise/sessions/new.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td>
<td class="code">
<div class="highlight"><pre>        <span class="nt">&lt;div&gt;</span>
          <span class="err">&lt;</span>%= f.password_field :password, autocomplete: 'off', placeholder: 'パスワード', class: 'input form-control' %&gt;
        <span class="nt">&lt;/div&gt;</span>
<span class="hll">        <span class="nt">&lt;br&gt;</span>
</span><span class="hll">        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'form-group'</span><span class="nt">&gt;</span>
</span><span class="hll">          <span class="err">&lt;</span>%= f.label :グループ名（半角英数） %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</span><span class="hll">          <span class="err">&lt;</span>%= f.text_field :group_key, autofocus: true, class: 'form-control' %&gt;
</span>        <span class="nt">&lt;/div&gt;</span>
        <span class="err">&lt;</span>% if devise_mapping.rememberable? %&gt;
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'checkbox'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="err">&lt;</span>% end %&gt;
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><img src="add_group_name_to_login.png" alt="グループIDをログインに加える"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="526" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-729" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-729" name="check-729" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">/app/views/devise/sessions/new.html.erbを編集できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="17" class="ng-scope">グループ名を保存するテーブルをつくろう</h2>

<p class="ng-scope">フォームからProfyに登録したユーザーは必ずどこかのグループに属する事になります。<br>
誰がどのグループに所属しているのか記録するために、usersテーブル1レコードごとにグループ名を文字列で書いていくのは冗長ですよね。groupsテーブルを作成してusersテーブルとリレーションさせるようにしましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> ターミナルで次コマンドを実行してください</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>rails g model group
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>db/migrate/2015xxxxxxxxxxx_create_groups.rb</code>を以下のように更新した後、ターミナルで<code>rake db:migrate</code>を実行してください。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">db/migrate/2015xxxxxxxxxxx_create_groups.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateGroups</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:groups</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
<span class="hll">      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:key</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="hll">      <span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="ss">:detail</span>
</span>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>rake db:migrate
<span class="o">==</span> 2015xxxxxxxxxxxx CreateGroups: <span class="nv">migrating</span> <span class="o">=====================================</span>
-- create_table<span class="o">(</span>:groups<span class="o">)</span>
   -&gt; 0.1232s
<span class="o">==</span> 2015xxxxxxxxxxxx CreateGroups: migrated <span class="o">(</span>0.1233s<span class="o">)</span> <span class="o">============================</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">リレーションするモデルを定義したら同時にアソシエーションも設定おきましょう。<br>
まずはusersテーブルにgroup_idを保存できるようにします。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> ターミナルで次コマンドを実行してください</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>rails g migration AddGroupIdToUsers
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>db/migrate/2015xxxxxxxxxxx_add_group_id_to_users.rb</code>を以下のように更新して、ターミナルで<code>rake db:migrate</code>を実行してください。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">db/migrate/2015xxxxxxxxxxx_add_group_id_to_users.rb"&gt;</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">AddGroupIdToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
<span class="hll">    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:group_id</span><span class="p">,</span> <span class="ss">:integer</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">多対1の場合は<code>belongs_to</code>、1対多の関係場合は<code>has_many</code>でアソシエーションを定義します。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題6：アソシエーションを定義しましょう。</h3>

<h5>作業ファイル：app/models/user.rb,app/models/group.rb</h5>
<h5>ヒント： 一対多の関係をそれぞれのモデルに指定しましょう。</h5>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/model/user.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

    <span class="c1">#accessor</span>
    <span class="kp">attr_accessor</span> <span class="ss">:group_key</span>

    <span class="c1">#devise config</span>
    <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
           <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span><span class="p">,</span> <span class="ss">:confirmable</span>

    <span class="c1">#association</span>
    <span class="c1"># 一つのuserは一つのgroupに依存する</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/model/group.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">class</span> <span class="nc">Group</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

    <span class="c1">#association</span>
<span class="hll">    <span class="c1"># 一つのgroupは複数のuserを持つ</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

    <curriculum-question-container class="ng-scope" data-order="6"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
</div>

<h2 id="18" class="ng-scope">パラメータとして送られる:group_keyが許可されるようにしよう</h2>

<p class="ng-scope">先ほど、フォームにgroup_keyの項目を追加したので新規登録やログインフォームからリクエストにgroup_keyが含まれるようになります。<br>
deviseを使っている場合、デフォルトでストロングパラメーターが設定されていてメールアドレス、パスワード以外のキーを受け取ることはできません。group_keyを受け取ることができるようにapplication_controller.rbに設定をしていきます。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>app/controllers/application_controller.rb</code>を以下のように更新してください。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">app/controllers/application_controller.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>
  <span class="c1"># Prevent CSRF attacks by raising an exception.</span>
  <span class="c1"># For APIs, you may want to use :null_session instead.</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:exception</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:configure_permitted_parameters</span><span class="p">,</span> <span class="k">if</span><span class="p">:</span> <span class="ss">:devise_controller?</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">configure_permitted_parameters</span>
</span><span class="hll">    <span class="c1"># sign_inのときに、group_keyも許可する</span>
</span><span class="hll">    <span class="n">devise_parameter_sanitizer</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="ss">:sign_in</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="ss">:group_key</span>
</span><span class="hll">    <span class="c1"># sign_upのときに、group_keyも許可する</span>
</span><span class="hll">    <span class="n">devise_parameter_sanitizer</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="ss">:sign_up</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="ss">:group_key</span>
</span><span class="hll">    <span class="c1">#account_updateのときに、group_keyも許可する</span>
</span><span class="hll">    <span class="n">devise_parameter_sanitizer</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="ss">:account_update</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="ss">:group_key</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><code>before_action :configure_permitted_parameters, if: :devise_controller?</code>この部分はリクエストがdeviseのコントローラーの場合はconfigure_permitted_parametersを実行するという設定をしました。簡単に言うと、新規登録、ログイン処理等で実行されるということです。devise_controller?はdeviseのヘルパーメソッドです。configure_permitted_parametersでは許可するパラメーターを追加しています。</p>

<h2 id="19" class="ng-scope">ユーザーの新規登録時にグループIDが保存されるようにする</h2>

<p class="ng-scope">複数の認証キーで認証できるように設定を行ないます。<br>
このあたりはRuby on Railsというよりdeviseのカスタマイズの領域なのでなんとなく理解してもらえば大丈夫です。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>app/models/user.rb</code>を以下のように更新してください。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">app/modle/user.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

  <span class="c1">#accessor</span>
  <span class="kp">attr_accessor</span> <span class="ss">:group_key</span>

  <span class="c1"># Include default devise modules. Others available are:</span>
  <span class="c1"># :confirmable, :lockable, :timeoutable and :omniauthable</span>
  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
<span class="hll">         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span>
</span>         <span class="ss">:validatable</span><span class="p">,</span> <span class="ss">:confirmable</span><span class="p">,</span>
<span class="hll">         <span class="ss">authentication_keys</span><span class="p">:</span> <span class="o">[</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:group_key</span><span class="o">]</span>
</span>
  <span class="c1">#association</span>
<span class="hll">  <span class="n">belongs_to</span> <span class="ss">:group</span>
</span><span class="hll">
</span>  <span class="c1">#validation</span>
<span class="hll">  <span class="n">before_validation</span> <span class="ss">:group_key_to_id</span><span class="p">,</span> <span class="k">if</span><span class="p">:</span> <span class="ss">:has_group_key?</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_first_by_auth_conditions</span><span class="p">(</span><span class="n">warden_conditions</span><span class="p">)</span>
</span><span class="hll">    <span class="n">conditions</span> <span class="o">=</span> <span class="n">warden_conditions</span><span class="o">.</span><span class="n">dup</span>
</span><span class="hll">    <span class="n">group_key</span> <span class="o">=</span> <span class="n">conditions</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:group_key</span><span class="p">)</span>
</span><span class="hll">    <span class="n">group_id</span> <span class="o">=</span> <span class="no">Group</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">key</span><span class="p">:</span> <span class="n">group_key</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class="hll">    <span class="n">email</span> <span class="o">=</span> <span class="n">conditions</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># devise認証を、複数項目に対応させる</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">group_id</span> <span class="o">&amp;&amp;</span> <span class="n">email</span>
</span><span class="hll">      <span class="n">where</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">[</span><span class="s2">"group_id = :group_id AND email = :email"</span><span class="p">,</span>
</span><span class="hll">        <span class="p">{</span> <span class="ss">group_id</span><span class="p">:</span> <span class="n">group_id</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="n">email</span> <span class="p">}</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class="hll">    <span class="k">elsif</span> <span class="n">conditions</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="ss">:confirmation_token</span><span class="p">)</span>
</span><span class="hll">      <span class="n">where</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class="hll">    <span class="k">else</span>
</span><span class="hll">      <span class="kp">false</span>
</span>    <span class="k">end</span>
<span class="hll">  <span class="k">end</span>
</span><span class="hll">
</span><span class="hll">  <span class="kp">private</span>
</span><span class="hll">  <span class="k">def</span> <span class="nf">has_group_key?</span>
</span>    <span class="n">group_key</span><span class="o">.</span><span class="n">present?</span>
<span class="hll">  <span class="k">end</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">group_key_to_id</span>
</span><span class="hll">    <span class="n">group</span> <span class="o">=</span> <span class="no">Group</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">key</span><span class="p">:</span> <span class="n">group_key</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create</span>
</span>    <span class="nb">self</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">処理の流れを簡単に解説していきます。</p>

<ul class="ng-scope">
<li><strong>9行目</strong></li>
</ul>

<p class="ng-scope">認証を行いたいキーを変更する場合は、<code>:authentication_keys</code>に指定するキーを変更します。<br>
今回の場合は<code>:email</code>にくわえて、<code>:group_key</code>を追加しています。これにより認証に<code>:group_key</code>が使われるようになります。</p>

<ul class="ng-scope">
<li><strong>17行目~32行目</strong></li>
</ul>

<p class="ng-scope"><code>self.find_first_by_auth_conditions</code>メソッドはdeviseに定義されているメソッドです。<br>
このメソッドはログインやアクセス時のユーザー認証時にユーザーのインスタンスを取得する役割を果たしています。</p>

<p class="ng-scope">今回のようにカスタマイズでもしない限り見ることはないですが、8行目でモジュールを読み込んだことで自動的に読み込まれています。</p>

<p class="ng-scope">カスタマイズのためにはオーバーライド（再定義による上書き）をして使います。</p>

<p class="ng-scope">デフォルトではemailとパスワードでテーブルから検索するようになっているので、新たにgroup_idを検索条件に追加しています。</p>

<ul class="ng-scope">
<li><strong>15行目、35行目~37行目、39行目~42行目</strong></li>
</ul>

<p class="ng-scope">15行目から処理の流れを説明します。<code>before_validation</code>メソッドはバリデーションを行う前に実行したい処理を書くときに使います。</p>

<p class="ng-scope"><code>group_key_to_id</code>メソッドは、<code>has_group_key?</code>によりインスタンスがあるときのみ発動します。そして、groupテーブルのkeyカラムから、<code>group_key</code>と一致するインスタンスを取り出し（なければインスタンスを生成し）、自身の<code>group_id</code>プロパティにそのidをセットしています。</p>

<p class="ng-scope"><i class="icon attention"></i> リレーションは基本、<code>id</code>によって行ないます。ただ今回、認証に用いているのは<code>group_key</code>です。ですが、例えば「techcamp」のような<strong>文字列のグループキーをユーザーのレコードに保存していくのは無駄が多い</strong>ため、このbefore_validation部分で<code>group_key</code>を<code>id</code>に変換しています。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="527" action="http://master.tech-camp.in/curriculums/147#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-730" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-730" name="check-730" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ユーザーの新規登録時にグループIDが保存されるようにuser.rbを編集できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope">グループ名を認証に使えるようにするためのカスタマイズは以上です。<br>
さっそく動作確認をしていきましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> SeaquelProからusersテーブルを空にして、再度新規登録を行ってください。</h3>

<p class="ng-scope"><img src="register-with-group-name.png" alt="グループIDをログインに加える"></p>

<p class="ng-scope">届いたメールからの認証も忘れずにお願いします。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> SeaquelProから正しくレコードが追加されていることを確認してください。</h3>

<p class="ng-scope">正しく登録できていれば、groupsテーブルにもレコードが追加され、usersテーブルのレコードとリレーションがはられているはずです。</p>

<p class="ng-scope"><img src="relation.png" alt="グループIDをログインに加える"></p>
</div>
          <!-- ngIf: curriculum.short_test -->
        </div>
      </div>
      <div class="col-md-3 col-sm-12" id="curriculumSideContainer">
        <curriculum-side-wrap id="sideWrap">
          <ul style="max-height: 295px;" class="list-group toc-tree" id="curriculumContents">
  <li class="list-group-item disabled">
    目次
  </li>
  <!-- ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding current" id="contents1" ng-click="clickContent(content.h1.id)">ログイン機能をつくろう:基本設定</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents2" ng-click="clickContent(h2.id)">deviseの設定ファイルを生成する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents3" ng-click="clickContent(h2.id)">認証メールのURLを設定する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents4" ng-click="clickContent(h2.id)">ルートパスを設定する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents5" ng-click="clickContent(h2.id)">フラッシュメッセージのタグをビューに埋め込む</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents6" ng-click="clickContent(h2.id)">デバイスのビューをカスタマイズする</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents7" ng-click="clickContent(h2.id)">ログインのためのUserモデルを作成する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents8" ng-click="clickContent(h2.id)">usersテーブルにメール認証に必要なカラムを作成する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents9" ng-click="clickContent(h2.id)">ログインしていないときにルートにアクセスすると、ログイン画面にリダイレクトするようにする</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents10" ng-click="clickContent(h2.id)">Railsを日本語化する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents11" ng-click="clickContent(h2.id)">メール認証のためのモジュールを読み込む</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents12" ng-click="clickContent(h2.id)">メール送信用サーバー（SMTPサーバー）の設定</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents13" ng-click="clickContent(h2.id)">ログアウトをつける</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding" id="contents14" ng-click="clickContent(content.h1.id)">ログイン機能をつくろう:応用設定</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents15" ng-click="clickContent(h2.id)">どのようなカスタマイズを行うのか理解しよう</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents16" ng-click="clickContent(h2.id)">グループ名を入力するフォームをつくろう</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents17" ng-click="clickContent(h2.id)">グループ名を保存するテーブルをつくろう</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents18" ng-click="clickContent(h2.id)">パラメータとして送られる:group_keyが許可されるようにしよう</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents19" ng-click="clickContent(h2.id)">ユーザーの新規登録時にグループIDが保存されるようにする</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents -->
</ul>
          <div style="" ng-show="check_count > 0" class="progress_box ng-scope">
  <!-- ngIf: showTroubleShooting() --><p class="terms ng-scope" ng-if="showTroubleShooting()">
    エラーが解決できない時：<br><a href="http://master.tech-camp.in/curriculums/25" target="_brank">トラブルシューティング</a>
  </p><!-- end ngIf: showTroubleShooting() -->
  <!-- ngIf: courseId != 9 && courseId != 10 --><p class="terms ng-scope" ng-if="courseId != 9 &amp;&amp; courseId != 10">
    分からない用語がある時：<br><a href="http://master.tech-camp.in/terms" target="_brank">用語一覧集</a>
  </p><!-- end ngIf: courseId != 9 && courseId != 10 -->
  <h4>
    進捗度<i class="ng-binding" id="numerator">0 / 39<span id="denominaotr"></span></i>
  </h4>
  <div class="progress">
    <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" class="pregress-bar progress-bar-info ng-binding" role="progressbar" style="width: 0%;">
      0%
    </div>
  </div>
</div>
          <curriculum-glossary class="ng-hide" ng-show="curriculum.curriculum_type == 2 || curriculum.curriculum_type == 3"></curriculum-glossary>
          <button class="curriculum-report-button" ng-click="show_curriculum_report()">
            <img src="idea.svg" height="20px" width="20px">
            | このカリキュラムへのご要望
          </button>
        </curriculum-side-wrap>
      </div>
    </div>
    <ul style="" class="pager" ng-hide="loading">
  <li class="previous">
    <a style="" class="" ng-click="go_previous()" ng-show="curriculum.previous_id">前のカリキュラム</a>
  </li>
  <li class="next">
    <a style="" class="" ng-class="{ disable: curriculum.short_test.can_see_next_curriculum == false }" ng-click="go_next()" ng-show="curriculum.next_id">次のカリキュラム</a>
  </li>
</ul>
  </div>
</curriculum>
<div style="" class="ng-scope ng-isolate-scope ng-hide" id="loading" ng-show="loading">
  <svg height="44" stroke="#444" viewBox="0 0 44 44" width="44" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" strole-width="2"><circle cx="22" cy="22" r="1"><animate attributeName="r" begin="0s" calcMode="spline" dur="1.8s" keySplines="0.165, 0.84, 0.44, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 20"></animate><animate attributeName="stroke-opacity" begin="0s" calcMode="spline" dur="1.8s" keySplines="0.3, 0.61, 0.355, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 0"></animate></circle><circle cx="22" cy="22" r="1"><animate attributeName="r" begin="-0.9s" calcMode="spline" dur="1.8s" keySplines="0.165, 0.84, 0.44, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 20"></animate><animate attributeName="stroke-opacity" begin="-0.9s" calcMode="spline" dur="1.8s" keySplines="0.3, 0.61, 0.355, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 0"></animate></circle></g></svg>
</div>

<div class="curriculum-image__modal modal ng-scope" id="curriculum-image__modal" role="dialog" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button class="close" data-dismiss="modal" ng-click="close()"><span aria-hidden="true">×</span></button>
      </div>
      <div class="modal-body">
        <div class="curriculum-image__img__body">
          <img class="curriculum-image__img zoom-out" id="curriculum-image__img">
        </div>
      </div>
    </div>
  </div>
</div>


</div><div class="chat-window ng-scope" ng-controller="SupportChatController" ng-init="init('大宅誠人', '/uploads/noimage.png', 1867, 2988, 0, 'accepted_questions', 'machi4271', '2')"><div aria-hidden="true" aria-labelledby="myLargeModalLabel" class="modal fade" id="chats-modal" role="dialog" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="wrapper">
  <header class="chat-header">
    <div class="row">
      <div class="col-md-6 col-xs-12 chat-header-left">
        <h2>
          質問チャット
        </h2>
        <div class="chat-support-state active in-support ng-binding">
          <img src="icn_qsupport.png" width="16">質問受付中
        </div>
      </div>
    </div>
  </header>
  <div class="chat-layout" load-more="load-more">
    <!-- ngRepeat: message in messages -->
  </div>
</div><footer class="chat-footer"><form accept-charset="UTF-8" action="http://master.tech-camp.in/api/chat_messages" class="new_chat_message ng-pristine ng-valid" data-remote="true" enctype="multipart/form-data" id="new_chat_message" method="post" ng_submit="afterSubmitted()"><div style="display: none;"><input name="utf8" value="✓" type="hidden"></div><input id="chat_message_chat_id" name="chat_message[chat_id]" value="2988" type="hidden"><div class="chat-box"><div class="row"><div class="chat-upload col-xs-1"><div class="chat-upload-btn"><img class="chat-upload-icn" src="icn_fileupload.png"><input class="ng-pristine ng-untouched ng-valid" id="chat_message_file" name="chat_message[file]" ng_model="file" onchange="angular.element(this).scope().showSubmitButtonAndHideSkypeButtonAndPreview()" type="file"><div class="chat-uploading-image ng-hide" ng-show="isUploading" ng-style="isUploadingStyle"><div class="image_del ng-hide" ng-click="clearImage()" ng-show="imageDeletable"><img alt="close" src="icon_close_red.svg"></div></div></div></div><div class="chat-textarea col-xs-8"><textarea class="form-control ng-pristine ng-untouched ng-valid" id="chat_message_content" name="chat_message[content]" ng_model="content" placeholder="次のコードの意味がよくわからないので教えていただけないでしょうか？" row="3"></textarea></div><div class="chat-submit col-xs-3"><input style="display: none;" class="submit-btn" id="submit_chat_message" name="commit" value="送信" type="submit"><div class="skype-popup"><a title="" data-original-title="" class="trigger btn btn-default" href="#">Skypeで直接聞く</a><div class="head hide">Skype質問を申請すると<br>担当メンターから着信が届きます。<br>以下の項目をご確認ください。</div><div class="content hide"><p class="ng-binding">あなたのSkypeID:　machi4271<br>質問箇所: <small>※スマートフォン、タブレットでのSkypeはご遠慮ください<br>※通話が始まったらすぐに画面共有をお願いします</small></p><a class="skype-support" href="http://master.tech-camp.in/curriculums/147">Skype質問を申請する</a><div class="close">×</div></div></div></div></div></div></form></footer></div></div></div><div class="chat-dock" ng-click="getMessages(); showModal()">質問サポート<!-- ngIf: unreadSize != 0 --><span class="dock-support-state_text in-support ng-binding"><img class="icn_qsupport" src="icn_qsupport_white.png" width="10">質問受付中</span></div></div></body>
</html>
