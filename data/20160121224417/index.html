<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8"><title>タイムラインをつくろう２</title><meta content="authenticity_token" name="csrf-param">
<meta content="Y2UzkG5GQl5jzIBq3nOdxAEomQen5uuix05BO4pPfYw=" name="csrf-token"><link href="favicon.ico" rel="icon" sizes="16x16 32x32 48x48 128x128 256x256">
<link rel="stylesheet" type="text/css" href="index.css" media="all">
</head>
<body class="ng-scope" ng-app="techMaster"><div class="navbar main_header navbar-fixed-top navbar-default" role="navigation"><div class="container"><div class="navbar-header"><button aria-controls="navbar" aria-expanded="false" class="navbar-toggle collapsed" data-target="#navbar" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="http://master.tech-camp.in/" target="_self"><img src="logo.png"></a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav navbar-right"><li class="text">終了まであと<i class="limit_time">10</i>日</li><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" id="profileDropdown" style="padding: 10px 7px; cursor: pointer;"><img class="nav-proimg" src="noimage.png">大宅 誠人</a><ul class="dropdown-menu" id="profileDropdown"><li><a class="mypage-link" href="http://master.tech-camp.in/users/mypage" target="_self">マイページを見る</a></li><li><a href="http://master.tech-camp.in/users" target="_self">十三期生一覧</a></li></ul></li></ul></div></div></div><div class=""></div><!-- ngView:  --><div class="ng-scope" ng-view=""><curriculum style="display: inline;" class="ng-scope">
  <div class="container" id="curriculum">
    <div class="row curriculum-inner">
      <div class="col-lg-12 main" ng-init="init()">
        <div ng-show="curriculum.image" class="page-header page" style="background-image: url('visual_image.jpg');">
  <h1 class="ng-binding">
    Railsアプリケーション開発3 第5章<small class="ng-binding">〜タイムラインをつくろう２〜</small>
  </h1>
  <!-- ngIf: curriculum.image.description.length --><div style="" class="flickr_attr ng-binding ng-scope" ng-if="curriculum.image.description.length">
    2013年に日本の文化遺産に登録された富士山。富士山といえば、銭湯の絵も有名。しかし、銭湯に「富士山」を描くペンキ絵師は日本で２名、見習いの女性が１名の計３名しかいない。もしかしたら、銭湯に富士山がなくなる日もあるかもしれない。<a class="ng-binding" href="https://www.flickr.com/photos/golfztudio/9914620184" target="_top">Thanapol Marattan - Mount Fuji</a>
  </div><!-- end ngIf: curriculum.image.description.length -->
</div>
      </div>
      <div class="col-md-9 col-sm-12" id="curriculumMainContainer">
        <div class="curriculum_content">
          <div class="curriculum_text ng-scope" compile-progress-notifier="willCompiledCurriculumText" ng-controller="CurriculumHintController"><h1 id="1" class="ng-scope">タイムラインに回答を表示する</h1>

<p class="ng-scope">今の仕様だと回答を見たくても、度々、個別質問ページに行かないと回答が見ることができないため<br>
少し面倒です。このままですと回答を見落としてしまう可能性もあります。そこで質問への回答をタイムラインにも流すようにしようと思います。</p>

<h3 class="ng-scope">【例】</h3>

<p class="ng-scope"><img src="sample-timeline-add-answer.png" alt="text"></p>

<h2 id="2" class="ng-scope">質問と回答が時系列順で入ったインスタンス配列をつくるには？</h2>

<p class="ng-scope">タイムラインに回答と質問を表示するためには、質問と回答が時系列順で入ったインスタンス配列を作成する必要があります。</p>

<p class="ng-scope"><img src="instanse-array-for-timeline.png" alt="text"></p>

<p class="ng-scope">どうやったらこのインスタンス配列がつくれるか考えていきましょう。</p>

<p class="ng-scope"><i class="icon attention"></i>厳密には「インスタンスの配列」ではなくActiveRecord_Relationのインスタンスですがここでは便宜上、インスタンスの配列と呼ぶことにします。</p>

<p class="ng-scope">１つのテーブルからインスタンスを取得して表示するのは簡単でした。<br>
例えば、以下の様にすれば、そのグループの質問を取得できます。</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="vi">@questions</span> <span class="o">=</span> <span class="no">Question</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">group_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">updated_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">では、group_idが1のanswersのレコードを取得するにはどうしたらいいと思いますか。<br>
answers自体にはgroup_idカラムはありません。answersとリレーションしているquestionsのレコードがgroup_idを持っています。<br>
アソシエーションを利用すれば以下のような記述で特定のgroup_idのanswersのレコードを取得できます。</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="vi">@answers</span> <span class="o">=</span> <span class="no">Answer</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:question</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">questions</span><span class="p">:{</span><span class="ss">group_id</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">updated_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">上２つの方法を使えば質問と回答のインスタンス配列を別々に取得することができます。<br>
しかし、今回やりたいことは時系列で並び変えて１つの配列にすることです。例えば以下のようにrubyのメソッドを駆使して<br>
２つの配列を１つにまとめ並び変えることは、できなくはないです。(以下のコード自体は理解する必要はありません)</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="vi">@questions</span> <span class="o">=</span> <span class="no">Question</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">group_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">updated_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span>
<span class="vi">@answers</span> <span class="o">=</span> <span class="no">Answer</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:question</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">questions</span><span class="p">:{</span><span class="ss">group_id</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">updated_at</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span>
<span class="vi">@answers</span> <span class="o">=</span> <span class="vi">@answers</span><span class="o">.</span><span class="n">to_a</span>
<span class="n">new_array</span> <span class="o">=</span> <span class="o">[]</span>
<span class="vi">@questions</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">question</span><span class="o">|</span>
  <span class="n">tmp_answers</span> <span class="o">=</span> <span class="vi">@answers</span><span class="o">.</span><span class="n">dup</span>
  <span class="n">tmp_answers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">answer</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">&gt;</span> <span class="n">question</span><span class="o">.</span><span class="n">updated_at</span>
      <span class="n">new_array</span> <span class="o">&lt;&lt;</span> <span class="vi">@answers</span><span class="o">.</span><span class="n">shift</span> <span class="k">unless</span> <span class="vi">@answers</span><span class="o">.</span><span class="n">empty?</span>
      <span class="c1">#shiftメソッドは、配列の最初の要素を削除し、その要素を返します。</span>
    <span class="k">else</span>
      <span class="n">new_array</span> <span class="o">&lt;&lt;</span> <span class="n">question</span>
      <span class="k">break</span>
    <span class="k">end</span>
    <span class="n">new_array</span> <span class="o">&lt;&lt;</span> <span class="n">question</span> <span class="k">if</span> <span class="vi">@answers</span><span class="o">.</span><span class="n">empty?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">しかしこの方法だとコードが長くなってしまいますし、ページネーションを実現するのが難しくなります。<br>
<strong>そして、最もクリティカルな問題は質問、回答以外のインスタンスが増えたときにどんどん処理が複雑になっていくことです。</strong></p>

<p class="ng-scope">よりスマートにまとめるために、タイムライン用のテーブルを１つ用意してそこからレコード毎に質問や回答にリレーションさせるという方法があります。<br>
以下のようなイメージです。</p>

<p class="ng-scope"><img src="smart-timeline-image.png" alt="text"></p>

<p class="ng-scope">今説明したイメージを実現するために<strong>ポリモーフィック関連</strong>というrailsの仕組みを利用します。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_510"></i> ポリモーフィック関連</h3>

<p class="ng-scope">ポリモーフィックは、関連付けのやや高度な応用です。ある1つのモデルが他の複数のモデルに属していることを、1つのアソシエーション定義だけで表現することができます。例えば、画像をアップロードして、ユーザーの画像や企業の画像に設定できるサービスがあるとします。アップロードされた画像は、ユーザーの画像もしくは企業の画像として紐付けられます。</p>

<p class="ng-scope"><img src="polymofic-image.png" alt="text"></p>

<p class="ng-scope">画像はファイル名や大きさ、撮影した場所なども情報として持っているので、企業の画像に設定するにしろ、ユーザー個人の画像に設定するにしろ、１つのテーブルでまとめて管理したいです。<br>
通常のアソシエーションを利用して以下のように定義することもできます。</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Image</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:company</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Company</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:images</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:images</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">この定義には幾つか問題があります</p>

<ul class="ng-scope">
<li>新たにImageが従属するモデルを作った際、Imageのbelongs_toを増やす必要がある（＝カラムを追加しないといけない）</li>
<li>Imageモデルのインスタンスから直接、従属しているモデル（CompanyなのかUserなのか）を判別する事ができない。</li>
</ul>

<p class="ng-scope">これらの問題を解決するために、ポリモーフィック関連を利用します。<br>
ポリモーフィック関連を利用すると以下のように定義できます。</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Image</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Company</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:images</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:imageable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:images</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:imageable</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">テーブルのカラムは以下のようになります。</p>

<p class="ng-scope"><img src="table-polymofic.png" alt="text"></p>

<p class="ng-scope"><code>imageable_type</code>には「Company」や「User」のような所属するクラス名が、<code>imageable_id</code>にはリレーションしているインスタンスのidが格納されます。<br>
ポリモーフィック関連の定義により以下の様に利用することができます。<br>
imageableに注目してください。この名前に特に決まりはないのですが~ableとつけるのが慣例となっています。</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c1">#例1:Companyモデルに帰属する複数の画像を取得する</span>
<span class="n">company</span> <span class="o">=</span> <span class="no">Company</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">company</span><span class="o">.</span><span class="n">images</span>
<span class="c1">#=&gt; [&lt;Image id:1 ..&gt;,&lt;Image id:2 ..&gt;]</span>

<span class="c1">#例2:Userモデルに帰属する複数の画像を取得する</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">user</span><span class="o">.</span><span class="n">images</span>
<span class="c1">#=&gt; [&lt;Image id:3 ..&gt;,&lt;Image id:4 ..&gt;]</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">&nbsp;例1、例2は、has_many定義により帰属する画像を取得しています。通常のアソシエーションとの違いは、親であるcompany, もしくはuserのidを保持するカラムはあるが、それがcompany_idやuser_idといった名前ではない、という点です。</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c1">#例3:Imageモデルが帰属するインスタンスを取得する(帰属先が企業の場合)</span>
<span class="n">image</span> <span class="o">=</span> <span class="no">Image</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">image</span><span class="o">.</span><span class="n">imageable</span>
<span class="c1">#=&gt; &lt;Company id:1 ..&gt;</span>

<span class="c1">#例4:Imageモデルが帰属するインスタンスを取得する(帰属先がユーザーの場合)</span>
<span class="n">image</span> <span class="o">=</span> <span class="no">Image</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">image</span><span class="o">.</span><span class="n">imageable</span>
<span class="c1">#=&gt; &lt;User id:1 ..&gt;</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">&nbsp;例3、例4は、Imageが帰属するインスタンスを取得しています。<code>image.imageable</code>と記述するだけで関連先のインスタンスを取得することができます。ここで重要なのは、<strong>Imageクラスのインスタンスがどのモデルに帰属しているかが分からなくても<code>.imageable</code>と記述するだけで関連先のインスタンスを取得できる</strong>という点です。</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c1">#例5: Companyモデルに帰属するImageクラスのインスタンスを作成する</span>
<span class="n">company</span> <span class="o">=</span> <span class="no">Company</span><span class="o">.</span><span class="n">create</span>
<span class="no">Image</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">imageable_id</span><span class="p">:</span> <span class="n">company</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="ss">imageable_type</span><span class="p">:</span> <span class="n">company</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
<span class="c1">#=&gt;  INSERT INTO `Images` (`imageable,_id`, `imageable,_type`, `created_at`, `updated_at`) VALUES (1, 'Company', '2015-0x-0x..', '2015-0x-0x..')</span>

<span class="c1">#例6: Companyモデルに帰属するImageクラスのインスタンスを作成する</span>
<span class="n">company</span> <span class="o">=</span> <span class="no">Company</span><span class="o">.</span><span class="n">create</span>
<span class="n">company</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">create</span>
<span class="c1">#=&gt;  INSERT INTO `Images` (`imageable,_id`, `imageable,_type`, `created_at`, `updated_at`) VALUES (1, 'Company', '2015-0x-0x..', '2015-0x-0x..')</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">例5と例6は、<strong>同じ処理を意味しています。</strong></p>

<p class="ng-scope">例5はcreateしたCompanyクラスのインスタンスのidとクラス名を利用して、新たにImageをcreateしています。例6はポリモーフィック関連を利用して、Imageクラスを作成しています。</p>

<p class="ng-scope"><code>company.images.create</code>この部分は違和感を覚えるかもしれませんが、Companyに帰属するImagesのインスタンスを1つ作成した（レコードを追加した）という意味です。<br>
<code>company.images</code>は複数なのに、なんでcreateが動かせるの？と疑問に思われる方もいるかもしれません。ただ、ここはポリモーフィックの文法なので覚えてしまいましょう。例5と違い、帰属するインスタンスのidやクラス名を入力しなくて良いというメリットがあります。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="556" action="http://master.tech-camp.in/curriculums/150#">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-809" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-809" name="check-809" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ポリモーフィックはある1つのモデルが他の複数のモデルに属していることを、1つのアソシエーション定義だけで表現することができます。</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-810" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-810" name="check-810" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">1つのモデルが他の複数のモデルに属していることを通常のアソシエーションで実行するとデメリットがあることを理解できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="3" class="ng-scope">タイムライン用のモデルを作成する</h2>

<p class="ng-scope">それでは、ポリモーフィック関連を利用して二種類の配列をrubyで並びかえるよりスマートに実装していきましょう。<br>
タイムライン用のモデル名は<code>FeedContent</code>とします。</p>

<p class="ng-scope"><i class="icon attention"></i>モデル名は、複数形にできる名前にします。例えば TimeLine だとモデル名とテーブル名がうまく噛み合わなくなります</p>

<h3 class="ng-scope">
<i class="icon pen"></i> ターミナルで以下のコマンドを実行してください。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="err">$</span> <span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">feed_content</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> 指定したファイルを以下のように更新後、ターミナルで<code>rake db:migrate</code>を実行してください。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">db/migrate/2015xxxxxxx_create_feed_contents.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateFeedContents</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:feed_contents</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
<span class="hll">      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:content_id</span>
</span><span class="hll">      <span class="n">t</span><span class="o">.</span><span class="n">string</span>  <span class="ss">:content_type</span>
</span><span class="hll">      <span class="n">t</span><span class="o">.</span><span class="n">integer</span>  <span class="ss">:group_id</span>
</span><span class="hll">      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span>    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">feed_contentsテーブルには、質問、回答それぞれと同じ<code>updated_at</code>、<code>group_id</code>を保存します。これらは、最終的にタイムラインを取得する際に必ず必要なカラムです。</p>

<p class="ng-scope"><i class="icon attention"></i>前述のポリモーフィック関連の解説では~ableという名前にしていました。今回もfeed_contentable_id、feed_contentable_typeとしても問題ないのですが少し長くなってしまうのでcontentという名前を使っていきます。</p>

<h2 id="4" class="ng-scope">モデルにポリモーフィック関連を定義する</h2>

<p class="ng-scope">これから下記の通りのような関係でポリモーフィック関連を定義していきます。<br>
<img src="polymor-question-image.png" alt="text"></p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題1：ポリモーフィック関連を定義しましょう。</h3>

    <h5>作業ファイル：feed_content.rb / question.rb / answer.rb</h5>
    <h5>ヒント1： feed_content.rbでは1つのcontentを持ち、polymorphicオプションを追加しましょう。</h5>
    <h5>ヒント2： question.rbとanswer.rbはasオプションを追加し、as: :contentと指定しましょう。</h5>
    <h5>ヒント3： またquestion.rbとanswer.rbはdependentオプションもそれぞれ追加しましょう。</h5>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/model/feed_content.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">class</span> <span class="nc">FeedContent</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">    <span class="err">ポリモーフィック関連の定義で一つの</span><span class="n">content</span><span class="err">に紐づくよう編集する。</span>
</span>  <span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/question.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">class</span> <span class="nc">Question</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

    <span class="c1">#association</span>
    <span class="n">belongs_to</span> <span class="ss">:user</span>
    <span class="n">belongs_to</span> <span class="ss">:group</span>
    <span class="n">has_many</span> <span class="ss">:answers</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
<span class="hll">    <span class="c1">#ポリモーフィック関連の定義でひとつのfeed_contentに紐づくよう編集する。dependentオプションも追加する。</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/answer.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">class</span> <span class="nc">Answer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="c1">#association</span>
    <span class="n">belongs_to</span> <span class="ss">:question</span>
    <span class="n">belongs_to</span> <span class="ss">:user</span>
    <span class="c1">#ポリモーフィック関連の定義でひとつのfeed_contentに紐づくよう編集する。dependentオプションも追加する。</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

  <curriculum-question-container class="ng-scope" data-order="1"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
</div>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="557" action="http://master.tech-camp.in/curriculums/150#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-811" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-811" name="check-811" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">タイムライン用のモデルfeed_contentを作成できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-812" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-812" name="check-812" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">モデルにポリモーフィック関連を定義できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="5" class="ng-scope">質問、回答の投稿時にFeedContentsも同時に追加する</h2>

<p class="ng-scope">ポリモーフィック関連を利用するためには、質問及び回答が投稿された時にFeedContentを同時に追加する必要があります。</p>

<p class="ng-scope">例えば質問を投稿する場合、以下の様な実装が考えられます。</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">QuestionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="n">question</span> <span class="o">=</span> <span class="no">Question</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">create_params</span><span class="p">)</span>
</span><span class="hll">    <span class="n">question</span><span class="o">.</span><span class="n">feed_content</span> <span class="o">=</span> <span class="no">FeedContent</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">group_id</span><span class="p">:</span> <span class="n">question</span><span class="o">.</span><span class="n">group_id</span><span class="p">,</span> <span class="ss">updated_at</span><span class="p">:</span> <span class="n">question</span><span class="o">.</span><span class="n">updated_at</span><span class="p">)</span>
</span>    <span class="n">redirect_to</span> <span class="ss">:root</span> <span class="ow">and</span> <span class="k">return</span>
  <span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">この実装方法はあまり好ましくありません。なぜなら、他のコントローラーで<code>Question.create</code>を使う場合に必ず続けて<code>quetsion.feed_content = FeedContent.create</code>を記述する必要があるからです。またクラスというのは本来責任分担のために存在します。<strong>「<code>Question</code>を作成したときは必ずFeedContentを更新する」</strong>という決まりはQuestionモデルクラスが担うべきです。このような場合はモデルのコールバックを利用するといいでしょう。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_511"></i> ActiveRecord コールバック</h3>

<p class="ng-scope">ActiveRecordコールバックとは、作成/保存/更新/削除/検証/等、特定のイベント発生時に呼び出されるメソッドのことです。<br>
例えば、「Userクラスのインスタンスが新規作成される前に、必ず友人招待用のランダムなコードを設定する」といったことができます。実際のコードを見ていきましょう。</p>

<div class="code-frame ng-scope" data-lang="ruby"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_create</span> <span class="ss">:set_invitation_code</span>

  <span class="kp">private</span>
  <span class="k">def</span> <span class="nf">set_invitation_code</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">invitation_code</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#ランダムな英数字を生成する</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span>
<span class="nb">p</span> <span class="n">user</span><span class="o">.</span><span class="n">invitation_code</span> <span class="c1">#=&gt; "81de"</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">before_createは、モデルが新規作成される前に呼び出されるコールバックです。<br>
このコールバックを設定することによりUserを新規作成したときは、必ず招待コードが設定されます。<br>
コールバックは、呼び出されるタイミングの違いで非常に多くの種類があります。いま全てを覚える必要はないのでざっと目を通しておいてください。</p>

<h3 class="ng-scope">利用可能なコールバック</h3>

<p class="ng-scope"><strong>オブジェクトの作成</strong></p>

<ul class="ng-scope">
<li>before_validation</li>
<li>after_validation</li>
<li>before_save</li>
<li>around_save</li>
<li>before_create</li>
<li>around_create</li>
<li>after_create</li>
<li>after_save</li>
</ul>

<p class="ng-scope"><strong>オブジェクトの更新</strong></p>

<ul class="ng-scope">
<li>before_validation</li>
<li>after_validation</li>
<li>before_save</li>
<li>around_save</li>
<li>before_update</li>
<li>around_update</li>
<li>after_update</li>
<li>after_save</li>
</ul>

<p class="ng-scope"><strong>オブジェクトのdestroy</strong></p>

<ul class="ng-scope">
<li>before_destroy</li>
<li>around_destroy</li>
<li>after_destroy</li>
</ul>

<p class="ng-scope">それでは、質問、回答の新規投稿時にもコールバックでFeedContentがcreateされるように実装していきます。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> 指定したファイルを以下のように更新してください。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/question.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>11
12
13
14
15
16
17
18
19
20
21</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="hll">  <span class="c1">#callback</span>
</span><span class="hll">  <span class="n">after_create</span> <span class="ss">:create_feed_content</span>
</span>
  <span class="k">def</span> <span class="nf">user_answer</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="no">Answer</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">user_id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="ss">question_id</span><span class="p">:</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>

<span class="hll">  <span class="kp">private</span>
</span><span class="hll">  <span class="k">def</span> <span class="nf">create_feed_content</span>
</span><span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">feed_content</span> <span class="o">=</span> <span class="no">FeedContent</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">group_id</span><span class="p">:</span> <span class="n">group_id</span><span class="p">,</span> <span class="ss">updated_at</span><span class="p">:</span> <span class="n">updated_at</span><span class="p">)</span>
</span><span class="hll">  <span class="k">end</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/answer.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="hll">  <span class="c1">#callback</span>
</span><span class="hll">  <span class="n">after_create</span> <span class="ss">:create_feed_content</span>
</span>
<span class="hll">  <span class="c1">#validation</span>
</span><span class="hll">  <span class="n">validates_presence_of</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:text</span>
</span>
<span class="hll">  <span class="kp">private</span>
</span><span class="hll">  <span class="k">def</span> <span class="nf">create_feed_content</span>
</span><span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">feed_content</span> <span class="o">=</span> <span class="no">FeedContent</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">group_id</span><span class="p">:</span> <span class="n">question</span><span class="o">.</span><span class="n">group_id</span><span class="p">,</span> <span class="ss">updated_at</span><span class="p">:</span> <span class="n">updated_at</span><span class="p">)</span>
</span><span class="hll">  <span class="k">end</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> rails cでAnswerとQuestionを新規作成してコールバックが動作することを確認しましょう。</h3>

<p class="ng-scope"><i class="icon attention"></i>questionsテーブルとanswersテーブルを一度全て空にして実行してください。</p>

<p class="ng-scope"><i class="icon attention"></i>user_idとquestion_idはそれぞれusersテーブル、questionsテーブルに存在するid番号にしてください。前の作業で一度questionsテーブルを空にしているためidが1から始まることはありません。現在は例として5を入れています。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">コンソール</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
<td class="code">
<div class="highlight"><pre>Question.create<span class="o">(</span>user_id: 1, group_id: 1, text: <span class="s2">"test"</span><span class="o">)</span>
   <span class="o">(</span>0.2ms<span class="o">)</span>  BEGIN
SQL <span class="o">(</span>3.0ms<span class="o">)</span>  INSERT INTO <span class="sb">`</span>questions<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>user_id<span class="sb">`</span>, <span class="sb">`</span>group_id<span class="sb">`</span>, <span class="sb">`</span>text<span class="sb">`</span>, <span class="sb">`</span>created_at<span class="sb">`</span>, <span class="sb">`</span>updated_at<span class="sb">`</span><span class="o">)</span> VALUES <span class="o">(</span>1, 1, <span class="s1">'test'</span>, <span class="s1">'201xx..'</span>, <span class="s1">'201xx..'</span><span class="o">)</span>
SQL <span class="o">(</span>0.3ms<span class="o">)</span>  INSERT INTO <span class="sb">`</span>feed_content<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>group_id<span class="sb">`</span>, <span class="sb">`</span>created_at<span class="sb">`</span>, <span class="sb">`</span>content_id<span class="sb">`</span>, <span class="sb">`</span>content_type<span class="sb">`</span>, <span class="sb">`</span>updated_at<span class="sb">`</span><span class="o">)</span> VALUES <span class="o">(</span><span class="s1">'1'</span>, <span class="s1">'201xx..'</span>, 7, <span class="s1">'Question'</span>, <span class="s1">'201xx..'</span><span class="o">)</span>
   <span class="o">(</span>0.8ms<span class="o">)</span>  <span class="nv">COMMIT</span>
<span class="o">=</span>&gt; &lt;Question:0x007fa1b0a372e0 id: 7, user_id: 1, text: <span class="p">&amp;</span>quot<span class="p">;</span><span class="nb">test</span><span class="p">&amp;</span>quot<span class="p">;</span>, group_id: 1, created_at: Sat, 0x Mar 201xxx, updated_at:  Sat, 0x Mar 201xxx&gt;

Answer.create<span class="o">(</span>question_id: 5, user_id: 1, text: <span class="s2">"test"</span><span class="o">)</span>
   <span class="o">(</span>0.2ms<span class="o">)</span>  BEGIN
SQL <span class="o">(</span>0.3ms<span class="o">)</span>  INSERT INTO <span class="sb">`</span>answers<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>question_id<span class="sb">`</span>, <span class="sb">`</span>user_id<span class="sb">`</span>, <span class="sb">`</span>created_at<span class="sb">`</span>, <span class="sb">`</span>updated_at<span class="sb">`</span><span class="o">)</span> VALUES <span class="o">(</span>1, 1, <span class="s1">'201xx..'</span>, <span class="s1">'201xx..'</span><span class="o">)</span>
Question Load <span class="o">(</span>0.4ms<span class="o">)</span>  SELECT  <span class="sb">`</span>questions<span class="sb">`</span>.* FROM <span class="sb">`</span>questions<span class="sb">`</span> WHERE <span class="sb">`</span>questions<span class="sb">`</span>.<span class="sb">`</span>id<span class="sb">`</span> <span class="o">=</span> <span class="m">1</span>  ORDER BY created_at DESC LIMIT 1
SQL <span class="o">(</span>0.3ms<span class="o">)</span>  INSERT INTO <span class="sb">`</span>feed_content<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>group_id<span class="sb">`</span>, <span class="sb">`</span>created_at<span class="sb">`</span>, <span class="sb">`</span>content_id<span class="sb">`</span>, <span class="sb">`</span>content_type<span class="sb">`</span>, <span class="sb">`</span>updated_at<span class="sb">`</span><span class="o">)</span> VALUES <span class="o">(</span><span class="s1">'1'</span>, <span class="s1">'201xx..'</span>, 10, <span class="s1">'Answer'</span>, <span class="s1">'201xx..'</span><span class="o">)</span>
   <span class="o">(</span>1.5ms<span class="o">)</span>  <span class="nv">COMMIT</span>
<span class="o">=</span>&gt; &lt;Answer:0x007fa1addbcaf8 id: 10, question_id: 1, user_id: 1, text: nil, created_at: Sat, 0x Mar 201xxx, updated_at:  Sat, 0x Mar 201xxx&gt;
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">以下のようにfeed_contentsテーブルにレコードが追加されていればコールバックに成功しています。</p>

<p class="ng-scope"><img src="comfirm-seaquel-pro-for-polymofic.png" alt="text"></p>

<h3 class="ng-scope">
<i class="icon pen"></i> ポリモーフィック関連でリレーション先が呼びだせることを確認しましょう。</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">コンソール</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">feed_contents</span> <span class="o">=</span> FeedContent.all
  FeedContent Load <span class="o">(</span>0.4ms<span class="o">)</span>  SELECT <span class="sb">`</span>feed_contents<span class="sb">`</span>.* FROM <span class="sb">`</span>feed_contents<span class="sb">`</span>
<span class="o">=</span>&gt; <span class="o">[</span><span class="c">#&lt;FeedContent:0x007fa1ab0cd8f8 id: 6, content_id: 8, content_type: "Question", group_id: "1",...&gt;,</span>
 <span class="c">#&lt;FeedContent:0x007fa1ab0cd588 id: 7, content_id: 11, content_type: "Answer", group_id: "1", ...&gt;]</span>

feed_contents.each <span class="k">do</span> <span class="p">|</span>feed_content<span class="p">|</span> puts <span class="s2">"---------"</span><span class="p">;</span> p feed_content.content<span class="p">;</span> end
---------
  Question Load <span class="o">(</span>0.4ms<span class="o">)</span>  SELECT  <span class="sb">`</span>questions<span class="sb">`</span>.* FROM <span class="sb">`</span>questions<span class="sb">`</span> WHERE <span class="sb">`</span>questions<span class="sb">`</span>.<span class="sb">`</span>id<span class="sb">`</span> <span class="o">=</span> <span class="m">8</span> LIMIT 1
<span class="c">#&lt;Question id: 8, user_id: 1, text: "test", group_id: 1, created_at: "2015-03-07 06:55:56", updated_at: "2015-03-07 06:55:56"&gt;</span>
---------
  Answer Load <span class="o">(</span>0.4ms<span class="o">)</span>  SELECT  <span class="sb">`</span>answers<span class="sb">`</span>.* FROM <span class="sb">`</span>answers<span class="sb">`</span> WHERE <span class="sb">`</span>answers<span class="sb">`</span>.<span class="sb">`</span>id<span class="sb">`</span> <span class="o">=</span> <span class="m">11</span> LIMIT 1
<span class="c">#&lt;Answer id: 11, question_id: 8, user_id: 1, text: nil, created_at: "2015-03-07 06:56:18", updated_at: "2015-03-07 06:56:18"&gt;</span>
<span class="o">=</span>&gt; <span class="o">[</span><span class="c">#&lt;FeedContent:0x007fa1ab0cd8f8 id: 6, content_id: 8, content_type: "Question", group_id: "1", ... &gt;,</span>
 <span class="c">#&lt;FeedContent:0x007fa1ab0cd588 id: 7, content_id: 11, content_type: "Answer", group_id: "1", ... &gt;]</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">FeedContentクラスのインスタンス配列をeachで回して、それぞれがリレーションしているモデルのインスタンスを取得することができました。<br>
タイムラインで利用するイメージはもてたでしょうか。</p>

<h3 class="ng-scope"></h3><p class="ng-scope"><i class="icon attention"></i>ここまで問題なければ、feed_contents,answers,questionsテーブルを空にしておきましょう。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="558" action="http://master.tech-camp.in/curriculums/150#">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-813" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-813" name="check-813" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ActiveRecordコールバックとは一定のイベント発生時に呼び出されるメソッドのこと</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="559" action="http://master.tech-camp.in/curriculums/150#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-814" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-814" name="check-814" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">それぞれのモデルに対してコールバックを指定することができた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-815" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-815" name="check-815" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">AnswerとQuestionを新規作成してコールバックが動作することを確認できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-816" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-816" name="check-816" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">ポリモーフィック関連でリレーション先が呼びだせることを確認できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="6" class="ng-scope">ビューにタイムラインのインスタンス配列を渡す</h2>

<p class="ng-scope">トップページでタイムラインを表示するために、ログインユーザーが所属するグループのFeedContentを取得する必要があります。<br>
GroupからのアソシエーションでFeedContentを取得できるようにしましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> 指定したファイルを以下のように更新してください。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/group.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Group</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

  <span class="c1">#association</span>
  <span class="n">has_many</span> <span class="ss">:users</span>
  <span class="n">has_many</span> <span class="ss">:questions</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s2">"updated_at DESC"</span><span class="p">)</span> <span class="p">}</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:feed_contents</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s2">"updated_at DESC"</span><span class="p">)</span> <span class="p">}</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題2：@feed_contentsに対し、ログインしているユーザーのcontentのみを取得しましょう。</h3>

  <h5>作業ファイル：app/controllers/top_controller.rb</h5>
  <h5>ヒント1： アソシエーションを利用し、ログインしているユーザーのfeed_contentを取り出しましょう</h5>
  <h5>ヒント2： mapメソッドを利用し、feed_contentsからcontentのみを取り出してください</h5>
  <h5>ヒント3： includesメソッドを使い、N+1問題を解決しましょう</h5>

<div class="code-frame" data-lang="ruby">
<div class="code-lang"><span class="bold">/app/controllers/top_controller.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">class</span> <span class="nc">TopController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="k">def</span> <span class="nf">index</span>
      <span class="vi">@question</span> <span class="o">=</span> <span class="no">Question</span><span class="o">.</span><span class="n">new</span>
<span class="hll">      <span class="n">feed_contents</span> <span class="o">=</span> <span class="err">現在ログインしているユーザーの</span><span class="n">feed_content</span><span class="err">を複数取得する</span>
</span><span class="hll">      <span class="vi">@feed_contents</span> <span class="o">=</span> <span class="n">feed_contents</span><span class="err">からそれぞれ</span><span class="n">content</span><span class="err">のみ取得する</span>
</span>    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

  <curriculum-question-container class="ng-scope" data-order="2"><button style="" class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button style="" class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
</div>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="560" action="http://master.tech-camp.in/curriculums/150#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-817" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-817" name="check-817" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">app/models/group.rbを編集できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-818" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-818" name="check-818" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">app/controllers/top_controller.rbを編集できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="7" class="ng-scope">コントローラーから渡したインスタンス配列でタイムラインを表示する</h2>

<p class="ng-scope">ここまでの実装で、QuestionとAnswerのインスタンス配列をビューに渡すことができました。<br>
タイムラインのビューはインスタンスの種類によってビューを出し分けたいと思います。</p>

<h3 class="ng-scope">
<i class="icon pen"></i><code>app/views/top/index.html.erb</code>を以下のように更新してください。</h3>

<div class="code-frame ng-scope" data-lang="rhtml">
<div class="code-lang"><span class="bold">app/views/top/index.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"posting_form top_content"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"posting_header"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"posting_image icon_image"</span> <span class="na">style=</span><span class="s">"background-image: url(</span><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">avatar</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="ss">:medium</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">);"</span><span class="nt">&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"posting_user_info user_info"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@question</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:text</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s2">"例：好きな食べ物は？"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"質問する"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

<span class="hll">  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@feed_contents</span> <span class="cp">%&gt;</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<ul class="ng-scope">
<li>21行目</li>
</ul>

<p class="ng-scope">renderメソッドにインスタンス配列を渡した時は、<strong>インスタンスに応じて部分テンプレートを自動で呼び出し分けてくれます。</strong><br>
つまり、Answerのインスタンスだった場合は、<code>app/views/answers/_answer.html.erb</code>を呼び、Questionのインスタンスだった場合は<code>app/views/questions/_question.html.erb</code>を呼び出します。ここまで自動でやってくれるなんて素晴らしいですね！</p>

<p class="ng-scope">回答の部分テンプレートを作成します。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>app/views/answers/_answer.html.erb</code>を作成してください。</h3>

<ul class="filetree ng-scope">
  <li class="t-folder"> app
    <ul>
      <li class="t-folder"> views
        <ul>
          <li class="t-folder"> answers
            <ul>
              <li class="t-file">_answer.html.erb</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>app/views/answers/_answer.html.erb</code>を以下のように更新してください。</h3>

<div class="code-frame ng-scope" data-lang="rhtml">
<div class="code-lang"><span class="bold">app/views/answers/_answer.html.erb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"answer_content top_content"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"answer_header"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"answer_image icon_image"</span> <span class="na">style=</span><span class="s">"background-image: url(</span><span class="cp">&lt;%=</span> <span class="n">answer</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">avatar</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="ss">:medium</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">);"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"answer_user_info user_info"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">answer</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;time&gt;</span><span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span> <span class="n">answer</span><span class="o">.</span><span class="n">updated_at</span> <span class="cp">%&gt;</span><span class="nt">&lt;/time&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/header&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"answer_body"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"answerd"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">answer</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>の質問「<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">answer</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">question_path</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">question</span><span class="p">)</span> <span class="cp">%&gt;</span>」に回答しました。
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"answer_box"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"a"</span><span class="nt">&gt;</span>A<span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"answer_text"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">answer</span><span class="o">.</span><span class="n">text</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;small</span> <span class="na">class=</span><span class="s">"edit"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'編集'</span><span class="p">,</span> <span class="n">edit_answer_path</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/small&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">answers</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"answer_other"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"他</span><span class="si">#{</span><span class="n">answer</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">answers</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2">件の回答を見る"</span><span class="p">,</span> <span class="n">question_path</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">question</span><span class="p">)</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">・16行目〜20行目</h3>

<p class="ng-scope">マイページでも実装した回答編集機能を、トップページでも実現しています。<br>
所定の回答が持つuser_idが、現在ログインしているユーザーのidと一致する回答にのみ編集リンクを表示しています。</p>

<p class="ng-scope">以上でタイムラインに回答を表示するための実装は終了です。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>rails s</code>でサーバーを起動してタイムラインに回答が表示されることを確認してください。</h3>

<p class="ng-scope"><i class="icon attention"></i> feed_contents, answers, questionsテーブルは一度空にして、質問と回答は新たに投稿してください。</p>

<p class="ng-scope"><img src="profy-timeline.png" alt="text"></p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="561" action="http://master.tech-camp.in/curriculums/150#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-819" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-819" name="check-819" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">app/views/top/index.html.erbを編集できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-820" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-820" name="check-820" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">app/views/answers/_answer.html.erbを作成し、編集してください</span></label><!-- end ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-821" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-821" name="check-821" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">サーバーを起動してタイムラインに回答が表示されることを確認できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 id="8" class="ng-scope">編集した回答もタイムラインで上に来るようにする</h2>

<p class="ng-scope">現在タイムラインは、次のような流れで質問や回答が生成された順に並んでいます。</p>

<ol class="ng-scope">
<li><p>質問または回答が生成されたタイミングで各モデルに記載したafter_createコールバックが働く</p></li>
<li><p>働いたコールバックによりfeed_contentsテーブルにも質問または回答の情報が追加される</p></li>
<li><p>feed_contentsモデルから更新日降順で取得されたデータがトップページに渡される</p></li>
<li><p>各要素がQuestionモデルかAnswerモデルのどちらに紐づくのかが判別され、対応した部分テンプレートが呼び出されタイムラインに表示される</p></li>
</ol>

<p class="ng-scope">つまり、現在は質問や回答が<strong>最初に作成された</strong>順番で並んでしまい、回答に編集を加えてもタイムラインのいちばん上に出てこない状態です。</p>

<p class="ng-scope"><img src="deffer_timeline_order.png" alt="タイムラインの並び順を更新"></p>

<p class="ng-scope">せっかく編集したのですから、いちばん上に出てきてほしいですよね。タイムラインはfeed_contentsの中身を<strong>更新日降順</strong>で取得し表示しているため、回答を更新したタイミングで、feed_contentsの対応する更新日(updated_at)にも更新がかかるようにしてあげる必要がありそうです。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> <code>app/models/answer.rb</code>を以下のように更新してください。</h3>

<div class="code-frame ng-scope" data-lang="ruby">
<div class="code-lang"><span class="bold">app/models/answer.rb</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Answer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:question</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">has_one</span> <span class="ss">:feed_content</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>

  <span class="c1">## callback</span>
  <span class="n">after_create</span> <span class="ss">:create_feed_content</span>
<span class="hll">  <span class="n">after_update</span> <span class="ss">:update_feed_content</span>
</span>
  <span class="c1">## validation</span>
  <span class="n">validates_presence_of</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:text</span>

  <span class="kp">private</span>
  <span class="k">def</span> <span class="nf">create_feed_content</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">feed_content</span> <span class="o">=</span> <span class="no">FeedContent</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">group_id</span><span class="p">:</span> <span class="n">question</span><span class="o">.</span><span class="n">group_id</span><span class="p">,</span> <span class="ss">updated_at</span><span class="p">:</span> <span class="n">updated_at</span><span class="p">)</span>
  <span class="k">end</span>

<span class="hll">  <span class="k">def</span> <span class="nf">update_feed_content</span>
</span><span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">feed_content</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">updated_at</span><span class="p">:</span> <span class="n">updated_at</span><span class="p">)</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">・8行目</h3>

<p class="ng-scope">タイムラインを作成した際に設定したのと同様に<code>after_update</code>と、回答に更新が加えられたタイミングでもコールバックを設定しています。</p>

<h3 class="ng-scope">・19行目</h3>

<p class="ng-scope">ここでの<code>updated_at</code>は「self.updated_at」を省略した形で、コールバックが働いた際のレシーバーである回答の更新日時を表します。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> トップページで実際に回答を編集してみましょう。</h3>

<p class="ng-scope"><img src="fix_timeline_order.png" alt="修正後のタイムライン"></p>

<p class="ng-scope">編集した回答がきちんといちばん上に表示されたでしょうか。これで目標とするタイムラインをつくることができましたね。</p>

<p class="ng-scope"><form class="ng-pristine ng-valid ng-scope" data-id="1457" action="http://master.tech-camp.in/curriculums/150#">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label class="ng-scope" for="check-2010" ng-repeat="check in checkbox.checks"><input class="ng-pristine ng-untouched ng-valid" id="check-2010" name="check-2010" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox"><span class="ng-binding" ng-bind-html="check.text">コールバックを活用し、回答の編集と同時にタイムラインの順位が変動するように設定できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>
</div>
          <!-- ngIf: curriculum.short_test -->
        </div>
      </div>
      <div class="col-md-3 col-sm-12" id="curriculumSideContainer">
        <curriculum-side-wrap id="sideWrap">
          <ul style="max-height: 295px;" class="list-group toc-tree" id="curriculumContents">
  <li class="list-group-item disabled">
    目次
  </li>
  <!-- ngRepeat: content in contents --><li class="ng-scope" ng-repeat="content in contents">
    <a class="content-link ng-binding current" id="contents1" ng-click="clickContent(content.h1.id)">タイムラインに回答を表示する</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents2" ng-click="clickContent(h2.id)">質問と回答が時系列順で入ったインスタンス配列をつくるには？</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents3" ng-click="clickContent(h2.id)">タイムライン用のモデルを作成する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents4" ng-click="clickContent(h2.id)">モデルにポリモーフィック関連を定義する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents5" ng-click="clickContent(h2.id)">質問、回答の投稿時にFeedContentsも同時に追加する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents6" ng-click="clickContent(h2.id)">ビューにタイムラインのインスタンス配列を渡す</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents7" ng-click="clickContent(h2.id)">コントローラーから渡したインスタンス配列でタイムラインを表示する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li class="ng-scope" ng-repeat="h2 in content.h2 track by $index">
        <a class="content-link ng-binding" id="contents8" ng-click="clickContent(h2.id)">編集した回答もタイムラインで上に来るようにする</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents -->
</ul>
          <div style="" ng-show="check_count > 0" class="progress_box ng-scope">
  <!-- ngIf: showTroubleShooting() --><p class="terms ng-scope" ng-if="showTroubleShooting()">
    エラーが解決できない時：<br><a href="http://master.tech-camp.in/curriculums/25" target="_brank">トラブルシューティング</a>
  </p><!-- end ngIf: showTroubleShooting() -->
  <!-- ngIf: courseId != 9 && courseId != 10 --><p class="terms ng-scope" ng-if="courseId != 9 &amp;&amp; courseId != 10">
    分からない用語がある時：<br><a href="http://master.tech-camp.in/terms" target="_brank">用語一覧集</a>
  </p><!-- end ngIf: courseId != 9 && courseId != 10 -->
  <h4>
    進捗度<i class="ng-binding" id="numerator">0 / 14<span id="denominaotr"></span></i>
  </h4>
  <div class="progress">
    <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" class="pregress-bar progress-bar-info ng-binding" role="progressbar" style="width: 0%;">
      0%
    </div>
  </div>
</div>
          <curriculum-glossary class="ng-hide" ng-show="curriculum.curriculum_type == 2 || curriculum.curriculum_type == 3"></curriculum-glossary>
          <button class="curriculum-report-button" ng-click="show_curriculum_report()">
            <img src="idea.svg" height="20px" width="20px">
            | このカリキュラムへのご要望
          </button>
        </curriculum-side-wrap>
      </div>
    </div>
    <ul style="" class="pager" ng-hide="loading">
  <li class="previous">
    <a style="" class="" ng-click="go_previous()" ng-show="curriculum.previous_id">前のカリキュラム</a>
  </li>
  <li class="next">
    <a style="" class="" ng-class="{ disable: curriculum.short_test.can_see_next_curriculum == false }" ng-click="go_next()" ng-show="curriculum.next_id">次のカリキュラム</a>
  </li>
</ul>
  </div>
</curriculum>
<div style="" class="ng-scope ng-isolate-scope ng-hide" id="loading" ng-show="loading">
  <svg height="44" stroke="#444" viewBox="0 0 44 44" width="44" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" strole-width="2"><circle cx="22" cy="22" r="1"><animate attributeName="r" begin="0s" calcMode="spline" dur="1.8s" keySplines="0.165, 0.84, 0.44, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 20"></animate><animate attributeName="stroke-opacity" begin="0s" calcMode="spline" dur="1.8s" keySplines="0.3, 0.61, 0.355, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 0"></animate></circle><circle cx="22" cy="22" r="1"><animate attributeName="r" begin="-0.9s" calcMode="spline" dur="1.8s" keySplines="0.165, 0.84, 0.44, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 20"></animate><animate attributeName="stroke-opacity" begin="-0.9s" calcMode="spline" dur="1.8s" keySplines="0.3, 0.61, 0.355, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 0"></animate></circle></g></svg>
</div>

<div class="curriculum-image__modal modal ng-scope" id="curriculum-image__modal" role="dialog" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button class="close" data-dismiss="modal" ng-click="close()"><span aria-hidden="true">×</span></button>
      </div>
      <div class="modal-body">
        <div class="curriculum-image__img__body">
          <img class="curriculum-image__img zoom-out" id="curriculum-image__img">
        </div>
      </div>
    </div>
  </div>
</div>


</div><div class="chat-window ng-scope" ng-controller="SupportChatController" ng-init="init('大宅誠人', '/uploads/noimage.png', 1867, 2988, 0, 'accepted_questions', 'machi4271', '2')"><div aria-hidden="true" aria-labelledby="myLargeModalLabel" class="modal fade" id="chats-modal" role="dialog" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="wrapper">
  <header class="chat-header">
    <div class="row">
      <div class="col-md-6 col-xs-12 chat-header-left">
        <h2>
          質問チャット
        </h2>
        <div class="chat-support-state active in-support ng-binding">
          <img src="icn_qsupport.png" width="16">質問受付中
        </div>
      </div>
    </div>
  </header>
  <div class="chat-layout" load-more="load-more">
    <!-- ngRepeat: message in messages -->
  </div>
</div><footer class="chat-footer"><form accept-charset="UTF-8" action="http://master.tech-camp.in/api/chat_messages" class="new_chat_message ng-pristine ng-valid" data-remote="true" enctype="multipart/form-data" id="new_chat_message" method="post" ng_submit="afterSubmitted()"><div style="display: none;"><input name="utf8" value="✓" type="hidden"></div><input id="chat_message_chat_id" name="chat_message[chat_id]" value="2988" type="hidden"><div class="chat-box"><div class="row"><div class="chat-upload col-xs-1"><div class="chat-upload-btn"><img class="chat-upload-icn" src="icn_fileupload.png"><input class="ng-pristine ng-untouched ng-valid" id="chat_message_file" name="chat_message[file]" ng_model="file" onchange="angular.element(this).scope().showSubmitButtonAndHideSkypeButtonAndPreview()" type="file"><div class="chat-uploading-image ng-hide" ng-show="isUploading" ng-style="isUploadingStyle"><div class="image_del ng-hide" ng-click="clearImage()" ng-show="imageDeletable"><img alt="close" src="icon_close_red.svg"></div></div></div></div><div class="chat-textarea col-xs-8"><textarea class="form-control ng-pristine ng-untouched ng-valid" id="chat_message_content" name="chat_message[content]" ng_model="content" placeholder="次のコードの意味がよくわからないので教えていただけないでしょうか？" row="3"></textarea></div><div class="chat-submit col-xs-3"><input style="display: none;" class="submit-btn" id="submit_chat_message" name="commit" value="送信" type="submit"><div class="skype-popup"><a title="" data-original-title="" class="trigger btn btn-default" href="#">Skypeで直接聞く</a><div class="head hide">Skype質問を申請すると<br>担当メンターから着信が届きます。<br>以下の項目をご確認ください。</div><div class="content hide"><p class="ng-binding">あなたのSkypeID:　machi4271<br>質問箇所: <small>※スマートフォン、タブレットでのSkypeはご遠慮ください<br>※通話が始まったらすぐに画面共有をお願いします</small></p><a class="skype-support" href="http://master.tech-camp.in/curriculums/150">Skype質問を申請する</a><div class="close">×</div></div></div></div></div></div></form></footer></div></div></div><div class="chat-dock" ng-click="getMessages(); showModal()">質問サポート<!-- ngIf: unreadSize != 0 --><span class="dock-support-state_text in-support ng-binding"><img class="icn_qsupport" src="icn_qsupport_white.png" width="10">質問受付中</span></div></div></body>
</html>
